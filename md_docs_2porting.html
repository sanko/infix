<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>infix: Porting infix to a New ABI</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript"> DoxygenAwesomeDarkModeToggle.init() </script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript"> DoxygenAwesomeFragmentCopyButton.init() </script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript"> DoxygenAwesomeParagraphLink.init() </script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript"> DoxygenAwesomeInteractiveToc.init() </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">infix
   </div>
   <div id="projectbrief">A JIT-Powered FFI Library for C</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_2porting.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Porting infix to a New ABI</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md192"></a> This guide outlines the steps required to add support for a new CPU architecture or Application Binary Interface (ABI) to the <code>infix</code> FFI library. The library is designed to be highly portable, with a clean separation between platform-agnostic logic and ABI-specific implementations.</p>
<p>We will use <b>RISC-V 64-bit (RV64GC)</b> with the standard <b>LP64D ABI</b> as a practical example throughout this guide.</p>
<h1><a class="anchor" id="autotoc_md193"></a>
Step 0: Research and Preparation</h1>
<p>This is the most critical step. Before writing any code, you must have a solid understanding of the target ABI specification. For RISC-V, this means studying the official calling convention document.</p>
<p>You need to answer these key questions:</p>
<ul>
<li><b>Integer/Pointer Argument Registers:</b> Which registers are used and in what order?<ul>
<li><em>RISC-V Answer:</em> <code>a0</code> through <code>a7</code> (also known as <code>x10</code> through <code>x17</code>).</li>
</ul>
</li>
<li><b>Floating-Point Argument Registers:</b> Which registers are used for <code>float</code> and <code>double</code>?<ul>
<li><em>RISC-V Answer:</em> <code>fa0</code> through <code>fa7</code> (also known as <code>f10</code> through <code>f17</code>).</li>
</ul>
</li>
<li><b>Return Value Registers:</b> Where are integer, pointer, and floating-point values returned?<ul>
<li><em>RISC-V Answer:</em> <code>a0</code> and <code>a1</code> for integers/pointers up to 128 bits. <code>fa0</code> and <code>fa1</code> for floats/doubles.</li>
</ul>
</li>
<li><b>Aggregate Passing Rules (Structs/Unions):</b><ul>
<li>How are small structs passed? Can they be split across multiple registers (GPRs and/or FPRs)?</li>
<li><em>RISC-V Answer:</em> Small aggregates that fit into two registers are passed by value. The content of the struct determines if they go in GPRs (<code>a...</code>) or FPRs (<code>fa...</code>).</li>
<li>When are they passed by reference (a pointer is passed instead)?</li>
<li><em>RISC-V Answer:</em> Aggregates that are too large or have a non-trivial layout are passed by reference.</li>
</ul>
</li>
<li><b>Return by Hidden Pointer:</b> When is a struct returned via a hidden pointer passed by the caller? Which register is used for this pointer?<ul>
<li><em>RISC-V Answer:</em> Large aggregates are returned via a hidden pointer passed in <code>a0</code>.</li>
</ul>
</li>
<li><b>Callee-Saved Registers:</b> Which registers must be preserved by a called function?<ul>
<li><em>RISC-V Answer:</em> The frame pointer (<code>s0</code>/<code>fp</code>), the return address (<code>ra</code>), and the saved registers <code>s1</code> through <code>s11</code>.</li>
</ul>
</li>
<li><b>Stack Layout:</b> What is the required stack alignment? Is there a "red zone" or "shadow space"?<ul>
<li><em>RISC-V Answer:</em> The stack must be 16-byte aligned. There is no red zone.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md194"></a>
Step 1: Platform Detection (&lt;tt&gt;src/common/infix_config.h&lt;/tt&gt;)</h1>
<p>The first code change is to teach the library how to recognize the new platform at compile time. Open <code><a class="el" href="infix__config_8h.html" title="Platform, architecture, and ABI detection macros.">src/common/infix_config.h</a></code>.</p>
<ol type="1">
<li><p class="startli"><b>Add Architecture Macro</b>: Locate the processor architecture detection block and add a new <code>#define INFIX_ARCH_*</code> macro. The standard compiler macro for RISC-V is <code>__riscv</code>, and the bit width is checked with <code>__riscv_xlen</code>.</p>
<p class="startli"><code>c // In <a class="el" href="infix__config_8h.html" title="Platform, architecture, and ABI detection macros.">src/common/infix_config.h</a>, after the other architecture checks... #elif defined(__riscv) &amp;&amp; __riscv_xlen == 64 #define INFIX_ARCH_RISCV64 #else #error "Unsupported architecture." #endif </code></p>
</li>
<li><p class="startli"><b>Add ABI Macro</b>: In the "Target ABI Logic Selection" section, define a new <code>INFIX_ABI_*</code> macro based on the combination of OS and architecture.</p>
<p class="startli"><code>c // In <a class="el" href="infix__config_8h.html" title="Platform, architecture, and ABI detection macros.">src/common/infix_config.h</a>, inside the #ifndef INFIX_ABI_FORCED block... #if defined(INFIX_ARCH_AARCH64) // ... #elif defined(INFIX_ARCH_RISCV64) #define INFIX_ABI_LP64D // LP64D is the standard RISC-V ABI #elif defined(INFIX_ARCH_X64) // ... #endif </code></p>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md195"></a>
Step 2: Implement the ABI Specification</h1>
<p>This is the core of the porting effort. You must provide a concrete implementation of the two ABI "specification" v-tables: <code><a class="el" href="structinfix__forward__abi__spec.html" title="Defines the ABI-specific implementation interface for forward trampolines.">infix_forward_abi_spec</a></code> and <code><a class="el" href="structinfix__reverse__abi__spec.html" title="Defines the ABI-specific implementation interface for reverse trampolines.">infix_reverse_abi_spec</a></code>.</p>
<ol type="1">
<li><b>Create New Files</b>: Create a new directory for your architecture, <code>src/arch/riscv64/</code>, and add the necessary files. It's best to copy and adapt from an existing architecture like <code>aarch64</code>.<ul>
<li><code>abi_riscv64.c</code></li>
<li><code>abi_riscv64_common.h</code></li>
<li><code>abi_riscv64_emitters.c</code></li>
<li><code>abi_riscv64_emitters.h</code></li>
</ul>
</li>
<li><p class="startli">**Define Register Enums (<code>abi_riscv64_common.h</code>)**: Create enums for the general-purpose registers (GPRs) and floating-point registers (FPRs). The enum values should correspond to their 5-bit encoding in machine code.</p>
<p class="startli">```c // In src/arch/riscv64/abi_riscv64_common.h typedef enum { ZERO_REG = 0, RA_REG = 1, SP_REG = 2, /* ... */ A0_REG = 10, A1_REG = 11, /* ... */ } riscv_gpr;</p>
<p class="startli">typedef enum { FT0_REG = 0, /* ... */ FA0_REG = 10, FA1_REG = 11, /* ... */ } riscv_fpr; ```</p>
</li>
<li><p class="startli">**Implement ABI Logic (<code>abi_riscv64.c</code>)**: This file will contain the implementations for the ten functions required by the ABI specs. The <code>prepare_forward_call_frame</code> function is the most complex, as it must correctly apply all the ABI rules you researched in Step 0.</p>
<p class="startli">```c // In src/arch/riscv64/abi_riscv64.c #include "common/infix_internals.h" #include "abi_riscv64_common.h" #include "abi_riscv64_emitters.h"</p>
<p class="startli">// Forward Declarations for all 10 required static functions... static infix_status prepare_forward_call_frame_riscv64(...); static infix_status generate_forward_prologue_riscv64(...); // ... etc. for all 10 functions.</p>
<p class="startli">// Define the ABI Specification V-Table Instances const <a class="el" href="structinfix__forward__abi__spec.html" title="Defines the ABI-specific implementation interface for forward trampolines.">infix_forward_abi_spec</a> g_riscv_forward_spec = { .prepare_forward_call_frame = prepare_forward_call_frame_riscv64, .generate_forward_prologue = generate_forward_prologue_riscv64, // ... fill in all 5 function pointers }; const <a class="el" href="structinfix__reverse__abi__spec.html" title="Defines the ABI-specific implementation interface for reverse trampolines.">infix_reverse_abi_spec</a> g_riscv_reverse_spec = { .prepare_reverse_call_frame = prepare_reverse_call_frame_riscv64, // ... fill in all 5 function pointers };</p>
<p class="startli">// Implementation of all 10 functions... static infix_status prepare_forward_call_frame_riscv64(/*...*/) { // Core classification logic: // 1. Allocate the layout struct from the provided arena. // 2. Check for return-by-reference (consumes a0). // 3. Loop through arguments, classifying each one. // 4. Assign arguments to a0-a7, fa0-fa7, or the stack based on classification. // 5. Calculate total stack space needed and return the completed layout. } // ... implement the other 9 functions ... ```</p>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md196"></a>
Step 3: Implement the Instruction Emitters</h1>
<p>In <code>src/arch/riscv64/abi_riscv64_emitters.c</code> and its header, you will write small, focused functions to generate the 32-bit RISC-V machine code instructions. Each function will assemble the bitfields specified in the ISA manual.</p>
<p><b>Example Emitter for <code>LD</code> (Load Doubleword):</b> </p><div class="fragment"><div class="line"><span class="comment">// In src/arch/riscv64/abi_riscv64_emitters.h</span></div>
<div class="line"><span class="keywordtype">void</span> emit_riscv64_ld(<a class="code hl_struct" href="structcode__buffer.html">code_buffer</a>* buf, riscv_gpr rd, riscv_gpr base, int16_t offset);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In src/arch/riscv64/abi_riscv64_emitters.c</span></div>
<div class="line"><span class="keywordtype">void</span> emit_riscv64_ld(<a class="code hl_struct" href="structcode__buffer.html">code_buffer</a>* buf, riscv_gpr rd, riscv_gpr base, int16_t offset) {</div>
<div class="line">    <span class="comment">// I-Type instruction format: | imm[11:0] | rs1 | funct3 | rd | opcode |</span></div>
<div class="line">    uint32_t instruction = 0;</div>
<div class="line">    instruction |= ((uint32_t)offset &amp; 0xFFF) &lt;&lt; 20;  <span class="comment">// 12-bit immediate</span></div>
<div class="line">    instruction |= ((uint32_t)base &amp; 0x1F) &lt;&lt; 15;     <span class="comment">// 5-bit rs1 (base register)</span></div>
<div class="line">    instruction |= (0b011) &lt;&lt; 12;                     <span class="comment">// funct3 for ld</span></div>
<div class="line">    instruction |= ((uint32_t)rd &amp; 0x1F) &lt;&lt; 7;        <span class="comment">// 5-bit rd (destination register)</span></div>
<div class="line">    instruction |= 0b0000011;                         <span class="comment">// opcode for LOAD</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// The emit_int32 helper function appends the final instruction to the code buffer.</span></div>
<div class="line">    <a class="code hl_function" href="infix__internals_8h.html#abd9ba2199b4fe230a75cccf849da3831">emit_int32</a>(buf, instruction);</div>
<div class="line">}</div>
<div class="ttc" id="ainfix__internals_8h_html_abd9ba2199b4fe230a75cccf849da3831"><div class="ttname"><a href="infix__internals_8h.html#abd9ba2199b4fe230a75cccf849da3831">emit_int32</a></div><div class="ttdeci">void emit_int32(code_buffer *buf, int32_t value)</div><div class="ttdoc">A convenience wrapper to append a 32-bit integer (little-endian) to a code buffer.</div><div class="ttdef"><b>Definition</b> trampoline.c:182</div></div>
<div class="ttc" id="astructcode__buffer_html"><div class="ttname"><a href="structcode__buffer.html">code_buffer</a></div><div class="ttdoc">A dynamic buffer for staged machine code generation.</div><div class="ttdef"><b>Definition</b> infix_internals.h:204</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md197"></a>
Step 4: Integrate the New ABI</h1>
<p>The final step is to hook your new implementation into the main trampoline engine.</p>
<ol type="1">
<li><b>Update <code><a class="el" href="infix__internals_8h.html" title="Internal data structures, function prototypes, and constants.">infix_internals.h</a></code></b>: Add an include for your new emitters header inside the architecture-specific block at the bottom of the file. <code>c // In <a class="el" href="infix__internals_8h.html" title="Internal data structures, function prototypes, and constants.">src/common/infix_internals.h</a> #if defined(INFIX_ABI_SYSV_X64) || defined(INFIX_ABI_WINDOWS_X64) #include "arch/x64/abi_x64_emitters.h" #elif defined(INFIX_ABI_AAPCS64) #include "arch/aarch64/abi_arm64_emitters.h" #elif defined(INFIX_ABI_LP64D) #include "arch/riscv64/abi_riscv64_emitters.h" // Add this line #endif </code></li>
<li><p class="startli"><b>Update <code><a class="el" href="trampoline_8c.html" title="The core JIT engine for generating forward and reverse trampolines.">trampoline.c</a></code></b>:</p><ul>
<li>Add an <code>extern</code> declaration for your new spec v-tables inside a new <code>#if defined(INFIX_ABI_LP64D)</code> block.</li>
<li>Add your new ABI to the <code><a class="el" href="infix__internals_8h.html#a1494081d07d1f770d1d6d0b6811df28a" title="Gets the ABI v-table for forward calls for the current platform.">get_current_forward_abi_spec()</a></code> and <code><a class="el" href="infix__internals_8h.html#a8350c168a4d73e304563eec574db526d" title="Gets the ABI v-table for reverse calls for the current platform.">get_current_reverse_abi_spec()</a></code> functions.</li>
<li>Add your new <code>.c</code> files to the unity build section at the very end of the file.</li>
</ul>
<p class="startli">```c // In src/core/trampoline.c</p>
<p class="startli">// ... near the top ... #elif defined(INFIX_ABI_AAPCS64) extern const <a class="el" href="structinfix__forward__abi__spec.html" title="Defines the ABI-specific implementation interface for forward trampolines.">infix_forward_abi_spec</a> g_arm64_forward_spec; extern const <a class="el" href="structinfix__reverse__abi__spec.html" title="Defines the ABI-specific implementation interface for reverse trampolines.">infix_reverse_abi_spec</a> g_arm64_reverse_spec; #elif defined(INFIX_ABI_LP64D) extern const <a class="el" href="structinfix__forward__abi__spec.html" title="Defines the ABI-specific implementation interface for forward trampolines.">infix_forward_abi_spec</a> g_riscv_forward_spec; extern const <a class="el" href="structinfix__reverse__abi__spec.html" title="Defines the ABI-specific implementation interface for reverse trampolines.">infix_reverse_abi_spec</a> g_riscv_reverse_spec; #endif</p>
<p class="startli">// ... in <a class="el" href="infix__internals_8h.html#a1494081d07d1f770d1d6d0b6811df28a" title="Gets the ABI v-table for forward calls for the current platform.">get_current_forward_abi_spec()</a> ... #elif defined(INFIX_ABI_AAPCS64) return &amp;g_arm64_forward_spec; #elif defined(INFIX_ABI_LP64D) return &amp;g_riscv_forward_spec; #else</p>
<p class="startli">// ... (repeat for get_current_reverse_abi_spec) ...</p>
<p class="startli">// ... at the very bottom (unity build section) ... #elif defined(INFIX_ABI_AAPCS64) #include "../arch/aarch64/abi_arm64.c" #include "../arch/aarch64/abi_arm64_emitters.c" #elif defined(INFIX_ABI_LP64D) #include "../arch/riscv64/abi_riscv64.c" #include "../arch/riscv64/abi_riscv64_emitters.c" #else #error "No supported ABI was selected for the unity build in trampoline.c." #endif ```</p>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md198"></a>
Step 5: Testing</h1>
<p>Once the library compiles for your new target, the final and most important step is to run the entire test suite. This is best done on real hardware, but a high-fidelity emulator like QEMU can also be used.</p>
<ul>
<li>Pay special attention to the results of tests <code><a class="el" href="101__by__value_8c.html" title="Unit test for passing and returning aggregates and vectors by value.">101_by_value.c</a></code>, <code><a class="el" href="102__by__reference_8c.html" title="Unit test for passing and returning large aggregates by reference.">102_by_reference.c</a></code>, and <code><a class="el" href="402__variadic__functions_8c.html" title="Unit test for FFI calls to and from variadic C functions.">402_variadic_functions.c</a></code>, as these are the most likely to reveal subtle ABI implementation errors.</li>
<li>Run the memory stress tests under Valgrind (if available on the target) to check for leaks.</li>
<li>If possible, run the fuzzing harnesses on the new target to shake out edge cases. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
