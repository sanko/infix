<!-- HTML header for doxygen 1.10.0-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.10.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>infix: infix FFI: Internals Documentation</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="clipboard.js"></script>
  <script type="text/javascript" src="cookie.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="version_selector_handler.js"></script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">infix
                  <span id="projectnumber"/>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">infix FFI: Internals Documentation</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md75"></a> This document provides a deep dive into the architecture and internal workings of <code>infix</code>. It is intended for maintainers and developers looking to contribute or understand the library's design philosophy.</p>
<h1><a class="anchor" id="autotoc_md76"></a>
Core Design Philosophy</h1>
<p>The architecture of <code>infix</code> is the result of a series of deliberate design choices aimed at balancing performance, security, and developer ergonomics.</p>
<h2><a class="anchor" id="autotoc_md77"></a>
Guiding Principles</h2>
<p>Three high-level principles guide the library's development:</p>
<ol type="1">
<li><b>Security First:</b> An FFI library with a JIT engine is a prime target for security vulnerabilities. We proactively defend against these with a multi-layered approach: strict W^X memory, hardened integer arithmetic against overflows, guard pages for freed code, and read-only callback contexts. All complex components are subjected to continuous fuzz testing.</li>
<li><b>Performance by Design:</b> FFI overhead must be minimal. The API is intentionally designed to separate the expensive, one-time <b>generation cost</b> from the near-zero <b>call-time cost</b>. This encourages users to cache trampolines, making the FFI overhead negligible in high-performance applications.</li>
<li><b>Abstraction and Portability:</b> Platform- and ABI-specific logic is strictly isolated behind a clean internal interface (the "ABI spec" v-tables). This allows the core trampoline engine to remain platform-agnostic, which dramatically simplifies maintenance and makes porting to new architectures a clear, well-defined process.</li>
</ol>
<h2><a class="anchor" id="autotoc_md78"></a>
Key Architectural Decisions</h2>
<h3><a class="anchor" id="autotoc_md79"></a>
The Unity Build</h3>
<p><code>infix</code> is designed to be built as a single translation unit. The top-level <code><a class="el" href="infix_8c.html" title="The unity build source file for the infix library.">src/infix.c</a></code> file simply <code>#include</code>s all other core <code>.c</code> files.</p>
<ul>
<li><b>Rationale</b>:<ol type="1">
<li><b>Simplicity of Integration:</b> <a class="el" href="classA.html">A</a> user can add <code><a class="el" href="infix_8c.html" title="The unity build source file for the infix library.">src/infix.c</a></code> and the <code>include</code> directory to their project, and it will build without complex makefiles.</li>
<li><b>Potential for Optimization:</b> Compiling the entire library as a single unit gives the compiler maximum visibility, enabling more aggressive inlining and interprocedural optimizations.</li>
<li><b>Encapsulation:</b> Because most functions are declared <code>static</code>, we avoid polluting the global namespace of the final object file. The <code><a class="el" href="trampoline_8c.html" title="The core engine for JIT compiling FFI trampolines.">trampoline.c</a></code> file is key, as it includes the ABI-specific <code>.c</code> files directly, ensuring their internal functions remain private.</li>
</ol>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md80"></a>
API Naming: The <code>infix_</code> Prefix</h3>
<ul>
<li><b>The Decision:</b> All public symbols use the <code>infix_</code> or <code>INFIX_</code> prefix.</li>
<li><b>Rationale:</b> This is for <b>safety and responsible ecosystem citizenship</b>. The most popular <a class="el" href="classC.html">C</a> FFI library, <code>libffi</code>, uses the <code>ffi_</code> prefix. By using a distinct prefix, <code>infix</code> guarantees it will never cause name clashes or ODR (One Definition Rule) violations in projects that link against both libraries. This prevents a class of subtle, difficult-to-diagnose crashes.</li>
</ul>
<h3><a class="anchor" id="autotoc_md81"></a>
Memory Safety by Default: The Arena-Based Manual API</h3>
<ul>
<li><b>The Decision:</b> The low-level, "manual" API for creating <code>infix_type</code> objects is <b>exclusively arena-based</b>.</li>
<li><b>Rationale:</b> The old rule—"the library takes ownership on success, the caller owns on failure"—is a notorious source of memory leaks. By forcing the use of an arena, we eliminate this entire class of bugs. The user's responsibility is simplified to a single pattern: create an arena, perform all type creations, and destroy the arena once. This is safer, more consistent, and often faster than repeated calls to <code>malloc</code>.</li>
</ul>
<h3><a class="anchor" id="autotoc_md82"></a>
Callbacks: The Power of the Universal Context</h3>
<ul>
<li><b>The Decision:</b> All user-provided <a class="el" href="classC.html">C</a> callback handlers <b>always</b> receive a pointer to their <code>infix_context_t</code> as their first argument.</li>
<li><b>Rationale:</b> This prioritizes power and API simplicity.<ol type="1">
<li><b>Power by Default:</b> It allows every callback to be stateful, which is essential for adapting to <a class="el" href="classC.html">C</a> libraries that don't provide a <code>void* user_data</code> parameter. <a class="el" href="classA.html">A</a> stateless handler can simply ignore the context.</li>
<li><b>API Safety:</b> <a class="el" href="classA.html">A</a> single, consistent pattern for all callbacks is safer and easier to learn than offering two different modes (<code>callback</code> vs. <code>closure</code>), which would inevitably lead to users providing the wrong kind of handler and causing stack corruption.</li>
<li><b>Industry Precedent:</b> This closure-based model is the standard pattern used by all major FFI libraries.</li>
</ol>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md83"></a>
ABI Dispatch: V-Tables for Cross-Platform Fuzzing</h3>
<ul>
<li><b>The Decision:</b> The core <code><a class="el" href="trampoline_8c.html" title="The core engine for JIT compiling FFI trampolines.">trampoline.c</a></code> engine dispatches to ABI-specific logic via a v-table (a struct of function pointers like <code><a class="el" href="structinfix__forward__abi__spec.html">infix_forward_abi_spec</a></code>).</li>
<li><b>Rationale:</b> While using <code>#ifdef</code> blocks to compile in only one ABI seems simpler, it destroys our ability to easily test all ABIs on a single platform. The v-table design allows us to compile the library on a single Linux machine with the logic for the <b>Windows x64</b>, <b>System V AMD64</b>, and <b>AArch64</b> ABIs all present in the same binary. Our fuzzers can then use the <code>INFIX_FORCE_ABI_*</code> macros to dynamically select which v-table to test. This is an incredibly powerful and efficient way to ensure the entire library is robust across all supported platforms.</li>
</ul>
<h3><a class="anchor" id="autotoc_md84"></a>
The Self-Contained Object Model</h3>
<ul>
<li><b>The Decision:</b> Both <code><a class="el" href="structinfix__forward__t.html">infix_forward_t</a></code> and <code><a class="el" href="structinfix__reverse__t.html">infix_reverse_t</a></code> are designed as <b>self-contained objects</b>. When a trampoline is created, it performs a <b>deep copy</b> of all the <code>infix_type</code> metadata it needs into its own private, internal memory arena.</li>
<li><b>Rationale:</b> This prioritizes memory safety and API simplicity. It completely eliminates a class of use-after-free bugs where the user might destroy the arena used for type creation while a trampoline still points to it. It also enables a safe introspection API, as the type information is guaranteed to be valid for the entire lifetime of the trampoline handle. The trade-off is a slightly higher memory footprint per trampoline, which is acceptable for the vast majority of applications.</li>
</ul>
<h3><a class="anchor" id="autotoc_md85"></a>
Platform Macros: An Internal Affair</h3>
<ul>
<li><b>The Decision:</b> All platform-detection logic has been moved out of the public <code><a class="el" href="infix_8h.html" title="The main public header for the infix FFI library.">infix.h</a></code> and into an internal header, <code><a class="el" href="infix__config_8h.html" title="Internal-only header for platform, architecture, and ABI detection.">src/common/infix_config.h</a></code>.</li>
<li><b>Rationale:</b> The public API is a stable contract. The internal detection macros are an implementation detail that we must be free to change without breaking user code. This prevents tight coupling and keeps the public API surface clean.</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md87"></a>
Architectural Overview</h1>
<p>The library can be broken down into five main layers:</p>
<ol type="1">
<li>**Public API Layer (<code><a class="el" href="infix_8h.html" title="The main public header for the infix FFI library.">infix.h</a></code>, <code><a class="el" href="signature_8c.html" title="Implements the high-level v1.0 signature string parser.">signature.c</a></code>)**: The user-facing interface, providing both a high-level Signature API and a low-level Manual API.</li>
<li>**Type System (<code><a class="el" href="types_8c.html" title="Implements the public API for creating and managing type descriptions.">types.c</a></code>)**: Describes the data types used in function signatures.</li>
<li>**Executable Memory Manager (<code><a class="el" href="executor_8c.html" title="Implements OS-level memory management and the internal callback dispatcher.">executor.c</a></code>)**: Handles the allocation and protection of memory for JIT-compiled code.</li>
<li>**ABI Abstraction Layer (<code><a class="el" href="infix__internals_8h.html" title="Declarations for internal-only functions, types, and constants.">infix_internals.h</a></code>)**: Defines the v-table interfaces (<code><a class="el" href="structinfix__forward__abi__spec.html">infix_forward_abi_spec</a></code>, <code><a class="el" href="structinfix__reverse__abi__spec.html">infix_reverse_abi_spec</a></code>) that connect the generic engine to platform-specific logic.</li>
<li>**Trampoline Generator (<code><a class="el" href="trampoline_8c.html" title="The core engine for JIT compiling FFI trampolines.">trampoline.c</a></code>)**: The core engine that uses the other layers to build the final machine code.</li>
</ol>
<h2><a class="anchor" id="autotoc_md88"></a>
1. API Layers: Signature vs. Manual</h2>
<p><code>infix</code> provides two distinct APIs for creating trampolines.</p>
<h3><a class="anchor" id="autotoc_md89"></a>
The Signature API (<code>infix_forward_create</code>, etc.)</h3>
<p>This is the recommended high-level API. It uses a self-contained mini-language to describe <a class="el" href="classC.html">C</a> types. The parser allocates all <code>infix_type</code> objects from a temporary internal arena, generates the trampoline, and then immediately destroys the arena. The user never has to manage <code>infix_type</code> memory.</p>
<p><b>Signature API Example: Describing a Packed Struct</b> </p><div class="fragment"><div class="line"><span class="comment">// Describe a packed struct with the Signature API:</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;!{id:uint16, name:char, flags:uint32}&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// A trampoline can then be created in one line:</span></div>
<div class="line"><span class="comment">// infix_forward_create(&amp;t, &quot;(*!{...}) -&gt; void&quot;);</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md90"></a>
The Manual API (<code>infix_type_create_*</code>, <code>infix_forward_create_manual</code>)</h3>
<p>This is the foundational, low-level API. It is <b>exclusively Arena-Based</b>. The user is responsible for creating an arena, allocating all types from it, and destroying the arena when finished.</p>
<p><b>Manual API Example: Describing a Struct</b> </p><div class="fragment"><div class="line"><span class="comment">// Describe: struct Point { double x; double y; };</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__arena__t.html">infix_arena_t</a>* arena = infix_arena_create(4096);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structinfix__struct__member__t.html">infix_struct_member</a> members[] = {</div>
<div class="line">    infix_type_create_member(<span class="stringliteral">&quot;x&quot;</span>, infix_type_create_primitive(<a class="code hl_enumvalue" href="group__type__system.html#gga2cd7b00c1f2606249654a8e8b7cbc044a164ca591153f83361c4ea8dd2a5c57f3">INFIX_PRIMITIVE_DOUBLE</a>), offsetof(<a class="code hl_struct" href="structPoint.html">Point</a>, x)),</div>
<div class="line">    infix_type_create_member(<span class="stringliteral">&quot;y&quot;</span>, infix_type_create_primitive(<a class="code hl_enumvalue" href="group__type__system.html#gga2cd7b00c1f2606249654a8e8b7cbc044a164ca591153f83361c4ea8dd2a5c57f3">INFIX_PRIMITIVE_DOUBLE</a>), offsetof(<a class="code hl_struct" href="structPoint.html">Point</a>, y))</div>
<div class="line">};</div>
<div class="line"><a class="code hl_struct" href="structinfix__type__t.html">infix_type</a>* point_type = NULL;</div>
<div class="line">infix_type_create_struct(arena, &amp;point_type, members, 2);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// &#39;point_type&#39; is valid only for the lifetime of the arena.</span></div>
<div class="line">infix_arena_destroy(arena);</div>
<div class="ttc" id="agroup__type__system_html_gga2cd7b00c1f2606249654a8e8b7cbc044a164ca591153f83361c4ea8dd2a5c57f3"><div class="ttname"><a href="group__type__system.html#gga2cd7b00c1f2606249654a8e8b7cbc044a164ca591153f83361c4ea8dd2a5c57f3">INFIX_PRIMITIVE_DOUBLE</a></div><div class="ttdeci">@ INFIX_PRIMITIVE_DOUBLE</div><div class="ttdoc">double</div><div class="ttdef"><b>Definition</b> infix.h:249</div></div>
<div class="ttc" id="astructPoint_html"><div class="ttname"><a href="structPoint.html">Point</a></div><div class="ttdoc">A simple struct with two doubles. Small enough to be passed in registers on some ABIs.</div><div class="ttdef"><b>Definition</b> types.h:13</div></div>
<div class="ttc" id="astructinfix__arena__t_html"><div class="ttname"><a href="structinfix__arena__t.html">infix_arena_t</a></div><div class="ttdef"><b>Definition</b> infix_internals.h:112</div></div>
<div class="ttc" id="astructinfix__struct__member__t_html"><div class="ttname"><a href="structinfix__struct__member__t.html">infix_struct_member_t</a></div><div class="ttdoc">Describes a single member of an aggregate type (struct or union).</div><div class="ttdef"><b>Definition</b> infix.h:317</div></div>
<div class="ttc" id="astructinfix__type__t_html"><div class="ttname"><a href="structinfix__type__t.html">infix_type_t</a></div><div class="ttdoc">The central structure for describing any data type in the FFI system.</div><div class="ttdef"><b>Definition</b> infix.h:261</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md91"></a>
2. The Signature Parser (<code>signature.c</code>)</h2>
<p>This component is a recursive-descent parser that translates the signature string into an <code>infix_type</code> object graph. It is hardened against stack overflow from malicious input (<code>MAX_RECURSION_DEPTH</code>) and uses a sticky error state for clean and fast failure.</p>
<h2><a class="anchor" id="autotoc_md92"></a>
3. Executable Memory Management and Security (<code>executor.c</code>)</h2>
<p>The library implements multiple layers of security to protect against common JIT vulnerabilities.</p>
<h4><a class="anchor" id="autotoc_md93"></a>
Write XOR Execute (W^X)</h4>
<p><a class="el" href="classA.html">A</a> memory region is never simultaneously writable and executable. The implementation strategy varies by platform for maximum security and compatibility:</p>
<div class="fragment"><div class="line">---</div>
<div class="line">config:</div>
<div class="line">  layout: elk</div>
<div class="line">  theme: dark</div>
<div class="line">---</div>
<div class="line">graph</div>
<div class="line">    A[infix_executable_alloc] --&gt; B{OS?};</div>
<div class="line">    B --&gt;|Windows| C[VirtualAlloc with PAGE_READWRITE];</div>
<div class="line">    B --&gt;|macOS / Termux / OpenBSD| D[&quot;mmap with PROT_READ | PROT_WRITE&quot;];</div>
<div class="line">    B --&gt;|Linux / Other BSDs| E[shm_open_anonymous + ftruncate];</div>
<div class="line"> </div>
<div class="line">    C --&gt; F[Write Code];</div>
<div class="line">    D --&gt; F;</div>
<div class="line">    E --&gt; G[mmap RW view] --&gt; F;</div>
<div class="line">    E --&gt; H[mmap RX view];</div>
<div class="line"> </div>
<div class="line">    F --&gt; I[infix_executable_make_executable];</div>
<div class="line">    I --&gt; J{OS?};</div>
<div class="line">    J --&gt;|Windows| K[VirtualProtect to PAGE_EXECUTE_READ];</div>
<div class="line">    J --&gt;|macOS / Termux / OpenBSD| L[&quot;mprotect to PROT_READ | PROT_EXEC&quot;];</div>
<div class="line">    J --&gt;|Linux / Other BSDs| M[No-op: RX view is already executable];</div>
<div class="line"> </div>
<div class="line">    K --&gt; N[Return RX pointer];</div>
<div class="line">    L --&gt; N;</div>
<div class="line">    M --&gt; N;</div>
<div class="line">    H --&gt; N;</div>
<div class="line"> </div>
<div class="line">    subgraph &quot;Linux/BSD Dual-Mapping&quot;</div>
<div class="line">      E; G; H; M;</div>
<div class="line">    end</div>
<div class="line">    subgraph &quot;Windows/macOS/etc. Single-Mapping&quot;</div>
<div class="line">      C; D; K; L;</div>
<div class="line">    end</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md94"></a>
Guard Pages and Read-Only Contexts</h4>
<p>To mitigate use-after-free bugs, <code>infix_executable_free</code> turns freed memory into a non-accessible "guard page." Additionally, after a reverse trampoline's context is created, its memory is made read-only to prevent runtime corruption.</p>
<h2><a class="anchor" id="autotoc_md95"></a>
4. The Trampoline Engine and ABI Dispatch (<code>trampoline.c</code>)</h2>
<p>The core <code><a class="el" href="trampoline_8c.html" title="The core engine for JIT compiling FFI trampolines.">trampoline.c</a></code> is the ABI-agnostic orchestrator. It uses the <code><a class="el" href="structinfix__forward__abi__spec.html">infix_forward_abi_spec</a></code> and <code><a class="el" href="structinfix__reverse__abi__spec.html">infix_reverse_abi_spec</a></code> v-tables to delegate all platform-specific work.</p>
<h3><a class="anchor" id="autotoc_md96"></a>
Forward Call Trampoline Flow</h3>
<div class="fragment"><div class="line">graph TD</div>
<div class="line">    subgraph &quot;Setup Phase (infix_forward_create)&quot;</div>
<div class="line">        A[User calls API with signature] --&gt; B(Parse Signature);</div>
<div class="line">        B --&gt; C{prepare_forward_call_frame};</div>
<div class="line">        C --&gt; D[Generate Prologue];</div>
<div class="line">        D --&gt; E[Generate Argument Moves];</div>
<div class="line">        E --&gt; F[Generate Call Instruction];</div>
<div class="line">        F --&gt; G[Generate Epilogue];</div>
<div class="line">        G --&gt; H[Copy code to executable memory];</div>
<div class="line">        H --&gt; I[Return callable cif_func];</div>
<div class="line">    end</div>
<div class="line"> </div>
<div class="line">    subgraph &quot;Call Phase (cif_func(...))&quot;</div>
<div class="line">        J[User calls cif_func] --&gt; K(Prologue: Set up stack);</div>
<div class="line">        K --&gt; L(Argument Marshalling);</div>
<div class="line">        L --&gt; M(Validate target_func != NULL);</div>
<div class="line">        M --&gt; N[call native_func];</div>
<div class="line">        N --&gt; O(Epilogue: Handle return, restore stack);</div>
<div class="line">        O --&gt; P[Return to User];</div>
<div class="line">    end</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md97"></a>
5. Code Generation and Emitters (<code>*_emitters.c</code>)</h2>
<p>The actual machine code is generated by a set of low-level "emitter" functions, specific to each architecture (e.g., <code><a class="el" href="abi__x64__emitters_8c.html" title="Implements internal helper functions for emitting x86-64 machine code.">abi_x64_emitters.c</a></code>, <code><a class="el" href="abi__arm64__emitters_8c.html" title="Implements internal helper functions for emitting AArch64 machine code.">abi_arm64_emitters.c</a></code>).</p>
<ul>
<li><b>Encapsulation:</b> Emitters completely encapsulate the complexity of machine code encoding (opcodes, ModR/M bytes, etc.). The higher-level ABI logic thinks in terms of abstract operations like "move this register to memory."</li>
<li><b>Clarity:</b> Emitter function names map directly to the assembly instruction they produce (e.g., <code>emit_mov_reg_mem</code> generates <code>mov r64, [mem]</code>).</li>
<li><b>Safety:</b> The emitters operate on a <code><a class="el" href="structcode__buffer.html">code_buffer</a></code> struct, which handles automatic resizing, preventing buffer overflows during JIT compilation.</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md99"></a>
ABI Internals</h1>
<p>This section provides a low-level comparison of the ABIs supported by <code>infix</code>.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Feature   </th><th class="markdownTableHeadNone">System V AMD64 (Linux, macOS)   </th><th class="markdownTableHeadNone">Windows x64   </th><th class="markdownTableHeadNone">AArch64 (ARM64)    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>Integer/Pointer Args</b>   </td><td class="markdownTableBodyNone">6 GPRs: <code>RDI, RSI, RDX, RCX, R8, R9</code>   </td><td class="markdownTableBodyNone">4 GPRs: <code>RCX, RDX, R8, R9</code> (Shared slots)   </td><td class="markdownTableBodyNone">8 GPRs: <code>X0</code> - <code>X7</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>Floating-Point Args</b>   </td><td class="markdownTableBodyNone">8 XMMs: <code>XMM0</code> - <code>XMM7</code> (Separate pool)   </td><td class="markdownTableBodyNone">4 XMMs: <code>XMM0</code> - <code>XMM3</code> (Shared slots)   </td><td class="markdownTableBodyNone">8 VPRs: <code>V0</code> - <code>V7</code> (Separate pool)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>Struct/Union Passing</b>   </td><td class="markdownTableBodyNone"><b>Recursive Classification</b>. Passed in GPRs, XMMs, or both.   </td><td class="markdownTableBodyNone"><b>By Reference</b> if size is not 1, 2, 4, or 8 bytes.   </td><td class="markdownTableBodyNone"><b>By Reference</b> if size &gt; 16 bytes. HFAs passed in VPRs.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>Return by Hidden Pointer</b>   </td><td class="markdownTableBodyNone">If struct &gt; 16 bytes or classified as MEMORY. Pointer in <code>RDI</code>.   </td><td class="markdownTableBodyNone">If struct size is not 1, 2, 4, or 8. Pointer in <code>RCX</code>.   </td><td class="markdownTableBodyNone">If struct &gt; 16 bytes. Pointer in <code>X8</code>.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>Return Value Registers</b>   </td><td class="markdownTableBodyNone"><code>RAX</code> (int), <code>RAX:RDX</code> (int pair), <code>XMM0</code> (float), <code>st(0)</code> (ld)   </td><td class="markdownTableBodyNone"><code>RAX</code> (int/struct), <code>XMM0</code> (float)   </td><td class="markdownTableBodyNone"><code>X0</code> (int), <code>X0:X1</code> (int pair), <code>V0</code> (float/HFA)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>Variadic <code>printf</code> Rule</b>   </td><td class="markdownTableBodyNone"><code>AL</code> must contain the number of XMM registers used.   </td><td class="markdownTableBodyNone">Floating-point variadic args are passed in GPRs <em>and</em> XMMs.   </td><td class="markdownTableBodyNone">Standard: no special rule. Apple: All variadic args on stack.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>Stack Alignment</b>   </td><td class="markdownTableBodyNone">16-byte boundary before <code>call</code>.   </td><td class="markdownTableBodyNone">16-byte boundary before <code>call</code>.   </td><td class="markdownTableBodyNone">16-byte boundary.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>Shadow Space</b>   </td><td class="markdownTableBodyNone">No. Has a 128-byte "red zone" below <code>RSP</code>.   </td><td class="markdownTableBodyNone">Yes, caller allocates 32 bytes on stack for the callee.   </td><td class="markdownTableBodyNone">No.   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md101"></a>
The Debugging Guide</h1>
<p>This guide is for maintainers who need to debug the low-level machine code generated by <code>infix</code>.</p>
<h2><a class="anchor" id="autotoc_md102"></a>
Method 1: Static Analysis with <code>infix_dump_hex</code></h2>
<p>The simplest way to see what the JIT is producing is to enable <code>INFIX_DEBUG_ENABLED</code> in your build and observe the hexdump output from <code>infix_dump_hex</code>, which is called automatically at the end of trampoline creation in debug builds.</p>
<div class="fragment"><div class="line"> # My Forward Trampoline (size: 78 bytes)</div>
<div class="line">#   0x0000: 55 48 89 e5 41 54 41 55  41 56 41 57 49 89 cc 49 | UH..ATAUAVAWI..I</div>
<div class="line">#   0x0010: 89 d5 4d 89 c6 48 81 ec  20 00 00 00 4c 89 e9 4d | ..M..H.. ...L..M</div>
<div class="line">#   ...</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md103"></a>
Method 2: Live Debugging with GDB/LLDB</h2>
<p>This is the most powerful method. It allows you to step through the JIT'd code one instruction at a time.</p>
<ol type="1">
<li><b>Get the Address</b>: Print the address of the executable code right after it's generated. <code>c infix_cif_func cif_func = (infix_cif_func)infix_forward_get_code(trampoline); printf("DEBUG: Trampoline generated at address: %p\n", (void*)cif_func); </code></li>
<li><b>Run Under Debugger</b>: <code>gdb ./my_test_executable</code></li>
<li><b>Set Breakpoint</b>: Use the printed address to set a breakpoint: <code>(gdb) b *0x7ffff7fde000</code></li>
<li><b>Trigger and Disassemble</b>: Run the program. When it breaks, use <code>disassemble</code> to view the JIT code.</li>
<li><b>Step and Verify</b>: Use <code>stepi</code> (step instruction) and <code>info registers</code> to walk through the code and check register values.</li>
</ol>
<hr  />
<h1><a class="anchor" id="autotoc_md105"></a>
External ABI Documentation</h1>
<ul>
<li><b>System V AMD64 ABI:</b> <a href="https://github.com/hjl-tools/x86-psABI/wiki/x86-64-psABI-1.0.pdf">https://github.com/hjl-tools/x86-psABI/wiki/x86-64-psABI-1.0.pdf</a></li>
<li><b>Microsoft Windows x64 ABI:</b> <a href="https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention">https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention</a></li>
<li><b>ARM 64-bit (AArch64) ABI:</b> <a href="https://developer.arm.com/documentation/ihi0055/latest/">https://developer.arm.com/documentation/ihi0055/latest/</a></li>
<li><b>Apple ARM64 Specifics:</b> <a href="https://developer.apple.com/documentation/xcode/writing-arm64-code-for-apple-platforms">https://developer.apple.com/documentation/xcode/writing-arm64-code-for-apple-platforms</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
