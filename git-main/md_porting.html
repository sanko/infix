<!-- HTML header for doxygen 1.10.0-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.10.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>infix: Porting &lt;tt&gt;infix&lt;/tt&gt; to a New Platform</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="clipboard.js"></script>
  <script type="text/javascript" src="cookie.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="version_selector_handler.js"></script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">infix
                  <span id="projectnumber"/>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part --><!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Porting &lt;tt&gt;infix&lt;/tt&gt; to a New Platform</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md106"></a> This guide outlines the steps required to add support for a new CPU architecture or Application Binary Interface (ABI) to the infix FFI library. We will use <b>RISC-V 64-bit (RV64GC)</b> with the standard <b>LP64D ABI</b> as a practical example.</p>
<p>The library is designed to be highly portable, with a clean separation between platform-agnostic logic and ABI-specific implementations.</p>
<h1><a class="anchor" id="autotoc_md107"></a>
Step 0: Research and Preparation</h1>
<p>This is the most critical step. Before writing any code, you must have a solid understanding of the target ABI specification. For RISC-V, this means studying the official calling convention document.</p>
<p>You need to answer these key questions:</p>
<ul>
<li><b>Integer Argument Registers:</b> Which registers are used for integer and pointer arguments?<ul>
<li><em>RISC-V Answer:</em> <code>a0</code> through <code>a7</code> (also known by their ABI names <code>x10</code> through <code>x17</code>).</li>
</ul>
</li>
<li><b>Floating-Point Argument Registers:</b> Which registers are used for <code>float</code> and <code>double</code> arguments?<ul>
<li><em>RISC-V Answer:</em> <code>fa0</code> through <code>fa7</code> (also known as <code>f10</code> through <code>f17</code>).</li>
</ul>
</li>
<li><b>Return Value Registers:</b> Where are integer and floating-point values returned?<ul>
<li><em>RISC-V Answer:</em> <code>a0</code> and <code>a1</code> for integers/pointers up to 128 bits. <code>fa0</code> and <code>fa1</code> for floats/doubles.</li>
</ul>
</li>
<li><b>Aggregate Passing Rules (Structs/Unions):</b><ul>
<li>How are small structs passed? Can they be split across multiple registers?</li>
<li><em>RISC-V Answer:</em> Small aggregates that fit into two registers (GPRs or FPRs depending on content) are passed by value in registers.</li>
<li>When are they passed by reference (a pointer is passed instead)?</li>
<li><em>RISC-V Answer:</em> Aggregates that are too large or have a non-trivial layout are passed by reference.</li>
</ul>
</li>
<li><b>Callee-Saved Registers:</b> Which registers must be preserved by a called function?<ul>
<li><em>RISC-V Answer:</em> The frame pointer (<code>s0</code>/<code>fp</code>), the return address (<code>ra</code>), and the saved registers <code>s1</code> through <code>s11</code>.</li>
</ul>
</li>
<li><b>Stack Alignment:</b> What is the required stack alignment?<ul>
<li><em>RISC-V Answer:</em> The stack must be 16-byte aligned.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md108"></a>
Step 1: Platform Detection (<code>src/common/infix_config.h</code>)</h1>
<p>The first step is to teach the library how to recognize the new platform. Open <code><a class="el" href="infix__config_8h.html" title="Internal-only header for platform, architecture, and ABI detection.">src/common/infix_config.h</a></code> and locate the architecture and ABI detection sections.</p>
<ol type="1">
<li><p class="startli"><b>Add Architecture Macro</b>: Add a new <code>#define INFIX_ARCH_*</code> macro. The standard compiler macro for RISC-V is <code>__riscv</code>, and the bit width is checked with <code>__riscv_xlen</code>.</p>
<p class="startli"><code>c // In <a class="el" href="infix__config_8h.html" title="Internal-only header for platform, architecture, and ABI detection.">src/common/infix_config.h</a>, after the other architecture checks... #elif defined(__riscv) &amp;&amp; __riscv_xlen == 64 #define INFIX_ARCH_RISCV64 #else #error "Unsupported architecture." #endif </code></p>
</li>
<li><p class="startli"><b>Add ABI Macro</b>: In the "Target ABI Logic Selection" section, define a new <code>INFIX_ABI_*</code> macro based on the combination of OS and architecture.</p>
<p class="startli"><code>c // In <a class="el" href="infix__config_8h.html" title="Internal-only header for platform, architecture, and ABI detection.">src/common/infix_config.h</a>, inside the #ifndef INFIX_ABI_FORCED block... #if defined(INFIX_ARCH_AARCH64) // ... #elif defined(INFIX_ARCH_RISCV64) #define INFIX_ABI_LP64D #elif defined(INFIX_ARCH_X64) // ... #endif </code></p>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md109"></a>
Step 2: Implement the ABI Specification</h1>
<p>This is the core of the porting effort. You must provide a concrete implementation of the two ABI "specification" structs: <code><a class="el" href="structinfix__forward__abi__spec.html">infix_forward_abi_spec</a></code> and <code><a class="el" href="structinfix__reverse__abi__spec.html">infix_reverse_abi_spec</a></code>.</p>
<ol type="1">
<li><b>Create New Files</b>: Create a new directory for your architecture, e.g., <code>src/arch/riscv64/</code>, and add the necessary files:<ul>
<li><code>abi_riscv64.c</code></li>
<li><code>abi_riscv64_common.h</code></li>
<li><code>abi_riscv64_emitters.c</code></li>
<li><code>abi_riscv64_emitters.h</code></li>
</ul>
</li>
<li><p class="startli">**Define Register Enums (<code>abi_riscv64_common.h</code>)**: Create enums for the general-purpose registers (GPRs) and floating-point registers (FPRs).</p>
<p class="startli">```c // In src/arch/riscv64/abi_riscv64_common.h typedef enum { ZERO_REG = 0, RA_REG = 1, SP_REG = 2, /* ... */ A0_REG = 10, A1_REG = 11, /* ... */ } riscv_gpr;</p>
<p class="startli">typedef enum { FT0_REG = 0, /* ... */ FA0_REG = 10, FA1_REG = 11, /* ... */ } riscv_fpr; ```</p>
</li>
<li><p class="startli">**Implement ABI Logic (<code>abi_riscv64.c</code>)**: Define your spec v-tables and implement the ten required functions. <code>prepare_forward_call_frame_riscv64</code> is the most critical, as it must correctly apply all the ABI rules you researched in Step 0.</p>
<p class="startli">```c // In src/arch/riscv64/abi_riscv64.c #include "common/infix_internals.h" #include "abi_riscv64_common.h" #include "abi_riscv64_emitters.h"</p>
<p class="startli">// Forward Declarations for all 10 required static functions...</p>
<p class="startli">// ABI Specification V-Table Instances const <a class="el" href="structinfix__forward__abi__spec.html">infix_forward_abi_spec</a> g_riscv_forward_spec = { /* .prepare = ..., etc. */ }; const <a class="el" href="structinfix__reverse__abi__spec.html">infix_reverse_abi_spec</a> g_riscv_reverse_spec = { /* .prepare = ..., etc. */ };</p>
<p class="startli">// Implementation of all 10 functions... static infix_status prepare_forward_call_frame_riscv64(/*...*/) { // Core classification logic: // 1. Allocate the layout struct. // 2. Check for return-by-reference (consumes a0). // 3. Loop through arguments, assigning them to a0-a7, fa0-fa7, or the stack. // 4. Calculate total stack space and return the layout. } // ... ```</p>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md110"></a>
Step 3: Implement the Instruction Emitters</h1>
<p>In <code>src/arch/riscv64/abi_riscv64_emitters.c</code>, you will write functions to generate the 32-bit RISC-V machine code instructions by assembling the bitfields specified in the ISA manual.</p>
<p><b>Example Emitter for <code>LD</code> (Load Doubleword):</b> </p><div class="fragment"><div class="line"><span class="comment">// In src/arch/riscv64/abi_riscv64_emitters.h</span></div>
<div class="line"><span class="keywordtype">void</span> emit_riscv64_ld(<a class="code hl_struct" href="structcode__buffer.html">code_buffer</a>* buf, riscv_gpr rd, riscv_gpr base, int16_t offset);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In src/arch/riscv64/abi_riscv64_emitters.c</span></div>
<div class="line"><span class="keywordtype">void</span> emit_riscv64_ld(<a class="code hl_struct" href="structcode__buffer.html">code_buffer</a>* buf, riscv_gpr rd, riscv_gpr base, int16_t offset) {</div>
<div class="line">    <span class="comment">// I-Type format: | imm[11:0] | rs1 | funct3 | rd | opcode |</span></div>
<div class="line">    uint32_t instruction = 0;</div>
<div class="line">    instruction |= ((uint32_t)offset &amp; 0xFFF) &lt;&lt; 20;</div>
<div class="line">    instruction |= ((uint32_t)base &amp; 0x1F) &lt;&lt; 15;</div>
<div class="line">    instruction |= (0b011) &lt;&lt; 12; <span class="comment">// funct3 for ld</span></div>
<div class="line">    instruction |= ((uint32_t)rd &amp; 0x1F) &lt;&lt; 7;</div>
<div class="line">    instruction |= 0b0000011;     <span class="comment">// opcode for LOAD</span></div>
<div class="line">    emit_int32(buf, instruction);</div>
<div class="line">}</div>
<div class="ttc" id="astructcode__buffer_html"><div class="ttname"><a href="structcode__buffer.html">code_buffer</a></div><div class="ttdef"><b>Definition</b> infix_internals.h:123</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md111"></a>
Step 4: Integrate the New ABI</h1>
<ol type="1">
<li><p class="startli"><b>Update <code><a class="el" href="trampoline_8c.html" title="The core engine for JIT compiling FFI trampolines.">trampoline.c</a></code></b>: This is the final step.</p><ul>
<li>Add an <code>extern</code> declaration for your new spec v-tables inside a new <code>#if defined(INFIX_ABI_LP64D)</code> block.</li>
<li>Add your new ABI to the <code>get_current_forward_abi_spec()</code> and <code>get_current_reverse_abi_spec()</code> functions.</li>
<li>Add your new <code>.c</code> files to the unity build section at the very end of the file.</li>
</ul>
<p class="startli">```c // In <a class="el" href="trampoline_8c.html" title="The core engine for JIT compiling FFI trampolines.">src/core/trampoline.c</a></p>
<p class="startli">// ... near the top ... if defined(INFIX_ABI_LP64D) extern const <a class="el" href="structinfix__forward__abi__spec.html">infix_forward_abi_spec</a> g_riscv_forward_spec; extern const <a class="el" href="structinfix__reverse__abi__spec.html">infix_reverse_abi_spec</a> g_riscv_reverse_spec; #endif</p>
<p class="startli">// ... in get_current_forward_abi_spec() ... #elif defined(INFIX_ABI_LP64D) return &amp;g_riscv_forward_spec;</p>
<p class="startli">// ... at the very bottom (unity build section) ... #elif defined(INFIX_ABI_LP64D) #include "../arch/riscv64/abi_riscv64.c" #include "../arch/riscv64/abi_riscv64_emitters.c" #endif ```</p>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md112"></a>
Step 5: Testing</h1>
<p>Compile and run the entire test suite on your new target platform (either real hardware or an emulator like QEMU). Pay special attention to tests for aggregate passing (<code>struct</code>s and <code>union</code>s) and variadic functions. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
