<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>infix FFI Library: src/arch/aarch64/abi_arm64.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">infix FFI Library<span id="projectnumber">&#160;0.1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_70d5e250c66d001b18da37689179cade.html">arch</a></li><li class="navelem"><a class="el" href="dir_49610b2200846401e1c49e6871f5269a.html">aarch64</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle"><div class="title">abi_arm64.c File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Implements the FFI logic for the AArch64 (ARM64) architecture following the AAPCS64 calling convention, with specific handling for the Apple and Microsoft variants.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;common/infix_internals.h&quot;</code><br />
<code>#include &quot;<a class="el" href="utility_8h_source.html">common/utility.h</a>&quot;</code><br />
<code>#include &lt;<a class="el" href="abi__arm64__common_8h_source.html">abi_arm64_common.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="abi__arm64__emitters_8h_source.html">abi_arm64_emitters.h</a>&gt;</code><br />
<code>#include &lt;stdbool.h&gt;</code><br />
<code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for abi_arm64.c:</div>
<div class="dyncontent">
<div class="center"><img src="abi__arm64_8c__incl.png" border="0" usemap="#asrc_2arch_2aarch64_2abi__arm64_8c" alt=""/></div>
<map name="asrc_2arch_2aarch64_2abi__arm64_8c" id="asrc_2arch_2aarch64_2abi__arm64_8c">
<area shape="rect" title="Implements the FFI logic for the AArch64 (ARM64) architecture following the AAPCS64 calling conventio..." alt="" coords="357,5,510,45"/>
<area shape="rect" href="infix__internals_8h_source.html" title=" " alt="" coords="43,167,229,192"/>
<area shape="poly" title=" " alt="" coords="357,37,275,56,233,73,195,95,168,124,149,155,144,152,163,120,192,91,231,68,273,51,356,32"/>
<area shape="rect" title=" " alt="" coords="249,387,332,412"/>
<area shape="poly" title=" " alt="" coords="357,40,250,60,135,90,85,109,44,130,17,153,10,165,8,178,8,254,14,288,32,316,58,339,90,357,127,371,165,381,236,392,235,397,164,386,125,376,88,362,55,343,28,319,9,290,3,254,3,178,5,164,13,150,41,126,83,104,134,85,249,55,356,35"/>
<area shape="rect" href="utility_8h.html" title="A header for debugging utilities that are conditionally compiled." alt="" coords="408,240,539,265"/>
<area shape="poly" title=" " alt="" coords="439,45,472,226,466,227,434,46"/>
<area shape="rect" href="abi__arm64__common_8h.html" title="Common definitions for the AArch64 (ARM64) architecture." alt="" coords="254,167,421,192"/>
<area shape="poly" title=" " alt="" coords="426,47,385,120,358,157,353,154,380,117,422,44"/>
<area shape="rect" href="abi__arm64__emitters_8h.html" title="Declares the internal helper functions for emitting AArch64 machine code." alt="" coords="205,93,371,119"/>
<area shape="poly" title=" " alt="" coords="400,48,323,89,320,84,397,43"/>
<area shape="rect" title=" " alt="" coords="496,93,563,119"/>
<area shape="poly" title=" " alt="" coords="458,43,506,82,503,87,455,48"/>
<area shape="rect" title=" " alt="" coords="587,93,658,119"/>
<area shape="poly" title=" " alt="" coords="480,43,583,85,581,90,478,48"/>
<area shape="rect" title=" " alt="" coords="682,93,753,119"/>
<area shape="poly" title=" " alt="" coords="502,43,670,89,668,94,501,48"/>
<area shape="rect" href="infix__config_8h.html" title="Internal&#45;only header for platform, architecture, and ABI detection." alt="" coords="43,240,213,265"/>
<area shape="poly" title=" " alt="" coords="137,193,133,227,128,226,132,192"/>
<area shape="rect" href="infix_8h.html" title="The main public header for the infix FFI library." alt="" coords="289,240,383,265"/>
<area shape="poly" title=" " alt="" coords="169,190,291,233,289,238,167,195"/>
<area shape="poly" title=" " alt="" coords="335,267,301,374,296,373,330,265"/>
<area shape="rect" title=" " alt="" coords="429,387,504,412"/>
<area shape="poly" title=" " alt="" coords="340,265,350,300,358,319,370,337,396,361,426,378,423,383,393,365,366,340,354,322,345,301,335,266"/>
<area shape="rect" title=" " alt="" coords="182,313,253,339"/>
<area shape="poly" title=" " alt="" coords="318,268,250,308,247,304,316,263"/>
<area shape="rect" href="compat__c23_8h.html" title="Provides compatibility shims for C23 features in a C17/C11 project." alt="" coords="379,313,554,339"/>
<area shape="poly" title=" " alt="" coords="358,263,435,304,432,309,356,268"/>
<area shape="poly" title=" " alt="" coords="439,341,333,384,331,379,437,336"/>
<area shape="poly" title=" " alt="" coords="469,339,469,373,464,373,464,339"/>
<area shape="poly" title=" " alt="" coords="506,263,533,276,557,294,572,315,573,327,569,340,546,366,517,383,515,379,543,362,564,337,568,327,567,317,553,297,530,281,504,268"/>
<area shape="poly" title=" " alt="" coords="475,266,472,300,466,300,470,265"/>
<area shape="poly" title=" " alt="" coords="326,194,279,242,234,303,230,300,275,238,322,190"/>
<area shape="poly" title=" " alt="" coords="265,121,174,163,172,158,262,116"/>
<area shape="poly" title=" " alt="" coords="298,117,324,154,319,157,294,121"/>
</map>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a8ee6ef7830bf472d90445dea8547b1be" id="r_a8ee6ef7830bf472d90445dea8547b1be"><td class="memItemLeft" align="right" valign="top"><a id="a8ee6ef7830bf472d90445dea8547b1be" name="a8ee6ef7830bf472d90445dea8547b1be"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>NUM_GPR_ARGS</b>&#160;&#160;&#160;8</td></tr>
<tr class="memdesc:a8ee6ef7830bf472d90445dea8547b1be"><td class="mdescLeft">&#160;</td><td class="mdescRight">The total number of GPRs available for argument passing. <br /></td></tr>
<tr class="separator:a8ee6ef7830bf472d90445dea8547b1be"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ace4f0f4995644fd0750aa3f9a89c7c64" id="r_ace4f0f4995644fd0750aa3f9a89c7c64"><td class="memItemLeft" align="right" valign="top"><a id="ace4f0f4995644fd0750aa3f9a89c7c64" name="ace4f0f4995644fd0750aa3f9a89c7c64"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>NUM_VPR_ARGS</b>&#160;&#160;&#160;8</td></tr>
<tr class="memdesc:ace4f0f4995644fd0750aa3f9a89c7c64"><td class="mdescLeft">&#160;</td><td class="mdescRight">The total number of VPRs available for argument passing. <br /></td></tr>
<tr class="separator:ace4f0f4995644fd0750aa3f9a89c7c64"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a08313eff19c7dcf365697a7b15e6e10d" id="r_a08313eff19c7dcf365697a7b15e6e10d"><td class="memItemLeft" align="right" valign="top"><a id="a08313eff19c7dcf365697a7b15e6e10d" name="a08313eff19c7dcf365697a7b15e6e10d"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>MAX_AGGREGATE_FIELDS_TO_CLASSIFY</b>&#160;&#160;&#160;32</td></tr>
<tr class="memdesc:a08313eff19c7dcf365697a7b15e6e10d"><td class="mdescLeft">&#160;</td><td class="mdescRight">A safe limit on the number of fields to classify to prevent DoS from exponential complexity. <br /></td></tr>
<tr class="separator:a08313eff19c7dcf365697a7b15e6e10d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="var-members" name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a7c5e92ab39f189170048020b8057da8c" id="r_a7c5e92ab39f189170048020b8057da8c"><td class="memItemLeft" align="right" valign="top">const <a class="el" href="structinfix__forward__abi__spec.html">infix_forward_abi_spec</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="abi__arm64_8c.html#a7c5e92ab39f189170048020b8057da8c">g_arm64_forward_spec</a></td></tr>
<tr class="memdesc:a7c5e92ab39f189170048020b8057da8c"><td class="mdescLeft">&#160;</td><td class="mdescRight">The v-table of AArch64-specific functions for generating forward trampolines.  <br /></td></tr>
<tr class="separator:a7c5e92ab39f189170048020b8057da8c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7423070977a2434eb61bc352204a4fb2" id="r_a7423070977a2434eb61bc352204a4fb2"><td class="memItemLeft" align="right" valign="top">const <a class="el" href="structinfix__reverse__abi__spec.html">infix_reverse_abi_spec</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="abi__arm64_8c.html#a7423070977a2434eb61bc352204a4fb2">g_arm64_reverse_spec</a></td></tr>
<tr class="memdesc:a7423070977a2434eb61bc352204a4fb2"><td class="mdescLeft">&#160;</td><td class="mdescRight">The v-table of AArch64-specific functions for generating reverse trampolines.  <br /></td></tr>
<tr class="separator:a7423070977a2434eb61bc352204a4fb2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implements the FFI logic for the AArch64 (ARM64) architecture following the AAPCS64 calling convention, with specific handling for the Apple and Microsoft variants. </p>
<p>Copyright (c) 2025 Sanko Robinson</p>
<p>This source code is dual-licensed under the Artistic License 2.0 or the MIT License. You may choose to use this code under the terms of either license.</p>
<p>SPDX-License-Identifier: (Artistic-2.0 OR MIT)</p>
<p>The documentation blocks within this file are licensed under the Creative Commons Attribution 4.0 International License (CC BY 4.0).</p>
<p>SPDX-License-Identifier: CC-BY-4.0</p>
<p>This file provides the concrete implementation of the <code><a class="el" href="structinfix__forward__abi__spec.html">infix_forward_abi_spec</a></code> and <code><a class="el" href="structinfix__reverse__abi__spec.html">infix_reverse_abi_spec</a></code> for the ARM64 architecture. It handles the nuances of the standard Procedure Call Standard for the ARM 64-bit Architecture (AAPCS64), which is used by Linux, Android, and other non-Windows platforms.</p>
<p>A key complexity handled here is the deviation of Apple's ABI for macOS on ARM64, particularly concerning variadic functions, where all variadic arguments are passed on the stack, unlike the standard ABI.</p>
<p>The key responsibilities of this file are:</p>
<ul>
<li><b>Argument Classification:</b> Determining whether function arguments are passed in general-purpose registers (GPRs, X0-X7), floating-point/SIMD registers (VPRs, V0-V7), or on the stack. This includes handling the Apple-specific rules for variadic arguments.</li>
<li><b>Homogeneous Aggregate Handling:</b> Correctly identifying and handling Homogeneous Floating-point Aggregates (HFAs), which are passed in VPRs.</li>
<li><b>Code Generation:</b> Emitting the precise AArch64 machine code for:<ul>
<li>Function prologues (setting up the stack frame).</li>
<li>Argument marshalling (moving arguments from the FFI's generic format into the correct registers and stack locations for a native call).</li>
<li>Function epilogues (handling return values and tearing down the frame).</li>
</ul>
</li>
<li><b>Reverse Trampolines:</b> Generating native, callable function stubs for user-provided callbacks, correctly un-marshalling arguments from the native ABI to the FFI's generic format, again respecting platform differences.</li>
</ul>
<p>The file is organized into two main sections:</p>
<ol type="1">
<li><b>Forward Call Implementation:</b> Contains the logic for generating a "forward" trampoline, a function that takes a generic set of arguments and calls a native C function with the correct, ABI-compliant register and stack layout. This includes handling complex cases like Homogeneous Floating-point Aggregates (HFAs) and large structs returned by value.</li>
<li><b>Reverse Call Implementation (Refactored):</b> Contains the logic for generating a "reverse" trampoline (or callback stub). This is a native C-callable function pointer that, when invoked, marshals its native arguments into a generic format and calls a user-provided C handler. This implementation has been decomposed into five distinct steps for clarity and maintainability. </li>
</ol>
</div><h2 class="groupheader">Variable Documentation</h2>
<a id="a7c5e92ab39f189170048020b8057da8c" name="a7c5e92ab39f189170048020b8057da8c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7c5e92ab39f189170048020b8057da8c">&#9670;&#160;</a></span>g_arm64_forward_spec</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="structinfix__forward__abi__spec.html">infix_forward_abi_spec</a> g_arm64_forward_spec</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Initial value:</b><div class="fragment"><div class="line">= {.prepare_forward_call_frame = prepare_forward_call_frame_arm64,</div>
<div class="line">                                                     .generate_forward_prologue = generate_forward_prologue_arm64,</div>
<div class="line">                                                     .generate_forward_argument_moves =</div>
<div class="line">                                                         generate_forward_argument_moves_arm64,</div>
<div class="line">                                                     .generate_forward_epilogue = generate_forward_epilogue_arm64}</div>
</div><!-- fragment -->
<p>The v-table of AArch64-specific functions for generating forward trampolines. </p>
<p>This structure is passed to the generic trampoline generator in <code><a class="el" href="trampoline_8c.html" title="The core engine for JIT compiling FFI trampolines.">trampoline.c</a></code>, plugging in the platform-specific logic. </p>

</div>
</div>
<a id="a7423070977a2434eb61bc352204a4fb2" name="a7423070977a2434eb61bc352204a4fb2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7423070977a2434eb61bc352204a4fb2">&#9670;&#160;</a></span>g_arm64_reverse_spec</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="structinfix__reverse__abi__spec.html">infix_reverse_abi_spec</a> g_arm64_reverse_spec</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Initial value:</b><div class="fragment"><div class="line">= {</div>
<div class="line">    .prepare_reverse_call_frame = prepare_reverse_call_frame_arm64,</div>
<div class="line">    .generate_reverse_prologue = generate_reverse_prologue_arm64,</div>
<div class="line">    .generate_reverse_argument_marshalling = generate_reverse_argument_marshalling_arm64,</div>
<div class="line">    .generate_reverse_dispatcher_call = generate_reverse_dispatcher_call_arm64,</div>
<div class="line">    .generate_reverse_epilogue = generate_reverse_epilogue_arm64}</div>
</div><!-- fragment -->
<p>The v-table of AArch64-specific functions for generating reverse trampolines. </p>
<p>This structure provides the five-stage implementation for creating a native callback stub on AArch64. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
