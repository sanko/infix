<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>infix: Architectural Notes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript"> DoxygenAwesomeDarkModeToggle.init() </script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript"> DoxygenAwesomeFragmentCopyButton.init() </script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript"> DoxygenAwesomeParagraphLink.init() </script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript"> DoxygenAwesomeInteractiveToc.init() </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">infix
   </div>
   <div id="projectbrief">A JIT-Powered FFI Library for C</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_2internals.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Architectural Notes</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md150"></a> This document provides a deep dive into the architecture and internal workings of <code>infix</code>. It is intended for maintainers, contributors, and advanced users who wish to understand the library's design philosophy, core mechanics, security features, and ABI implementations.</p>
<h1><a class="anchor" id="autotoc_md151"></a>
1. Core Design Philosophy</h1>
<p>The architecture of <code>infix</code> is the result of a series of deliberate design choices aimed at balancing performance, security, and developer ergonomics.</p>
<h2><a class="anchor" id="autotoc_md152"></a>
1.1 Guiding Principles</h2>
<p>Three high-level principles guide the library's development:</p>
<ol type="1">
<li><b>Security First:</b> An FFI library with a JIT engine is a prime target for vulnerabilities. We proactively defend against these with a multi-layered approach: strict W^X memory, hardened integer arithmetic, guard pages for freed code, and read-only callback contexts. All complex components are subjected to continuous fuzz testing.</li>
<li><b>Performance by Design:</b> FFI overhead must be minimal. The API is intentionally designed to separate the expensive, one-time <b>generation cost</b> from the near-zero <b>call-time cost</b>. This encourages users to cache trampolines, making the FFI overhead negligible in high-performance applications.</li>
<li><b>Abstraction and Portability:</b> Platform- and ABI-specific logic is strictly isolated behind a clean internal interface (the "ABI spec" v-tables). This allows the core trampoline engine to remain platform-agnostic, which dramatically simplifies maintenance and makes porting to new architectures a clear, well-defined process.</li>
</ol>
<h2><a class="anchor" id="autotoc_md153"></a>
1.2 Key Architectural Decisions</h2>
<h3><a class="anchor" id="autotoc_md154"></a>
The Unity Build</h3>
<p><code>infix</code> is designed to be built as a single translation unit. The top-level <code><a class="el" href="infix_8c.html" title="The unity build source file for the infix library.">src/infix.c</a></code> file simply <code>#include</code>s all other core <code>.c</code> files.</p><ul>
<li><b>Rationale</b>:<ol type="1">
<li><b>Simplicity of Integration:</b> A user can add <code><a class="el" href="infix_8c.html" title="The unity build source file for the infix library.">src/infix.c</a></code> and the <code>include</code> directory to their project, and it will build without complex makefiles.</li>
<li><b>Potential for Optimization:</b> Compiling the entire library as a single unit gives the compiler maximum visibility, enabling more aggressive inlining and interprocedural optimizations.</li>
<li><b>Encapsulation:</b> Because most functions are declared <code>static</code>, we avoid polluting the global namespace. The <code><a class="el" href="trampoline_8c.html" title="The core engine for JIT compiling FFI trampolines.">trampoline.c</a></code> file is key, as it includes the ABI-specific <code>.c</code> files directly, ensuring their internal functions remain private.</li>
</ol>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md155"></a>
The Self-Contained Object Model</h3>
<p>Both <code><a class="el" href="structinfix__forward__t.html">infix_forward_t</a></code> and <code><a class="el" href="structinfix__reverse__t.html">infix_reverse_t</a></code> are designed as <b>self-contained objects</b>. When a trampoline is created, it performs a <b>deep copy</b> of all the <code>infix_type</code> metadata it needs into its own private, internal memory arena.</p><ul>
<li><b>Rationale:</b> This prioritizes memory safety and API simplicity. It completely eliminates a class of use-after-free bugs where a user might destroy an arena used for type creation while a trampoline still points to it. It also enables a safe introspection API, as the type information is guaranteed to be valid for the entire lifetime of the trampoline handle.</li>
</ul>
<h3><a class="anchor" id="autotoc_md156"></a>
Arena-Based Manual API</h3>
<p>The low-level, "manual" API for creating <code>infix_type</code> objects is <b>exclusively arena-based</b>.</p><ul>
<li><b>Rationale:</b> The old rule—"the library takes ownership on success, the caller owns on failure"—is a notorious source of memory leaks. By forcing the use of an arena, we eliminate this entire class of bugs. The user's responsibility is simplified to a single pattern: create an arena, perform all type creations, and destroy the arena once.</li>
</ul>
<h3><a class="anchor" id="autotoc_md157"></a>
Universal Context for Callbacks</h3>
<p>All user-provided C callback handlers <b>always</b> receive a pointer to their <code>infix_context_t</code> as their first argument.</p><ul>
<li><b>Rationale:</b> This prioritizes power and API simplicity. It allows every callback to be stateful, which is essential for adapting to C libraries that don't provide a <code>void* user_data</code> parameter. A stateless handler can simply ignore the context. This consistent pattern is safer and easier to learn than offering multiple callback modes.</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md159"></a>
2. Architectural Overview</h1>
<p>The library can be broken down into five main layers:</p>
<ol type="1">
<li>**Public API Layer (<code><a class="el" href="infix_8h.html">infix.h</a></code>, <code><a class="el" href="signature_8c.html" title="Implements the high-level signature string parser.">signature.c</a></code>, <code>registry.c</code>)**: The user-facing interface, providing both a high-level Signature API and a low-level Manual API.</li>
<li>**Type System (<code><a class="el" href="types_8c.html" title="Implements the public API for creating and managing type descriptions.">types.c</a></code>)**: Describes the data types used in function signatures.</li>
<li>**Trampoline Engine (<code><a class="el" href="trampoline_8c.html" title="The core engine for JIT compiling FFI trampolines.">trampoline.c</a></code>)**: The core, ABI-agnostic orchestrator that uses the other layers to build the final machine code.</li>
<li>**ABI Abstraction Layer (<code><a class="el" href="infix__internals_8h.html" title="Declarations for internal-only functions, types, and constants.">infix_internals.h</a></code>, <code>arch/...</code>)**: Defines the v-table interfaces (<code>infix_..._abi_spec</code>) and provides the concrete, platform-specific implementations.</li>
<li>**OS Abstraction Layer (<code><a class="el" href="executor_8c.html" title="Implements OS-level memory management and the internal callback dispatcher.">executor.c</a></code>)**: Handles the allocation and protection of memory for JIT-compiled code.</li>
</ol>
<h2><a class="anchor" id="autotoc_md160"></a>
The Trampoline Generation Pipeline</h2>
<p>The process of creating a trampoline, from signature to executable code, follows a clear pipeline:</p>
<ol type="1">
<li><b>Parsing:</b> <code>infix_forward_create</code> receives a signature string. It calls the signature parser, which builds a temporary graph of <code>infix_type</code> objects in an arena. This graph may contain unresolved <code>@Name</code> placeholders.</li>
<li><b>Resolution:</b> If a registry was provided, the <b>resolver</b> (<code>_infix_resolve_type_graph</code>) walks the temporary type graph, looking up each <code>@Name</code> and replacing the placeholder with a pointer to the fully defined type from the registry.</li>
<li><b>Layout Calculation:</b> The resolved type graph is passed to the Trampoline Engine. The engine selects the correct ABI spec and calls its <code>prepare_*_call_frame</code> function. This is the "brain" of the ABI; it classifies every argument and produces a <code>..._call_frame_layout</code> blueprint.</li>
<li><b>Code Generation:</b> The engine calls the ABI spec's code generation functions (<code>generate_*_prologue</code>, etc.) in sequence. Each function appends platform-specific machine code to a <code><a class="el" href="structcode__buffer.html">code_buffer</a></code>.</li>
<li><b>Memory Finalization:</b> The generated code is copied to a new page of executable memory, which is then made non-writable (enforcing W^X).</li>
<li><b>Handle Creation:</b> A final <code><a class="el" href="structinfix__forward__t.html">infix_forward_t</a></code> handle is allocated, containing its own private arena into which a deep copy of the type graph is made. This makes the handle a safe, self-contained object.</li>
</ol>
<div class="fragment"><div class="line">graph TD</div>
<div class="line">    subgraph &quot;Setup Phase (in infix_forward_create)&quot;</div>
<div class="line">        A[User calls API with Signature String] --&gt; B(Parse Signature &amp; Resolve Names);</div>
<div class="line">        B --&gt; C[Get ABI Spec V-Table];</div>
<div class="line">        C --&gt; D{prepare_forward_call_frame};</div>
<div class="line">        D --&gt; E[Generate Machine Code into Buffer];</div>
<div class="line">        E --&gt; F[Allocate &amp; Finalize Executable Memory];</div>
<div class="line">        F --&gt; G[Deep Copy Types into Handle];</div>
<div class="line">        G --&gt; H[Return Trampoline Handle];</div>
<div class="line">    end</div>
<div class="line"> </div>
<div class="line">    subgraph &quot;Call Phase (user calls trampoline)&quot;</div>
<div class="line">        I[cif_func(...)] --&gt; J(Prologue: Set up stack);</div>
<div class="line">        J --&gt; K(Argument Marshalling);</div>
<div class="line">        K --&gt; L[call native_func];</div>
<div class="line">        L --&gt; M(Epilogue: Handle return, restore stack);</div>
<div class="line">        M --&gt; N[Return to User];</div>
<div class="line">    end</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md162"></a>
3. Security Features Deep Dive</h1>
<h2><a class="anchor" id="autotoc_md163"></a>
3.1 Write XOR Execute (W^X)</h2>
<p>A memory region is never simultaneously writable and executable. The implementation strategy varies by platform for maximum security and compatibility:</p>
<div class="fragment"><div class="line">---</div>
<div class="line">config:</div>
<div class="line">  theme: dark</div>
<div class="line">---</div>
<div class="line">graph TD</div>
<div class="line">    subgraph &quot;Windows/macOS/etc. (Single-Mapping)&quot;</div>
<div class="line">        A[VirtualAlloc / mmap&lt;br&gt;PROT_READ | PROT_WRITE] --&gt; B[Write JIT Code];</div>
<div class="line">        B --&gt; C[VirtualProtect / mprotect&lt;br&gt;PROT_READ | PROT_EXEC];</div>
<div class="line">        C --&gt; D(Return RX Pointer);</div>
<div class="line">    end</div>
<div class="line">    subgraph &quot;Linux/BSD (Dual-Mapping)&quot;</div>
<div class="line">        E[shm_open_anonymous] --&gt; F[mmap RW view];</div>
<div class="line">        E --&gt; G[mmap RX view];</div>
<div class="line">        F --&gt; H[Write JIT Code];</div>
<div class="line">        G --&gt; I(Return RX Pointer);</div>
<div class="line">        H --&gt; I;</div>
<div class="line">    end</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md164"></a>
3.2 Guard Pages and Read-Only Contexts</h2>
<p>To mitigate use-after-free bugs, <code>infix_executable_free</code> turns freed memory into a non-accessible "guard page," causing an immediate and safe crash on attempted use. Additionally, after a reverse trampoline's context is created, its memory is made read-only to prevent runtime corruption.</p>
<h2><a class="anchor" id="autotoc_md165"></a>
3.3 macOS JIT Hardening and the Entitlement Fallback</h2>
<p>The implementation of W^X on macOS, particularly on Apple Silicon, is unique and requires special handling to balance security with developer convenience.</p>
<h3><a class="anchor" id="autotoc_md166"></a>
The Challenge: Hardened Runtimes on Apple Silicon</h3>
<p>Apple Silicon enforces W^X at the hardware level. For a JIT engine to function correctly within a standard, distributable application (e.g., an official Python interpreter), that application <b>must</b> be built with specific permissions:</p><ol type="1">
<li>The memory must be allocated with the <code>MAP_JIT</code> flag.</li>
<li>The application must be signed with the <code>com.apple.security.cs.allow-jit</code> entitlement.</li>
<li>Permissions must be toggled with the special <code>pthread_jit_write_protect_np()</code> function, as the standard <code>mprotect()</code> will fail.</li>
</ol>
<p>This presents a major usability problem. Forcing every developer who uses <code>infix</code> to learn about and correctly configure linker flags (<code>-framework Security</code>, etc.) and code signing for their local test builds would create an unacceptable barrier to entry.</p>
<h3><a class="anchor" id="autotoc_md167"></a>
The &lt;tt&gt;infix&lt;/tt&gt; Solution: Runtime Detection with Graceful Fallback</h3>
<p><code>infix</code> solves this problem by making a runtime decision. This provides the best of both worlds: security-by-default for real-world applications, and zero-configuration ease-of-use for developers.</p>
<p>Here is the logic, which is executed once per process:</p><ol type="1">
<li><b>Dynamic Linking:</b> On the first JIT allocation, <code>infix</code> attempts to <code>dlopen()</code> the <code>Security.framework</code> and <code>CoreFoundation.framework</code> libraries and find the necessary functions using <code>dlsym()</code>. This avoids any build-time linker dependencies.</li>
<li><b>Entitlement Check:</b> If the framework functions are found, <code>infix</code> checks if the currently running process has the <code>com.apple.security.cs.allow-jit</code> entitlement.</li>
<li><b>Strategy Selection:</b><ul>
<li>If <b>both</b> the frameworks are available <b>and</b> the entitlement is present, a global flag is set to use the <b>modern, secure API path</b> (<code>MAP_JIT</code> and <code>pthread_jit_write_protect_np</code>). This is the path that will be taken by official interpreters like Python or Perl.</li>
<li>If <b>either</b> step fails, the library gracefully falls back to the <b>legacy, insecure path</b> (a standard <code>mmap</code> followed by <code>mprotect</code>). This path works for unhardened developer builds (like our CI tests) because macOS runs them in a more permissive mode.</li>
</ul>
</li>
</ol>
<p>This ensures the library "just works" for developers, while automatically "leveling up" its security when run inside a properly configured application.</p>
<div class="fragment"><div class="line">graph TD</div>
<div class="line">    A[infix_executable_alloc() called on macOS] --&gt; B{Is this the first call?};</div>
<div class="line">    B --&gt;|Yes| C[Runtime Detection];</div>
<div class="line">    B --&gt;|No| G[Use cached strategy];</div>
<div class="line"> </div>
<div class="line">    subgraph Runtime Detection</div>
<div class="line">        C --&gt; D{dlopen frameworks?};</div>
<div class="line">        D --&gt;|Yes| E{has_jit_entitlement?};</div>
<div class="line">        D --&gt;|No| F[Set strategy = LEGACY];</div>
<div class="line">        E --&gt;|Yes| H[Set strategy = SECURE];</div>
<div class="line">        E --&gt;|No| F;</div>
<div class="line">    end</div>
<div class="line"> </div>
<div class="line">    G --&gt; I{Strategy is SECURE?};</div>
<div class="line">    I --&gt;|Yes| J[mmap with MAP_JIT];</div>
<div class="line">    I --&gt;|No| K[mmap without MAP_JIT];</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md168"></a>
3.4 Fuzz Testing</h2>
<p>The entire <code>infix</code> API surface, especially the signature parser and ABI classifiers, is continuously tested using <code>libFuzzer</code> and <code>AFL++</code>. The fuzzing harnesses (<code>fuzz/</code>) are designed to find memory safety violations (ASan), integer overflows (UBSan), and infinite loops (timeouts). All findings are converted into permanent regression tests.</p>
<hr  />
<h1><a class="anchor" id="autotoc_md170"></a>
4. ABI Internals</h1>
<p>This section provides a low-level comparison of the ABIs supported by <code>infix</code>.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Feature   </th><th class="markdownTableHeadNone">System V AMD64 (Linux, macOS)   </th><th class="markdownTableHeadNone">Windows x64   </th><th class="markdownTableHeadNone">AArch64 (ARM64)    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>Integer/Pointer Args</b>   </td><td class="markdownTableBodyNone">6 GPRs: <code>RDI, RSI, RDX, RCX, R8, R9</code>   </td><td class="markdownTableBodyNone">4 GPRs: <code>RCX, RDX, R8, R9</code> (Shared slots)   </td><td class="markdownTableBodyNone">8 GPRs: <code>X0</code> - <code>X7</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>Floating-Point Args</b>   </td><td class="markdownTableBodyNone">8 XMMs: <code>XMM0</code> - <code>XMM7</code> (Separate pool)   </td><td class="markdownTableBodyNone">4 XMMs: <code>XMM0</code> - <code>XMM3</code> (Shared slots)   </td><td class="markdownTableBodyNone">8 VPRs: <code>V0</code> - <code>V7</code> (Separate pool)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>Struct/Union Passing</b>   </td><td class="markdownTableBodyNone"><b>Recursive Classification</b>. Passed in GPRs, XMMs, or both.   </td><td class="markdownTableBodyNone"><b>By Reference</b> if size is not 1, 2, 4, or 8 bytes.   </td><td class="markdownTableBodyNone"><b>By Reference</b> if size &gt; 16 bytes. HFAs passed in VPRs.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>Return by Hidden Pointer</b>   </td><td class="markdownTableBodyNone">If struct &gt; 16 bytes or classified as MEMORY. Pointer in <code>RDI</code>.   </td><td class="markdownTableBodyNone">If struct size is not 1, 2, 4, or 8. Pointer in <code>RCX</code>.   </td><td class="markdownTableBodyNone">If struct &gt; 16 bytes. Pointer in <code>X8</code>.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>Return Value Registers</b>   </td><td class="markdownTableBodyNone"><code>RAX</code> (int), <code>RAX:RDX</code> (int pair), <code>XMM0</code> (float), <code>st(0)</code> (ld)   </td><td class="markdownTableBodyNone"><code>RAX</code> (int/struct), <code>XMM0</code> (float)   </td><td class="markdownTableBodyNone"><code>X0</code> (int), <code>X0:X1</code> (int pair), <code>V0</code> (float/HFA)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>Variadic <code>printf</code> Rule</b>   </td><td class="markdownTableBodyNone"><code>AL</code> must contain the number of XMM registers used.   </td><td class="markdownTableBodyNone">Floating-point variadic args are passed in GPRs <em>and</em> XMMs.   </td><td class="markdownTableBodyNone">Standard: no special rule. Apple: All variadic args on stack.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>Stack Alignment</b>   </td><td class="markdownTableBodyNone">16-byte boundary before <code>call</code>.   </td><td class="markdownTableBodyNone">16-byte boundary before <code>call</code>.   </td><td class="markdownTableBodyNone">16-byte boundary.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>Shadow Space</b>   </td><td class="markdownTableBodyNone">No. Has a 128-byte "red zone" below <code>RSP</code>.   </td><td class="markdownTableBodyNone">Yes, caller allocates 32 bytes on stack for the callee.   </td><td class="markdownTableBodyNone">No.   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md172"></a>
5. Maintainer's Debugging Guide</h1>
<h2><a class="anchor" id="autotoc_md173"></a>
Method 1: Static Analysis with &lt;tt&gt;infix_dump_hex&lt;/tt&gt;</h2>
<p>The simplest way to see what the JIT is producing is to enable <code>INFIX_DEBUG_ENABLED=1</code> in your build. This will trigger a hexdump of the generated machine code after every trampoline creation.</p>
<div class="fragment"><div class="line"># My Forward Trampoline (size: 78 bytes)</div>
<div class="line">#   0x0000: 55 48 89 e5 41 54 41 55  41 56 41 57 49 89 cc 49 | UH..ATAUAVAWI..I</div>
<div class="line">#   0x0010: 89 d5 4d 89 c6 48 81 ec  20 00 00 00 4c 89 e9 4d | ..M..H.. ...L..M</div>
<div class="line">#   ...</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md174"></a>
Method 2: Live Debugging with GDB/LLDB</h2>
<p>This is the most powerful method. It allows you to step through the JIT'd code one instruction at a time.</p>
<ol type="1">
<li><b>Get the Address</b>: In your test code, print the address of the executable pointer right after it's generated. <code>c infix_unbound_cif_func cif_func = infix_forward_get_code(trampoline); printf("DEBUG: Trampoline generated at address: %p\n", (void*)cif_func); </code></li>
<li><b>Run Under Debugger</b>: <code>gdb ./my_test_executable</code></li>
<li><b>Set Breakpoint</b>: Use the printed address to set a breakpoint: <code>(gdb) b *0x7ffff7fde000</code></li>
<li><b>Trigger and Disassemble</b>: Run the program. When it breaks, use <code>disassemble</code> to view the JIT code.</li>
<li><b>Step and Verify</b>: Use <code>stepi</code> (step instruction) and <code>info registers</code> to walk through the code and check register values.</li>
</ol>
<h2><a class="anchor" id="autotoc_md175"></a>
Useful Tools</h2>
<ul>
<li><b>System V AMD64 ABI:</b> <a href="https://github.com/hjl-tools/x86-psABI/wiki/x86-64-psABI-1.0.pdf">https://github.com/hjl-tools/x86-psABI/wiki/x86-64-psABI-1.0.pdf</a></li>
<li><b>Microsoft Windows x64 ABI:</b> <a href="https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention">https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention</a></li>
<li><b>ARM 64-bit (AArch64) ABI:</b> <a href="https://developer.arm.com/documentation/ihi0055/latest/">https://developer.arm.com/documentation/ihi0055/latest/</a></li>
<li><b>Apple ARM64 Specifics:</b> <a href="https://developer.apple.com/documentation/xcode/writing-arm64-code-for-apple-platforms">https://developer.apple.com/documentation/xcode/writing-arm64-code-for-apple-platforms</a></li>
<li><b>Online Assembler/Disassembler</b>: <a href="https://shell-storm.org/online/Online-Assembler-and-Disassembler/">shell-storm.org</a> is an invaluable tool for quickly checking instruction encodings. This isn't documentation but I couldn't have come close to getting infix off the ground without it. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
