<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>infix: The infix FFI Cookbook</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript"> DoxygenAwesomeDarkModeToggle.init() </script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript"> DoxygenAwesomeFragmentCopyButton.init() </script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript"> DoxygenAwesomeParagraphLink.init() </script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript"> DoxygenAwesomeInteractiveToc.init() </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">infix
   </div>
   <div id="projectbrief">A JIT-Powered FFI Library for C</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_2cookbook.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">The infix FFI Cookbook</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md31"></a> This guide provides practical, real-world examples to help you solve common FFI problems and leverage the full power of the <code>infix</code> library. Where the <code><a class="el" href="README_8md.html">README.md</a></code> covers concepts, this cookbook provides the code.</p>
<blockquote class="doxtable">
<p>&zwj;<b>Note:</b> For a complete reference on the string format used in these examples (e.g., <code>"int"</code>, <code>"{double, double}"</code>, <code>"*char"</code>), please see the <b><a class="el" href="md_docs_2signatures.html">Signature Language Reference</a></b>. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md32"></a>
Table of Contents</h1>
<ul>
<li>Chapter 1: The Basics (Forward Calls)<ul>
<li>Recipe: Calling a Simple C Function</li>
<li>Recipe: Passing and Receiving Pointers</li>
<li>Recipe: Working with &quot;Out&quot; Parameters</li>
<li>Recipe: Working with Opaque Pointers (Incomplete Types)</li>
</ul>
</li>
<li>Chapter 2: Handling Complex Data Structures<ul>
<li>Recipe: Small Structs Passed by Value</li>
<li>Recipe: Receiving a Struct from a Function</li>
<li>Recipe: Large Structs Passed by Reference</li>
<li>Recipe: Working with Packed Structs</li>
<li>Recipe: Working with Structs that Contain Bitfields</li>
<li>Recipe: Working with Unions</li>
<li>Recipe: Working with Fixed-Size Arrays</li>
<li>Recipe: Advanced Named Types (Recursive &amp; Forward-Declared)</li>
<li>Recipe: Working with Complex Numbers</li>
<li>Recipe: Working with SIMD Vectors<ul>
<li>x86-64 (SSE, AVX, and AVX-512)</li>
<li>AArch64 (NEON)</li>
<li>AArch64 (Scalable Vector Extension - SVE)</li>
</ul>
</li>
<li>Recipe: Working with Enums</li>
</ul>
</li>
<li>Chapter 3: The Power of Callbacks (Reverse Calls)<ul>
<li>Recipe: Creating a Type-Safe Callback for `qsort`</li>
<li>Recipe: Creating a Stateful Callback</li>
</ul>
</li>
<li>Chapter 4: Advanced Techniques<ul>
<li>Recipe: Calling Variadic Functions like `printf`</li>
<li>Recipe: Receiving and Calling a Function Pointer</li>
<li>Recipe: Calling a Function Pointer from a Struct (V-Table Emulation)</li>
<li>Recipe: Handling `longdouble`</li>
<li>Recipe: Proving Reentrancy with Nested FFI Calls</li>
<li>Recipe: Proving Thread Safety</li>
</ul>
</li>
<li>Chapter 5: Interoperability with Other Languages<ul>
<li>The Universal Principle: The C ABI</li>
<li>Recipe: Interfacing with a C++ Class (Directly)</li>
<li>Recipe: Interfacing with C++ Templates</li>
<li>The Pattern for Other Compiled Languages<ul>
<li>Rust</li>
<li>Zig</li>
<li>Go</li>
<li>Swift</li>
<li>Dlang</li>
<li>Fortran</li>
<li>Assembly</li>
</ul>
</li>
<li>Recipe: Handling Strings and Semantic Types (`wchar_t`, etc.)<ul>
<li>Step 1: Define Semantic Aliases in a Registry</li>
<li>Step 2: Use the Aliases in Your Signature</li>
<li>Step 3: Introspect with Semantic Awareness</li>
</ul>
</li>
<li>Recipe: Calling C++ Virtual Functions (V-Table Emulation)</li>
<li>Recipe: Bridging C++ Callbacks (`std::function`) and Lambdas</li>
</ul>
</li>
<li>Chapter 6: Dynamic Libraries &amp; System Calls<ul>
<li>Recipe: Calling Native System Libraries without Linking</li>
<li>Recipe: Reading and Writing Global Variables<ul>
<li>Example 1: Simple Integer Variable</li>
<li>Example 2: Aggregate (Struct) Variable</li>
</ul>
</li>
<li>Recipe: Handling Library Dependencies</li>
</ul>
</li>
<li>Chapter 7: Introspection for Data Marshalling<ul>
<li>Recipe: Dynamic Struct Marshalling with the Signature Parser</li>
<li>Recipe: Building a Signature String at Runtime</li>
<li>Recipe: Introspecting a Trampoline for a Wrapper</li>
</ul>
</li>
<li>Chapter 8: Performance &amp; Memory Management<ul>
<li>Best Practice: Caching Trampolines</li>
<li>Recipe: Using a Custom Arena for a Group of Types</li>
<li>Recipe: The Full Manual API Lifecycle (Types to Trampoline)</li>
<li>Recipe: Using Custom Memory Allocators</li>
<li>Recipe: Building a Dynamic Call Frame with an Arena<ul>
<li>How It Works &amp; Why It's Better</li>
<li>Advanced Optimization: Arena Resetting for Hot Loops</li>
</ul>
</li>
</ul>
</li>
<li>Chapter 9: Common Pitfalls &amp; Troubleshooting<ul>
<li>Recipe: Advanced Error Reporting for the Parser</li>
<li>Mistake: Passing a Value Instead of a Pointer in `args[]`</li>
<li>Mistake: `infix` Signature Mismatch</li>
<li>Pitfall: Function Pointer Syntax</li>
</ul>
</li>
<li>Chapter 10: A Comparative Look: `infix` vs. `libffi` and `dyncall`<ul>
<li>Scenario 1: Calling a Simple Function<ul>
<li>The `dyncall` Approach</li>
<li>The `libffi` Approach</li>
<li>The `infix` Approach</li>
</ul>
</li>
<li>Scenario 2: Calling a Function with a Struct<ul>
<li>The `dyncall` Approach</li>
<li>The `libffi` Approach</li>
<li>The `infix` Approach</li>
</ul>
</li>
<li>Scenario 3: Creating a Callback<ul>
<li>The `dyncall` Approach</li>
<li>The `libffi` Approach</li>
<li>The `infix` Approach</li>
</ul>
</li>
<li>Analysis and Takeaways</li>
</ul>
</li>
<li>Chapter 11: Building Language Bindings<ul>
<li>The Four Pillars of a Language Binding</li>
<li>Recipe: Porting a Python Binding from `dyncall` to `infix`</li>
</ul>
</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md34"></a>
Chapter 1: The Basics (Forward Calls)</h1>
<h2><a class="anchor" id="autotoc_md35"></a>
Recipe: Calling a Simple C Function</h2>
<p><b>Problem</b>: You want to call a standard C function, like <code>atan2</code> from the math library.</p>
<p><b>Solution</b>: Describe the function's signature, prepare pointers to your arguments, and invoke the function through a generated trampoline. An "unbound" trampoline is ideal when you want to call multiple functions that share the same signature.</p>
<div class="fragment"><div class="line"><span class="comment">// 1. Describe the signature: double atan2(double y, double x);</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(double, double) -&gt; double&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Create an unbound trampoline.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* trampoline = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga524a8ccebd24c9232d30cb2f79aee5a5">infix_forward_create_unbound</a>(&amp;trampoline, signature, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Prepare arguments and invoke the call.</span></div>
<div class="line"><span class="keywordtype">double</span> y = 1.0, x = 1.0;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;y, &amp;x };</div>
<div class="line"><span class="keywordtype">double</span> result;</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga5f3559908e6a7bcc72103c52937d67ad">infix_forward_get_unbound_code</a>(trampoline)((<span class="keywordtype">void</span>*)atan2, &amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="a202__in__structs_8c_html_a0ad795b9f107bb50006cfa54f5671f2e"><div class="ttname"><a href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a></div><div class="ttdeci">void * args[]</div><div class="ttdef"><b>Definition</b> 202_in_structs.c:64</div></div>
<div class="ttc" id="agroup__high__level__api_html_ga524a8ccebd24c9232d30cb2f79aee5a5"><div class="ttname"><a href="group__high__level__api.html#ga524a8ccebd24c9232d30cb2f79aee5a5">infix_forward_create_unbound</a></div><div class="ttdeci">c23_nodiscard infix_status infix_forward_create_unbound(infix_forward_t **, const char *, infix_registry_t *)</div><div class="ttdoc">Creates an &quot;unbound&quot; forward trampoline from a signature string.</div><div class="ttdef"><b>Definition</b> trampoline.c:906</div></div>
<div class="ttc" id="agroup__introspection__api_html_ga5f3559908e6a7bcc72103c52937d67ad"><div class="ttname"><a href="group__introspection__api.html#ga5f3559908e6a7bcc72103c52937d67ad">infix_forward_get_unbound_code</a></div><div class="ttdeci">c23_nodiscard infix_unbound_cif_func infix_forward_get_unbound_code(infix_forward_t *)</div><div class="ttdoc">Gets the callable function pointer from an unbound forward trampoline.</div><div class="ttdef"><b>Definition</b> trampoline.c:282</div></div>
<div class="ttc" id="astructinfix__forward__t_html"><div class="ttname"><a href="structinfix__forward__t.html">infix_forward_t</a></div><div class="ttdoc">Internal definition of a forward trampoline handle.</div><div class="ttdef"><b>Definition</b> infix_internals.h:94</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch01_Rec01_SimpleCall.c"><code>Ch01_Rec01_SimpleCall.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md36"></a>
Recipe: Passing and Receiving Pointers</h2>
<p><b>Problem</b>: You need to call a C function that takes a pointer as an argument and returns a pointer, like <code>strchr</code>.</p>
<p><b>Solution</b>: Use the <code>*</code> prefix for pointer types. The value in the <code>args</code> array for a pointer argument is the address of your pointer variable.</p>
<div class="fragment"><div class="line"><span class="comment">// Signature for: const char* strchr(const char* s, int c);</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(*char, int) -&gt; *char&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* trampoline = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;trampoline, signature, (<span class="keywordtype">void</span>*)strchr, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Prepare arguments. The value for the pointer is the address of the char* variable.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* haystack = <span class="stringliteral">&quot;hello-world&quot;</span>;</div>
<div class="line"><span class="keywordtype">int</span> needle = <span class="charliteral">&#39;-&#39;</span>;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;haystack, &amp;needle };</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* result_ptr = NULL;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(trampoline)(&amp;result_ptr, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="agroup__high__level__api_html_ga5362b6f6976298aebefdb2a487e72e36"><div class="ttname"><a href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a></div><div class="ttdeci">c23_nodiscard infix_status infix_forward_create(infix_forward_t **, const char *, void *, infix_registry_t *)</div><div class="ttdoc">Creates a &quot;bound&quot; forward trampoline from a signature string.</div><div class="ttdef"><b>Definition</b> trampoline.c:824</div></div>
<div class="ttc" id="agroup__introspection__api_html_ga32fc7e60dd474cebc4ac082e49ac9ea8"><div class="ttname"><a href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a></div><div class="ttdeci">c23_nodiscard infix_cif_func infix_forward_get_code(infix_forward_t *)</div><div class="ttdoc">Gets the callable function pointer from a bound forward trampoline.</div><div class="ttdef"><b>Definition</b> trampoline.c:288</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch01_Rec02_Pointers.c"><code>Ch01_Rec02_Pointers.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md37"></a>
Recipe: Working with "Out" Parameters</h2>
<p><b>Problem</b>: You need to call a C function that doesn't use its return value for its primary output. Instead, it takes a pointer to a variable and writes the result into it. This is a very common pattern for functions that need to return multiple values or an error code.</p>
<p><b>Solution</b>: The signature is straightforward. The "out" parameter is simply a pointer type (<code>*&lt;type&gt;</code>). In your calling code, you create a local variable and pass its address in the <code>args</code> array.</p>
<div class="fragment"><div class="line"><span class="comment">// bool get_user_stats(int user_id, int* out_posts, double* out_score);</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(int, *int, *double) -&gt; bool&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch01__Rec03__OutParameters_8c.html#a861f8785846d6514dcccab68dfd2ad06">get_user_stats</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> user_id = 123;</div>
<div class="line"><span class="comment">// These are our &quot;out&quot; variables.</span></div>
<div class="line"><span class="keywordtype">int</span> post_count = 0;</div>
<div class="line"><span class="keywordtype">double</span> score = 0.0;</div>
<div class="line"><span class="keywordtype">bool</span> success;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// For &quot;out&quot; parameters, the args array contains pointers TO the pointer variables.</span></div>
<div class="line"><span class="keywordtype">int</span>* p_post_count = &amp;post_count;</div>
<div class="line"><span class="keywordtype">double</span>* p_score = &amp;score;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;user_id, &amp;p_post_count, &amp;p_score };</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;success, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="line"><span class="comment">// After the call, post_count and score are populated.</span></div>
<div class="ttc" id="aCh01__Rec03__OutParameters_8c_html_a861f8785846d6514dcccab68dfd2ad06"><div class="ttname"><a href="Ch01__Rec03__OutParameters_8c.html#a861f8785846d6514dcccab68dfd2ad06">get_user_stats</a></div><div class="ttdeci">static bool get_user_stats(int user_id, int *out_posts, double *out_score)</div><div class="ttdef"><b>Definition</b> Ch01_Rec03_OutParameters.c:16</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch01_Rec03_OutParameters.c"><code>Ch01_Rec03_OutParameters.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md38"></a>
Recipe: Working with Opaque Pointers (Incomplete Types)</h2>
<p><b>Problem</b>: You need to interact with a C library that uses opaque pointers or handles (e.g., <code>FILE*</code>, <code>sqlite3*</code>) where the internal structure is hidden.</p>
<p><b>Solution</b>: Use the <code>*void</code> signature. This is the canonical representation for any generic handle. Using a registry to create a type alias like <code>@FileHandle = *void;</code> can make your signatures more readable.</p>
<div class="fragment"><div class="line"><span class="comment">// 1. Use a registry to create a readable alias for the opaque handle.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__registry__t.html">infix_registry_t</a>* reg = <a class="code hl_function" href="group__registry__api.html#gac808273483db7a9db2bc275c41b13296">infix_registry_create</a>();</div>
<div class="line"><a class="code hl_function" href="group__registry__api.html#ga4ece2363948c40fe528826bf65dac280">infix_register_types</a>(reg, <span class="stringliteral">&quot;@FileHandle = *void;&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Create trampolines using the alias.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a> *t_fopen, *t_fputs, *t_fclose;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t_fopen, <span class="stringliteral">&quot;(*char, *char) -&gt; @FileHandle&quot;</span>, (<span class="keywordtype">void</span>*)fopen, reg);</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t_fputs, <span class="stringliteral">&quot;(*char, @FileHandle) -&gt; int&quot;</span>, (<span class="keywordtype">void</span>*)fputs, reg);</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t_fclose, <span class="stringliteral">&quot;(@FileHandle) -&gt; int&quot;</span>, (<span class="keywordtype">void</span>*)fclose, reg);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Use the trampolines in sequence.</span></div>
<div class="line"><span class="keywordtype">void</span>* file_handle = NULL; <span class="comment">// This will hold our opaque FILE*</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* filename = <span class="stringliteral">&quot;test.txt&quot;</span>, *mode = <span class="stringliteral">&quot;w&quot;</span>;</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t_fopen)(&amp;file_handle, (<span class="keywordtype">void</span>*[]){ &amp;filename, &amp;mode });</div>
<div class="line"><span class="comment">// ...</span></div>
<div class="ttc" id="agroup__registry__api_html_ga4ece2363948c40fe528826bf65dac280"><div class="ttname"><a href="group__registry__api.html#ga4ece2363948c40fe528826bf65dac280">infix_register_types</a></div><div class="ttdeci">c23_nodiscard infix_status infix_register_types(infix_registry_t *, const char *)</div><div class="ttdoc">Parses a string of type definitions and adds them to a registry.</div><div class="ttdef"><b>Definition</b> type_registry.c:418</div></div>
<div class="ttc" id="agroup__registry__api_html_gac808273483db7a9db2bc275c41b13296"><div class="ttname"><a href="group__registry__api.html#gac808273483db7a9db2bc275c41b13296">infix_registry_create</a></div><div class="ttdeci">c23_nodiscard infix_registry_t * infix_registry_create(void)</div><div class="ttdoc">Creates a new, empty named type registry.</div><div class="ttdef"><b>Definition</b> type_registry.c:156</div></div>
<div class="ttc" id="astructinfix__registry__t_html"><div class="ttname"><a href="structinfix__registry__t.html">infix_registry_t</a></div><div class="ttdoc">Internal definition of a named type registry.</div><div class="ttdef"><b>Definition</b> infix_internals.h:171</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch01_Rec04_OpaquePointers.c"><code>Ch01_Rec04_OpaquePointers.c</code></a>. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md39"></a>
&lt;/blockquote&gt;</h1>
<h1><a class="anchor" id="autotoc_md40"></a>
Chapter 2: Handling Complex Data Structures</h1>
<div class="fragment"><div class="line"><span class="comment">// Common C struct used in this chapter&#39;s examples</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{ <span class="keywordtype">double</span> x, y; } <a class="code hl_struct" href="structPoint.html">Point</a>;</div>
<div class="ttc" id="astructPoint_html"><div class="ttname"><a href="structPoint.html">Point</a></div><div class="ttdoc">A simple struct with two doubles, often used to test pass-by-value on registers.</div><div class="ttdef"><b>Definition</b> types.h:22</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md41"></a>
Recipe: Small Structs Passed by Value</h2>
<p><b>Problem</b>: You need to call a function that takes a small <code>struct</code> that the ABI passes in registers. <b>Solution</b>: Use the struct syntax <code>({...})</code>. <code>infix</code> will automatically determine the correct ABI passing convention for the target platform.</p>
<div class="fragment"><div class="line"><span class="comment">// Point move_point(Point p, double dx);</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;({double, double}, double) -&gt; {double, double}&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* trampoline = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;trampoline, signature, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="006__end__to__end__calls_8c.html#aea24499a6ed5a50c5a6e5634bf9e449a">move_point</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structPoint.html">Point</a> <a class="code hl_variable" href="901__call__overhead_8c.html#a550769bbd4e7537ff90a656f5b0c23b2">start</a> = { 10.0, 20.0 };</div>
<div class="line"><span class="keywordtype">double</span> delta_x = 5.5;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;<a class="code hl_variable" href="901__call__overhead_8c.html#a550769bbd4e7537ff90a656f5b0c23b2">start</a>, &amp;delta_x };</div>
<div class="line"><a class="code hl_struct" href="structPoint.html">Point</a> <a class="code hl_variable" href="901__call__overhead_8c.html#afb358f48b1646c750fb9da6c6585be2b">end</a>;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(trampoline)(&amp;<a class="code hl_variable" href="901__call__overhead_8c.html#afb358f48b1646c750fb9da6c6585be2b">end</a>, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="a006__end__to__end__calls_8c_html_aea24499a6ed5a50c5a6e5634bf9e449a"><div class="ttname"><a href="006__end__to__end__calls_8c.html#aea24499a6ed5a50c5a6e5634bf9e449a">move_point</a></div><div class="ttdeci">Point move_point(Point p, double dx, double dy)</div><div class="ttdoc">A C function to be called via a forward trampoline. Takes and returns a struct.</div><div class="ttdef"><b>Definition</b> 006_end_to_end_calls.c:35</div></div>
<div class="ttc" id="a901__call__overhead_8c_html_a550769bbd4e7537ff90a656f5b0c23b2"><div class="ttname"><a href="901__call__overhead_8c.html#a550769bbd4e7537ff90a656f5b0c23b2">start</a></div><div class="ttdeci">clock_t start</div><div class="ttdef"><b>Definition</b> 901_call_overhead.c:50</div></div>
<div class="ttc" id="a901__call__overhead_8c_html_afb358f48b1646c750fb9da6c6585be2b"><div class="ttname"><a href="901__call__overhead_8c.html#afb358f48b1646c750fb9da6c6585be2b">end</a></div><div class="ttdeci">clock_t end</div><div class="ttdef"><b>Definition</b> 901_call_overhead.c:50</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec01_StructByValue.c"><code>Ch02_Rec01_StructByValue.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md42"></a>
Recipe: Receiving a Struct from a Function</h2>
<p><b>Problem</b>: You need to call a function that <em>returns</em> a struct by value.</p>
<p><b>Solution</b>: <code>infix</code> handles the ABI details, whether the struct is returned in registers or via a hidden pointer passed by the caller.</p>
<div class="fragment"><div class="line"><span class="comment">// Point make_point(double x, double y);</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(double, double) -&gt; {double, double}&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* trampoline = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;trampoline, signature, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch02__Rec02__ReturnStruct_8c.html#a6f8ee920922d87566e04e96fccd55570">make_point</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> x = 100.0, y = 200.0;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;x, &amp;y };</div>
<div class="line"><a class="code hl_struct" href="structPoint.html">Point</a> result;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(trampoline)(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="aCh02__Rec02__ReturnStruct_8c_html_a6f8ee920922d87566e04e96fccd55570"><div class="ttname"><a href="Ch02__Rec02__ReturnStruct_8c.html#a6f8ee920922d87566e04e96fccd55570">make_point</a></div><div class="ttdeci">static Point make_point(double x, double y)</div><div class="ttdef"><b>Definition</b> Ch02_Rec02_ReturnStruct.c:19</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec02_ReturnStruct.c"><code>Ch02_Rec02_ReturnStruct.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md43"></a>
Recipe: Large Structs Passed by Reference</h2>
<p><b>Problem</b>: A function takes a struct that is too large to fit in registers.</p>
<p><b>Solution</b>: The process is identical to the small struct example. <code>infix</code>'s ABI logic will detect that the struct is large and automatically pass it by reference (the standard C ABI rule).</p>
<div class="fragment"><div class="line"><span class="comment">// int get_first_element(LargeStruct s); where LargeStruct is { int data[8]; }</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;({[8:int]}) -&gt; int&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch02__Rec03__LargeStruct_8c.html#a3aa8f275dc0803c13be1dd397d1d3f94">get_first_element</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structLargeStruct.html">LargeStruct</a> my_struct = { {123, -1, -1, -1, -1, -1, -1, -1} };</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;my_struct };</div>
<div class="line"><span class="keywordtype">int</span> result;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="aCh02__Rec03__LargeStruct_8c_html_a3aa8f275dc0803c13be1dd397d1d3f94"><div class="ttname"><a href="Ch02__Rec03__LargeStruct_8c.html#a3aa8f275dc0803c13be1dd397d1d3f94">get_first_element</a></div><div class="ttdeci">static int get_first_element(LargeStruct s)</div><div class="ttdef"><b>Definition</b> Ch02_Rec03_LargeStruct.c:23</div></div>
<div class="ttc" id="astructLargeStruct_html"><div class="ttname"><a href="structLargeStruct.html">LargeStruct</a></div><div class="ttdoc">A struct larger than 16 bytes, guaranteed to be passed by reference on most ABIs.</div><div class="ttdef"><b>Definition</b> types.h:44</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec03_LargeStruct.c"><code>Ch02_Rec03_LargeStruct.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md44"></a>
Recipe: Working with Packed Structs</h2>
<p><b>Problem</b>: You need to call a function that takes a <code>__attribute__((packed))</code> struct.</p>
<p><b>Solution</b>: Use the <code>!{...}</code> syntax for 1-byte alignment, or <code>!N:{...}</code> to specify a maximum alignment of <code>N</code> bytes.</p>
<div class="fragment"><div class="line"><span class="comment">// int process_packed(Packed p); where Packed is #pragma pack(1) { char a; uint64_t b; }</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(!{char, uint64}) -&gt; int&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch02__Rec04__PackedStructs_8c.html#ac8ba32d67749fe08e2e8853e562d656d">process_packed</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structPacked.html">Packed</a> p = {<span class="charliteral">&#39;X&#39;</span>, 0x1122334455667788ULL};</div>
<div class="line"><span class="keywordtype">int</span> result = 0;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = {&amp;p};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="aCh02__Rec04__PackedStructs_8c_html_ac8ba32d67749fe08e2e8853e562d656d"><div class="ttname"><a href="Ch02__Rec04__PackedStructs_8c.html#ac8ba32d67749fe08e2e8853e562d656d">process_packed</a></div><div class="ttdeci">static int process_packed(Packed p)</div><div class="ttdef"><b>Definition</b> Ch02_Rec04_PackedStructs.c:25</div></div>
<div class="ttc" id="astructPacked_html"><div class="ttname"><a href="structPacked.html">Packed</a></div><div class="ttdef"><b>Definition</b> Ch02_Rec04_PackedStructs.c:18</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec04_PackedStructs.c"><code>Ch02_Rec04_PackedStructs.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md45"></a>
Recipe: Working with Structs that Contain Bitfields</h2>
<p><b>Problem</b>: You need to interact with a C struct that uses bitfields. <code>infix</code>'s signature language has no syntax for bitfields because their memory layout is implementation-defined and not portable.</p>
<p><b>Solution</b>: Treat the underlying integer that holds the bitfields as a single member in your signature. Then, use C's bitwise operators in your wrapper code to manually pack and unpack the values before and after the FFI call.</p>
<div class="fragment"><div class="line"><span class="comment">// uint32_t process_bitfields(BitfieldStruct s);</span></div>
<div class="line"><span class="comment">// 1. Describe the struct by its underlying integer storage.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;({uint32}) -&gt; uint32&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch02__Rec05__Bitfields_8c.html#af589405ead096038b53ff6ed44d633df">process_bitfields</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Manually pack the data into a uint32_t.</span></div>
<div class="line">uint32_t packed_data = 0;</div>
<div class="line">packed_data |= (15 &amp; 0xF) &lt;&lt; 0;      <span class="comment">// Field a = 15</span></div>
<div class="line">packed_data |= (1000 &amp; 0xFFF) &lt;&lt; 4;  <span class="comment">// Field b = 1000</span></div>
<div class="line">packed_data |= (30000 &amp; 0xFFFF) &lt;&lt; 16; <span class="comment">// Field c = 30000</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. The FFI call sees a simple struct { uint32_t; }.</span></div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;packed_data };</div>
<div class="line">uint32_t result;</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="aCh02__Rec05__Bitfields_8c_html_af589405ead096038b53ff6ed44d633df"><div class="ttname"><a href="Ch02__Rec05__Bitfields_8c.html#af589405ead096038b53ff6ed44d633df">process_bitfields</a></div><div class="ttdeci">static uint32_t process_bitfields(BitfieldStruct s)</div><div class="ttdef"><b>Definition</b> Ch02_Rec05_Bitfields.c:25</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec05_Bitfields.c"><code>Ch02_Rec05_Bitfields.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md46"></a>
Recipe: Working with Unions</h2>
<p><b>Problem</b>: You need to call a function that passes or returns a <code>union</code>.</p>
<p><b>Solution</b>: Use the <code>&lt;...&gt;</code> syntax to describe the union's members.</p>
<div class="fragment"><div class="line"><span class="comment">// int process_number_as_int(Number n); where Number is union { int i; float f; }</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(&lt;int, float&gt;) -&gt; int&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch02__Rec06__Unions_8c.html#a2e58041b88be758eef9c67e2473577a9">process_number_as_int</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_union" href="unionNumber.html">Number</a> num_val;</div>
<div class="line">num_val.<a class="code hl_variable" href="unionNumber.html#ace96e77a2c99a9d07825ea4cf54cd8d2">i</a> = 21;</div>
<div class="line"><span class="keywordtype">int</span> result = 0;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = {&amp;num_val};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="aCh02__Rec06__Unions_8c_html_a2e58041b88be758eef9c67e2473577a9"><div class="ttname"><a href="Ch02__Rec06__Unions_8c.html#a2e58041b88be758eef9c67e2473577a9">process_number_as_int</a></div><div class="ttdeci">static int process_number_as_int(Number n)</div><div class="ttdef"><b>Definition</b> Ch02_Rec06_Unions.c:20</div></div>
<div class="ttc" id="aunionNumber_html"><div class="ttname"><a href="unionNumber.html">Number</a></div><div class="ttdoc">A simple union to test aggregate classification.</div><div class="ttdef"><b>Definition</b> types.h:38</div></div>
<div class="ttc" id="aunionNumber_html_ace96e77a2c99a9d07825ea4cf54cd8d2"><div class="ttname"><a href="unionNumber.html#ace96e77a2c99a9d07825ea4cf54cd8d2">Number::i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>Definition</b> types.h:39</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec06_Unions.c"><code>Ch02_Rec06_Unions.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md47"></a>
Recipe: Working with Fixed-Size Arrays</h2>
<p><b>Problem</b>: A function takes a fixed-size array, like <code>long long sum(long long arr[4]);</code>.</p>
<p><b>Solution</b>: In C, an array argument "decays" to a pointer to its first element. The signature must reflect this. To describe the array <em>itself</em> (e.g., inside a struct), use the <code>[N:type]</code> syntax.</p>
<div class="fragment"><div class="line"><span class="comment">// int64_t sum_array_elements(const int64_t* arr, size_t count);</span></div>
<div class="line"><span class="comment">// Note: Even if the C prototype was `arr[4]`, it decays to a pointer.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(*sint64, size_t) -&gt; sint64&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch02__Rec07__ArrayDecay_8c.html#a061164ba659979a93a1c6059b8e903cb">sum_array_elements</a>, NULL);</div>
<div class="line"> </div>
<div class="line">int64_t my_array[] = {10, 20, 30, 40};</div>
<div class="line"><span class="keyword">const</span> int64_t* ptr_to_array = my_array;</div>
<div class="line"><span class="keywordtype">size_t</span> count = 4;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = {&amp;ptr_to_array, &amp;count};</div>
<div class="line">int64_t result = 0;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="aCh02__Rec07__ArrayDecay_8c_html_a061164ba659979a93a1c6059b8e903cb"><div class="ttname"><a href="Ch02__Rec07__ArrayDecay_8c.html#a061164ba659979a93a1c6059b8e903cb">sum_array_elements</a></div><div class="ttdeci">static int64_t sum_array_elements(const int64_t *arr, size_t count)</div><div class="ttdef"><b>Definition</b> Ch02_Rec07_ArrayDecay.c:21</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec07_ArrayDecay.c"><code>Ch02_Rec07_ArrayDecay.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md48"></a>
Recipe: Advanced Named Types (Recursive &amp; Forward-Declared)</h2>
<p><b>Problem</b>: You need to describe complex, real-world C data structures, such as a linked list or mutually dependent types.</p>
<p><b>Solution</b>: The <code>infix</code> registry fully supports recursive definitions and forward declarations, allowing you to model these patterns cleanly.</p>
<div class="fragment"><div class="line"><a class="code hl_struct" href="structinfix__registry__t.html">infix_registry_t</a>* <a class="code hl_variable" href="008__registry__introspection_8c.html#aa7e646c2771eaee632371488e9b195fa">registry</a> = <a class="code hl_function" href="group__registry__api.html#gac808273483db7a9db2bc275c41b13296">infix_registry_create</a>();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 1. Define types using forward declarations for mutual recursion.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code hl_variable" href="008__registry__introspection_8c.html#a875b04be0934afe498d8c3fa958c335c">definitions</a> =</div>
<div class="line">    <span class="stringliteral">&quot;@Employee; @Manager;&quot;</span> <span class="comment">// Forward declarations</span></div>
<div class="line">    <span class="stringliteral">&quot;@Manager = { name:*char, reports:[10:*@Employee] };&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;@Employee = { name:*char, manager:*@Manager };&quot;</span></div>
<div class="line">;</div>
<div class="line"><a class="code hl_function" href="group__registry__api.html#ga4ece2363948c40fe528826bf65dac280">infix_register_types</a>(<a class="code hl_variable" href="008__registry__introspection_8c.html#aa7e646c2771eaee632371488e9b195fa">registry</a>, <a class="code hl_variable" href="008__registry__introspection_8c.html#a875b04be0934afe498d8c3fa958c335c">definitions</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Create a trampoline using the named types.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* trampoline = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;trampoline, <span class="stringliteral">&quot;(*@Employee) -&gt; *char&quot;</span>, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch02__Rec08__AdvancedRegistry_8c.html#a2a49b3b4b7b3b8be6e1d1fd522dfbb89">get_manager_name</a>, <a class="code hl_variable" href="008__registry__introspection_8c.html#aa7e646c2771eaee632371488e9b195fa">registry</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Set up the C data and call.</span></div>
<div class="line"><a class="code hl_struct" href="structManager.html">Manager</a> boss = { <span class="stringliteral">&quot;Sanko&quot;</span>, { NULL } };</div>
<div class="line"><a class="code hl_struct" href="structEmployee.html">Employee</a> worker = { <span class="stringliteral">&quot;Robinson&quot;</span>, &amp;boss };</div>
<div class="line"><a class="code hl_struct" href="structEmployee.html">Employee</a>* p_worker = &amp;worker;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* manager_name = NULL;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;p_worker };</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(trampoline)(&amp;manager_name, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="a008__registry__introspection_8c_html_a875b04be0934afe498d8c3fa958c335c"><div class="ttname"><a href="008__registry__introspection_8c.html#a875b04be0934afe498d8c3fa958c335c">definitions</a></div><div class="ttdeci">const char * definitions</div><div class="ttdef"><b>Definition</b> 008_registry_introspection.c:39</div></div>
<div class="ttc" id="a008__registry__introspection_8c_html_aa7e646c2771eaee632371488e9b195fa"><div class="ttname"><a href="008__registry__introspection_8c.html#aa7e646c2771eaee632371488e9b195fa">registry</a></div><div class="ttdeci">infix_registry_t * registry</div><div class="ttdef"><b>Definition</b> 008_registry_introspection.c:35</div></div>
<div class="ttc" id="aCh02__Rec08__AdvancedRegistry_8c_html_a2a49b3b4b7b3b8be6e1d1fd522dfbb89"><div class="ttname"><a href="Ch02__Rec08__AdvancedRegistry_8c.html#a2a49b3b4b7b3b8be6e1d1fd522dfbb89">get_manager_name</a></div><div class="ttdeci">static const char * get_manager_name(Employee *e)</div><div class="ttdef"><b>Definition</b> Ch02_Rec08_AdvancedRegistry.c:26</div></div>
<div class="ttc" id="astructEmployee_html"><div class="ttname"><a href="structEmployee.html">Employee</a></div><div class="ttdef"><b>Definition</b> Ch02_Rec08_AdvancedRegistry.c:20</div></div>
<div class="ttc" id="astructManager_html"><div class="ttname"><a href="structManager.html">Manager</a></div><div class="ttdef"><b>Definition</b> Ch02_Rec08_AdvancedRegistry.c:15</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec08_AdvancedRegistry.c"><code>Ch02_Rec08_AdvancedRegistry.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md49"></a>
Recipe: Working with Complex Numbers</h2>
<p><b>Problem</b>: You need to call a C function that uses <code>_Complex</code> types.</p>
<p><b>Solution</b>: Use the <code>c[&lt;base_type&gt;]</code> constructor in the signature string.</p>
<div class="fragment"><div class="line"><span class="comment">// double complex c_square(double complex z);</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(c[double]) -&gt; c[double]&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch02__Rec09__ComplexNumbers_8c.html#a572d388d34b2030ef2833d790f31b651">c_square</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> complex input = 3.0 + 4.0 * I;</div>
<div class="line"><span class="keywordtype">double</span> complex result;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = {&amp;input};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="aCh02__Rec09__ComplexNumbers_8c_html_a572d388d34b2030ef2833d790f31b651"><div class="ttname"><a href="Ch02__Rec09__ComplexNumbers_8c.html#a572d388d34b2030ef2833d790f31b651">c_square</a></div><div class="ttdeci">static double complex c_square(double complex z)</div><div class="ttdef"><b>Definition</b> Ch02_Rec09_ComplexNumbers.c:21</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec09_ComplexNumbers.c"><code>Ch02_Rec09_ComplexNumbers.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md50"></a>
Recipe: Working with SIMD Vectors</h2>
<p><b>Problem</b>: You need to call a high-performance C function that uses architecture-specific SIMD vector types for parallel data processing.</p>
<p><b>Solution</b>: Use the generic <code>v[&lt;elements&gt;:&lt;type&gt;]</code> syntax or, where available, a convenient keyword alias (like <code>m512d</code>). The <code>infix</code> ABI logic contains the specific rules for each platform to ensure that these vectors are correctly passed in the appropriate SIMD registers (e.g., XMM/YMM/ZMM on x86-64, V/Z registers on AArch64).</p>
<p>This recipe is broken down by architecture, as the C types and intrinsic functions are platform-specific.</p>
<hr  />
<h3><a class="anchor" id="autotoc_md52"></a>
x86-64 (SSE, AVX, and AVX-512)</h3>
<p>This example calls a function that uses AVX-512's 512-bit <code><a class="el" href="struct____m512d.html">__m512d</a></code> type to add two vectors of eight <code>double</code>s each. The same principle applies to 128-bit SSE (<code>__m128d</code>) and 256-bit AVX (<code><a class="el" href="struct____m256d.html">__m256d</a></code>) types by simply adjusting the signature.</p>
<div class="fragment"><div class="line"><span class="comment">// __m512d vector_add_512(__m512d a, __m512d b);</span></div>
<div class="line"><span class="comment">// The signature &quot;m512d&quot; is a convenient alias for &quot;v[8:double]&quot;.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(m512d, m512d) -&gt; m512d&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)vector_add_512, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Prepare arguments using AVX-512 intrinsics.</span></div>
<div class="line"><a class="code hl_struct" href="struct____m512d.html">__m512d</a> a = _mm512_set_pd(8.0, 7.0, 6.0, 5.0, 4.0, 3.0, 2.0, 1.0);</div>
<div class="line"><a class="code hl_struct" href="struct____m512d.html">__m512d</a> b = _mm512_set_pd(34.0, 35.0, 36.0, 37.0, 38.0, 39.0, 40.0, 41.0);</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = {&amp;a, &amp;b};</div>
<div class="line"><a class="code hl_struct" href="struct____m512d.html">__m512d</a> result;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="astruct____m512d_html"><div class="ttname"><a href="struct____m512d.html">__m512d</a></div><div class="ttdef"><b>Definition</b> Ch02_Rec10_SIMD_AVX.c:23</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec10_SIMD_AVX.c"><code>Ch02_Rec10_SIMD_AVX.c</code></a>. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md53"></a>
&lt;/blockquote&gt;</h1>
<h3><a class="anchor" id="autotoc_md54"></a>
AArch64 (NEON)</h3>
<p>This example calls a function that uses ARM NEON's <code>float32x4_t</code> type, which is a 128-bit vector of four <code>float</code>s.</p>
<div class="fragment"><div class="line"><span class="comment">// float neon_horizontal_sum(float32x4_t vec);</span></div>
<div class="line"><span class="comment">// The signature v[4:float] directly maps to float32x4_t.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(v[4:float]) -&gt; float&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)neon_horizontal_sum, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Prepare the NEON vector argument.</span></div>
<div class="line"><span class="keywordtype">float</span> data[] = {10.0f, 20.0f, 5.5f, 6.5f};</div>
<div class="line">float32x4_t input_vec = vld1q_f32(data); <span class="comment">// Load data into a vector register.</span></div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = {&amp;input_vec};</div>
<div class="line"><span class="keywordtype">float</span> result;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec10_SIMD_NEON.c"><code>Ch02_Rec10_SIMD_NEON.c</code></a>. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md55"></a>
&lt;/blockquote&gt;</h1>
<h3><a class="anchor" id="autotoc_md56"></a>
AArch64 (Scalable Vector Extension - SVE)</h3>
<p><b>Problem</b>: SVE vectors do not have a fixed size; their length is determined by the CPU at runtime. How can we create a trampoline for a function that uses them?</p>
<p><b>Solution</b>: This requires a dynamic, multi-step approach. You must first perform a runtime check for SVE support, then query the CPU's vector length, and finally build the <code>infix</code> signature string dynamically before creating the trampoline.</p>
<div class="fragment"><div class="line"><span class="comment">// double sve_horizontal_add(svfloat64_t vec);</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 1. Query the vector length at runtime. svcntd() gets the count of doubles.</span></div>
<div class="line"><span class="keywordtype">size_t</span> num_doubles = svcntd();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Build the signature string dynamically.</span></div>
<div class="line"><span class="keywordtype">char</span> signature[64];</div>
<div class="line">snprintf(signature, <span class="keyword">sizeof</span>(signature), <span class="stringliteral">&quot;(v[%zu:double]) -&gt; double&quot;</span>, num_doubles);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Create the trampoline with the dynamic signature.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)sve_horizontal_add, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 4. Prepare arguments and call.</span></div>
<div class="line"><span class="keywordtype">double</span>* data = (<span class="keywordtype">double</span>*)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * num_doubles);</div>
<div class="line"><span class="comment">// ... populate data ...</span></div>
<div class="line">svfloat64_t input_vec = svld1_f64(svptrue_b64(), data);</div>
<div class="line"><span class="keywordtype">double</span> result;</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result, (<span class="keywordtype">void</span>*[]){&amp;input_vec});</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec10_SIMD_SVE.c"><code>Ch02_Rec10_SIMD_SVE.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md57"></a>
Recipe: Working with Enums</h2>
<p><b>Problem</b>: You need to call a C function that takes an <code>enum</code>, but you want to ensure the underlying integer type is handled correctly for ABI purposes.</p>
<p><b>Solution</b>: Use the <code>e:&lt;type&gt;</code> syntax in the signature string. <code>infix</code> treats the enum identically to its underlying integer type for the FFI call, which is the correct behavior.</p>
<div class="fragment"><div class="line"><span class="comment">// const char* status_to_string(StatusCode code);</span></div>
<div class="line"><span class="comment">// The C `enum` is based on `int`, so we describe it as `e:int`.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(e:int) -&gt; *char&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch02__Rec11__Enums_8c.html#ab751089445f1110bcfd7277ccea6b89e">status_to_string</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Pass the enum value as its underlying integer type.</span></div>
<div class="line"><span class="keywordtype">int</span> code = <a class="code hl_enumvalue" href="Ch02__Rec11__Enums_8c.html#ae98a46f4ea1a43ca48acaf15d2eb7113ae0076ca58256ccca74118e432658284e">STATUS_ERR</a>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* result_str = NULL;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;code };</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result_str, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="aCh02__Rec11__Enums_8c_html_ab751089445f1110bcfd7277ccea6b89e"><div class="ttname"><a href="Ch02__Rec11__Enums_8c.html#ab751089445f1110bcfd7277ccea6b89e">status_to_string</a></div><div class="ttdeci">static const char * status_to_string(StatusCode code)</div><div class="ttdef"><b>Definition</b> Ch02_Rec11_Enums.c:19</div></div>
<div class="ttc" id="aCh02__Rec11__Enums_8c_html_ae98a46f4ea1a43ca48acaf15d2eb7113ae0076ca58256ccca74118e432658284e"><div class="ttname"><a href="Ch02__Rec11__Enums_8c.html#ae98a46f4ea1a43ca48acaf15d2eb7113ae0076ca58256ccca74118e432658284e">STATUS_ERR</a></div><div class="ttdeci">@ STATUS_ERR</div><div class="ttdef"><b>Definition</b> Ch02_Rec11_Enums.c:17</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch02_Rec11_Enums.c"><code>Ch02_Rec11_Enums.c</code></a>. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md58"></a>
&lt;/blockquote&gt;</h1>
<h1><a class="anchor" id="autotoc_md59"></a>
Chapter 3: The Power of Callbacks (Reverse Calls)</h1>
<h2><a class="anchor" id="autotoc_md60"></a>
Recipe: Creating a Type-Safe Callback for &lt;tt&gt;qsort&lt;/tt&gt;</h2>
<p><b>Problem</b>: You need to sort an array using C's <code>qsort</code>, which requires a function pointer for the comparison logic.</p>
<p><b>Solution</b>: Use <code>infix_reverse_create_callback</code>. The handler is a normal, clean C function whose signature exactly matches what <code>qsort</code> expects.</p>
<div class="fragment"><div class="line"><span class="comment">// 1. The handler function has a standard C signature.</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="Ch03__Rec01__QsortCallback_8c.html#a7bf7d14648b43bd286a54ad622d5fc61">compare_integers_handler</a>(<span class="keyword">const</span> <span class="keywordtype">void</span>* a, <span class="keyword">const</span> <span class="keywordtype">void</span>* b) {</div>
<div class="line">    <span class="keywordflow">return</span> (*(<span class="keyword">const</span> <span class="keywordtype">int</span>*)a - *(<span class="keyword">const</span> <span class="keywordtype">int</span>*)b);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Create the reverse trampoline.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* cmp_sig = <span class="stringliteral">&quot;(*void, *void) -&gt; int&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__reverse__t.html">infix_reverse_t</a>* context = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga010d41376c47f1100903d427776033ab">infix_reverse_create_callback</a>(&amp;context, cmp_sig, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch03__Rec01__QsortCallback_8c.html#a7bf7d14648b43bd286a54ad622d5fc61">compare_integers_handler</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Get the native function pointer and pass it to qsort.</span></div>
<div class="line"><span class="keyword">typedef</span> int (*compare_func_t)(<span class="keyword">const</span> <span class="keywordtype">void</span>*, <span class="keyword">const</span> <span class="keywordtype">void</span>*);</div>
<div class="line">compare_func_t my_comparator = (compare_func_t)<a class="code hl_function" href="group__introspection__api.html#ga3b75e8481ac13d11faa15046fc4adb66">infix_reverse_get_code</a>(context);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> numbers[] = { 5, 1, 4, 2, 3 };</div>
<div class="line">qsort(numbers, 5, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), my_comparator);</div>
<div class="ttc" id="aCh03__Rec01__QsortCallback_8c_html_a7bf7d14648b43bd286a54ad622d5fc61"><div class="ttname"><a href="Ch03__Rec01__QsortCallback_8c.html#a7bf7d14648b43bd286a54ad622d5fc61">compare_integers_handler</a></div><div class="ttdeci">static int compare_integers_handler(const void *a, const void *b)</div><div class="ttdef"><b>Definition</b> Ch03_Rec01_QsortCallback.c:19</div></div>
<div class="ttc" id="agroup__high__level__api_html_ga010d41376c47f1100903d427776033ab"><div class="ttname"><a href="group__high__level__api.html#ga010d41376c47f1100903d427776033ab">infix_reverse_create_callback</a></div><div class="ttdeci">c23_nodiscard infix_status infix_reverse_create_callback(infix_reverse_t **, const char *, void *, infix_registry_t *)</div><div class="ttdoc">Creates a type-safe reverse trampoline (callback).</div><div class="ttdef"><b>Definition</b> trampoline.c:912</div></div>
<div class="ttc" id="agroup__introspection__api_html_ga3b75e8481ac13d11faa15046fc4adb66"><div class="ttname"><a href="group__introspection__api.html#ga3b75e8481ac13d11faa15046fc4adb66">infix_reverse_get_code</a></div><div class="ttdeci">c23_nodiscard void * infix_reverse_get_code(const infix_reverse_t *)</div><div class="ttdoc">Gets the native, callable C function pointer from a reverse trampoline.</div><div class="ttdef"><b>Definition</b> trampoline.c:805</div></div>
<div class="ttc" id="astructinfix__reverse__t_html"><div class="ttname"><a href="structinfix__reverse__t.html">infix_reverse_t</a></div><div class="ttdoc">Internal definition of a reverse trampoline (callback/closure) handle.</div><div class="ttdef"><b>Definition</b> infix_internals.h:119</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch03_Rec01_QsortCallback.c"><code>Ch03_Rec01_QsortCallback.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md61"></a>
Recipe: Creating a Stateful Callback</h2>
<p><b>Problem</b>: A callback handler needs access to application state, but the C library API is stateless (it has no <code>void* user_data</code> parameter).</p>
<p><b>Solution</b>: Use <code>infix_reverse_create_closure</code>. This API is specifically designed for stateful callbacks. You provide a generic handler and a <code>void* user_data</code> pointer to your state. Inside the handler, you can retrieve this pointer from the <code>context</code>.</p>
<div class="fragment"><div class="line"><span class="comment">// 1. The generic handler retrieves state from the context&#39;s user_data field.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="Ch03__Rec02__StatefulCallback_8c.html#a9cb1f1a76d39c758f60f5afab186d08d">my_stateful_handler</a>(<a class="code hl_struct" href="structinfix__reverse__t.html">infix_context_t</a>* context, <span class="keywordtype">void</span>* ret, <span class="keywordtype">void</span>** <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>) {</div>
<div class="line">    <a class="code hl_struct" href="structAppContext.html">AppContext</a>* ctx = (<a class="code hl_struct" href="structAppContext.html">AppContext</a>*)<a class="code hl_function" href="group__introspection__api.html#gab41c717a6e4e4198c62284e526e5d9b3">infix_reverse_get_user_data</a>(context);</div>
<div class="line">    <span class="keywordtype">int</span> item_value = *(<span class="keywordtype">int</span>*)<a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[0];</div>
<div class="line">    ctx-&gt;<a class="code hl_variable" href="structAppContext.html#a8195485c193b4f76c61a65544abb066b">sum</a> += item_value;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Prepare your state and create the closure, passing a pointer to the state.</span></div>
<div class="line"><a class="code hl_struct" href="structAppContext.html">AppContext</a> ctx = {<span class="stringliteral">&quot;My List&quot;</span>, 0};</div>
<div class="line"><a class="code hl_struct" href="structinfix__reverse__t.html">infix_reverse_t</a>* rt = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga6d1281b61d196d1d06153aa1265fb971">infix_reverse_create_closure</a>(&amp;rt, <span class="stringliteral">&quot;(int) -&gt; void&quot;</span>, <a class="code hl_function" href="Ch03__Rec02__StatefulCallback_8c.html#a9cb1f1a76d39c758f60f5afab186d08d">my_stateful_handler</a>, &amp;ctx, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Use the generated callback with a C library function.</span></div>
<div class="line"><a class="code hl_typedef" href="Ch03__Rec02__StatefulCallback_8c.html#ab80ec677438063b7dadb34d4cca3782a">item_processor_t</a> processor_ptr = (<a class="code hl_typedef" href="Ch03__Rec02__StatefulCallback_8c.html#ab80ec677438063b7dadb34d4cca3782a">item_processor_t</a>)<a class="code hl_function" href="group__introspection__api.html#ga3b75e8481ac13d11faa15046fc4adb66">infix_reverse_get_code</a>(rt);</div>
<div class="line"><span class="keywordtype">int</span> list[] = {10, 20, 30};</div>
<div class="line"><a class="code hl_function" href="Ch03__Rec02__StatefulCallback_8c.html#afb7eeae19b5cd5c588ac3bfd544371d4">process_list</a>(list, 3, processor_ptr);</div>
<div class="ttc" id="aCh03__Rec02__StatefulCallback_8c_html_a9cb1f1a76d39c758f60f5afab186d08d"><div class="ttname"><a href="Ch03__Rec02__StatefulCallback_8c.html#a9cb1f1a76d39c758f60f5afab186d08d">my_stateful_handler</a></div><div class="ttdeci">static void my_stateful_handler(infix_context_t *context, void *ret, void **args)</div><div class="ttdef"><b>Definition</b> Ch03_Rec02_StatefulCallback.c:25</div></div>
<div class="ttc" id="aCh03__Rec02__StatefulCallback_8c_html_ab80ec677438063b7dadb34d4cca3782a"><div class="ttname"><a href="Ch03__Rec02__StatefulCallback_8c.html#ab80ec677438063b7dadb34d4cca3782a">item_processor_t</a></div><div class="ttdeci">void(* item_processor_t)(int)</div><div class="ttdef"><b>Definition</b> Ch03_Rec02_StatefulCallback.c:39</div></div>
<div class="ttc" id="aCh03__Rec02__StatefulCallback_8c_html_afb7eeae19b5cd5c588ac3bfd544371d4"><div class="ttname"><a href="Ch03__Rec02__StatefulCallback_8c.html#afb7eeae19b5cd5c588ac3bfd544371d4">process_list</a></div><div class="ttdeci">static void process_list(const int *items, int count, item_processor_t process_func)</div><div class="ttdef"><b>Definition</b> Ch03_Rec02_StatefulCallback.c:40</div></div>
<div class="ttc" id="agroup__high__level__api_html_ga6d1281b61d196d1d06153aa1265fb971"><div class="ttname"><a href="group__high__level__api.html#ga6d1281b61d196d1d06153aa1265fb971">infix_reverse_create_closure</a></div><div class="ttdeci">c23_nodiscard infix_status infix_reverse_create_closure(infix_reverse_t **, const char *, infix_closure_handler_fn, void *, infix_registry_t *)</div><div class="ttdoc">Creates a generic reverse trampoline (closure) for stateful callbacks.</div><div class="ttdef"><b>Definition</b> trampoline.c:942</div></div>
<div class="ttc" id="agroup__introspection__api_html_gab41c717a6e4e4198c62284e526e5d9b3"><div class="ttname"><a href="group__introspection__api.html#gab41c717a6e4e4198c62284e526e5d9b3">infix_reverse_get_user_data</a></div><div class="ttdeci">c23_nodiscard void * infix_reverse_get_user_data(const infix_reverse_t *)</div><div class="ttdoc">Gets the user-provided data pointer from a closure context.</div><div class="ttdef"><b>Definition</b> trampoline.c:816</div></div>
<div class="ttc" id="astructAppContext_html"><div class="ttname"><a href="structAppContext.html">AppContext</a></div><div class="ttdef"><b>Definition</b> Ch03_Rec02_StatefulCallback.c:18</div></div>
<div class="ttc" id="astructAppContext_html_a8195485c193b4f76c61a65544abb066b"><div class="ttname"><a href="structAppContext.html#a8195485c193b4f76c61a65544abb066b">AppContext::sum</a></div><div class="ttdeci">int sum</div><div class="ttdef"><b>Definition</b> Ch03_Rec02_StatefulCallback.c:20</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch03_Rec02_StatefulCallback.c"><code>Ch03_Rec02_StatefulCallback.c</code></a>. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md62"></a>
&lt;/blockquote&gt;</h1>
<h1><a class="anchor" id="autotoc_md63"></a>
Chapter 4: Advanced Techniques</h1>
<h2><a class="anchor" id="autotoc_md64"></a>
Recipe: Calling Variadic Functions like &lt;tt&gt;printf&lt;/tt&gt;</h2>
<p><b>Problem</b>: You need to call a function with a variable number of arguments.</p>
<p><b>Solution</b>: Use the <code>;</code> token to separate fixed and variadic arguments. The signature must exactly match the types you are passing in a <em>specific call</em>.</p>
<div class="fragment"><div class="line"><span class="comment">// Signature for: printf(const char* format, int arg1, double arg2);</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(*char; int, double) -&gt; int&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* trampoline = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;trampoline, signature, (<span class="keywordtype">void</span>*)printf, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* fmt = <span class="stringliteral">&quot;Count: %d, Value: %.2f\n&quot;</span>;</div>
<div class="line"><span class="keywordtype">int</span> count = 42;</div>
<div class="line"><span class="keywordtype">double</span> value = 123.45;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;fmt, &amp;count, &amp;value };</div>
<div class="line"><span class="keywordtype">int</span> result;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(trampoline)(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch04_Rec01_VariadicPrintf.c"><code>Ch04_Rec01_VariadicPrintf.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md65"></a>
Recipe: Receiving and Calling a Function Pointer</h2>
<p><b>Problem</b>: You need to call a C function that <em>takes</em> a function pointer as an argument, and pass it a callback you generate.</p>
<p><b>Solution</b>: The signature for a function pointer is <code>*((...) -&gt; ...)</code>. Generate your callback, get its native pointer, and pass that pointer as an argument.</p>
<div class="fragment"><div class="line"><span class="comment">// 1. Create the inner callback.</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="Ch04__Rec02__CallbackAsArg_8c.html#a6a3c69f7b613fa1d2a0261b9e7b830c2">multiply_handler</a>(<span class="keywordtype">int</span> x) { <span class="keywordflow">return</span> x * 10; }</div>
<div class="line"><a class="code hl_struct" href="structinfix__reverse__t.html">infix_reverse_t</a>* inner_cb_ctx = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga010d41376c47f1100903d427776033ab">infix_reverse_create_callback</a>(&amp;inner_cb_ctx, <span class="stringliteral">&quot;(int)-&gt;int&quot;</span>, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch04__Rec02__CallbackAsArg_8c.html#a6a3c69f7b613fa1d2a0261b9e7b830c2">multiply_handler</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Create the outer trampoline for the function that *takes* the callback.</span></div>
<div class="line"><span class="comment">//    Signature for: int harness_func( int(*)(int), int );</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* harness_sig = <span class="stringliteral">&quot;(*((int)-&gt;int), int) -&gt; int&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* harness_trampoline = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;harness_trampoline, harness_sig, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch04__Rec02__CallbackAsArg_8c.html#a7364ec9c864f7a13510f7bde138258ae">harness_func</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Get the native pointer from the callback and pass it as an argument.</span></div>
<div class="line"><span class="keywordtype">void</span>* inner_cb_ptr = <a class="code hl_function" href="group__introspection__api.html#ga3b75e8481ac13d11faa15046fc4adb66">infix_reverse_get_code</a>(inner_cb_ctx);</div>
<div class="line"><span class="keywordtype">int</span> value = 7;</div>
<div class="line"><span class="keywordtype">void</span>* harness_args[] = { &amp;inner_cb_ptr, &amp;value };</div>
<div class="line"><span class="keywordtype">int</span> result;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(harness_trampoline)(&amp;result, harness_args);</div>
<div class="ttc" id="aCh04__Rec02__CallbackAsArg_8c_html_a6a3c69f7b613fa1d2a0261b9e7b830c2"><div class="ttname"><a href="Ch04__Rec02__CallbackAsArg_8c.html#a6a3c69f7b613fa1d2a0261b9e7b830c2">multiply_handler</a></div><div class="ttdeci">static int multiply_handler(int x)</div><div class="ttdef"><b>Definition</b> Ch04_Rec02_CallbackAsArg.c:16</div></div>
<div class="ttc" id="aCh04__Rec02__CallbackAsArg_8c_html_a7364ec9c864f7a13510f7bde138258ae"><div class="ttname"><a href="Ch04__Rec02__CallbackAsArg_8c.html#a7364ec9c864f7a13510f7bde138258ae">harness_func</a></div><div class="ttdeci">static int harness_func(int(*worker_func)(int), int base_val)</div><div class="ttdef"><b>Definition</b> Ch04_Rec02_CallbackAsArg.c:22</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch04_Rec02_CallbackAsArg.c"><code>Ch04_Rec02_CallbackAsArg.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md66"></a>
Recipe: Calling a Function Pointer from a Struct (V-Table Emulation)</h2>
<p><b>Problem</b>: You have a pointer to a struct that contains function pointers, similar to a C implementation of an object's v-table. You need to read a function pointer from the struct and then call it.</p>
<p><b>Solution</b>: This is a two-step FFI process. First, read the function pointer value from the struct. Second, create a new trampoline for that function pointer's signature and call it. The Type Registry is perfect for making this clean.</p>
<div class="fragment"><div class="line"><span class="comment">// 1. Define types for the object, function pointers, and v-table.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__registry__t.html">infix_registry_t</a>* reg = <a class="code hl_function" href="group__registry__api.html#gac808273483db7a9db2bc275c41b13296">infix_registry_create</a>();</div>
<div class="line"><a class="code hl_function" href="group__registry__api.html#ga4ece2363948c40fe528826bf65dac280">infix_register_types</a>(reg,</div>
<div class="line">    <span class="stringliteral">&quot;@Adder = { val: int };&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;@Adder_add_fn = (*@Adder, int) -&gt; int;&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;@AdderVTable = { add: *@Adder_add_fn };&quot;</span></div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Create an object and get a pointer to its v-table.</span></div>
<div class="line"><a class="code hl_struct" href="structAdder.html">Adder</a>* my_adder = <a class="code hl_function" href="Ch04__Rec03__VTableCStyle_8c.html#ad389b906b09daeca812450102dbd7f78">create_adder</a>(100);</div>
<div class="line"><span class="keyword">const</span> <a class="code hl_struct" href="structAdderVTable__t.html">AdderVTable</a>* vtable = &amp;<a class="code hl_variable" href="Ch04__Rec03__VTableCStyle_8c.html#a6401f2de2c1875f6ae56fef455b830ca">VTABLE</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Read the function pointer from the v-table.</span></div>
<div class="line"><span class="keywordtype">void</span>* add_func_ptr = (<span class="keywordtype">void</span>*)vtable-&gt;<a class="code hl_variable" href="structAdderVTable__t.html#a51c33870efa85108229fe466d5d7cfac">add</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 4. Create a trampoline for the specific function pointer and call it.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t_add = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t_add, <span class="stringliteral">&quot;@Adder_add_fn&quot;</span>, add_func_ptr, reg);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> amount_to_add = 23, result;</div>
<div class="line"><span class="keywordtype">void</span>* add_args[] = { &amp;my_adder, &amp;amount_to_add };</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t_add)(&amp;result, add_args);</div>
<div class="ttc" id="aCh04__Rec03__VTableCStyle_8c_html_a6401f2de2c1875f6ae56fef455b830ca"><div class="ttname"><a href="Ch04__Rec03__VTableCStyle_8c.html#a6401f2de2c1875f6ae56fef455b830ca">VTABLE</a></div><div class="ttdeci">const AdderVTable VTABLE</div><div class="ttdef"><b>Definition</b> Ch04_Rec03_VTableCStyle.c:44</div></div>
<div class="ttc" id="aCh04__Rec03__VTableCStyle_8c_html_ad389b906b09daeca812450102dbd7f78"><div class="ttname"><a href="Ch04__Rec03__VTableCStyle_8c.html#ad389b906b09daeca812450102dbd7f78">create_adder</a></div><div class="ttdeci">static Adder * create_adder(int base)</div><div class="ttdef"><b>Definition</b> Ch04_Rec03_VTableCStyle.c:47</div></div>
<div class="ttc" id="astructAdderVTable__t_html"><div class="ttname"><a href="structAdderVTable__t.html">AdderVTable_t</a></div><div class="ttdef"><b>Definition</b> Ch04_Rec03_VTableCStyle.c:38</div></div>
<div class="ttc" id="astructAdderVTable__t_html_a51c33870efa85108229fe466d5d7cfac"><div class="ttname"><a href="structAdderVTable__t.html#a51c33870efa85108229fe466d5d7cfac">AdderVTable_t::add</a></div><div class="ttdeci">int(* add)(Adder *self, int amount)</div><div class="ttdef"><b>Definition</b> Ch04_Rec03_VTableCStyle.c:39</div></div>
<div class="ttc" id="astructAdder_html"><div class="ttname"><a href="structAdder.html">Adder</a></div><div class="ttdef"><b>Definition</b> Ch04_Rec03_VTableCStyle.c:19</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch04_Rec03_VTableCStyle.c"><code>Ch04_Rec03_VTableCStyle.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md67"></a>
Recipe: Handling &lt;tt&gt;longdouble&lt;/tt&gt;</h2>
<p><b>Problem</b>: You need to call a function that uses <code>longdouble</code>, which has different sizes and ABI rules on different platforms (e.g., 80-bit on x86, 128-bit on AArch64, or just an alias for <code>double</code> on MSVC/macOS).</p>
<p><b>Solution</b>: Use the <code>longdouble</code> keyword in your signature. <code>infix</code>'s ABI logic contains the platform-specific rules to handle it correctly, whether it's passed on the x87 FPU stack (System V x64), in a 128-bit vector register (AArch64), or as a normal <code>double</code>.</p>
<div class="fragment"><div class="line"><span class="comment">// long double native_sqrtl(long double x);</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(longdouble) -&gt; longdouble&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch04__Rec04__LongDouble_8c.html#a894512bdd5306455b72357ca31e4394a">native_sqrtl</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">long</span> <span class="keywordtype">double</span> input = 144.0L;</div>
<div class="line"><span class="keywordtype">long</span> <span class="keywordtype">double</span> result = 0.0L;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;input };</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="aCh04__Rec04__LongDouble_8c_html_a894512bdd5306455b72357ca31e4394a"><div class="ttname"><a href="Ch04__Rec04__LongDouble_8c.html#a894512bdd5306455b72357ca31e4394a">native_sqrtl</a></div><div class="ttdeci">static long double native_sqrtl(long double x)</div><div class="ttdef"><b>Definition</b> Ch04_Rec04_LongDouble.c:21</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch04_Rec04_LongDouble.c"><code>Ch04_Rec04_LongDouble.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md68"></a>
Recipe: Proving Reentrancy with Nested FFI Calls</h2>
<p><b>Problem</b>: You need to be sure that making an FFI call from within an FFI callback is safe.</p>
<p><b>Solution</b>: <code>infix</code> is designed to be fully reentrant. The library uses no global mutable state, and all error information is stored in thread-local storage. This recipe demonstrates a forward call that invokes a reverse callback, which in turn makes another forward call.</p>
<div class="fragment"><div class="line"><span class="comment">// 1. Create the innermost forward trampoline (for `multiply`).</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* fwd_multiply = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;fwd_multiply, <span class="stringliteral">&quot;(int, int)-&gt;int&quot;</span>, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch04__Rec05__Reentrancy_8c.html#ade3045972fd82501bc744d8d42d11f15">multiply</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Create the reverse closure, passing the forward trampoline as user_data.</span></div>
<div class="line"><span class="comment">//    The handler will use this trampoline to make the nested call.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__reverse__t.html">infix_reverse_t</a>* rev_nested = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga6d1281b61d196d1d06153aa1265fb971">infix_reverse_create_closure</a>(&amp;rev_nested, <span class="stringliteral">&quot;(int)-&gt;int&quot;</span>, <a class="code hl_function" href="Ch04__Rec05__Reentrancy_8c.html#a44e24e8a11367eb1b22c59dd485c9dda">nested_call_handler</a>, fwd_multiply, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Create the outermost forward trampoline (for `harness`).</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* fwd_harness = NULL;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* harness_sig = <span class="stringliteral">&quot;(*((int)-&gt;int), int)-&gt;int&quot;</span>;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;fwd_harness, harness_sig, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="304__reverse__call__types_8c.html#a231b550372790873ba594962b74cde24">harness</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 4. Execute the call chain.</span></div>
<div class="line"><span class="keywordtype">void</span>* callback_ptr = <a class="code hl_function" href="group__introspection__api.html#ga3b75e8481ac13d11faa15046fc4adb66">infix_reverse_get_code</a>(rev_nested);</div>
<div class="line"><span class="keywordtype">int</span> base_val = 8;</div>
<div class="line"><span class="keywordtype">void</span>* harness_args[] = { &amp;callback_ptr, &amp;base_val };</div>
<div class="line"><span class="keywordtype">int</span> final_result;</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(fwd_harness)(&amp;final_result, harness_args);</div>
<div class="ttc" id="a304__reverse__call__types_8c_html_a231b550372790873ba594962b74cde24"><div class="ttname"><a href="304__reverse__call__types_8c.html#a231b550372790873ba594962b74cde24">harness</a></div><div class="ttdeci">void harness(int(*func_ptr)(int, int), int a, int b, int expected)</div><div class="ttdef"><b>Definition</b> 304_reverse_call_types.c:33</div></div>
<div class="ttc" id="aCh04__Rec05__Reentrancy_8c_html_a44e24e8a11367eb1b22c59dd485c9dda"><div class="ttname"><a href="Ch04__Rec05__Reentrancy_8c.html#a44e24e8a11367eb1b22c59dd485c9dda">nested_call_handler</a></div><div class="ttdeci">static void nested_call_handler(infix_context_t *ctx, void *ret, void **args)</div><div class="ttdef"><b>Definition</b> Ch04_Rec05_Reentrancy.c:29</div></div>
<div class="ttc" id="aCh04__Rec05__Reentrancy_8c_html_ade3045972fd82501bc744d8d42d11f15"><div class="ttname"><a href="Ch04__Rec05__Reentrancy_8c.html#ade3045972fd82501bc744d8d42d11f15">multiply</a></div><div class="ttdeci">static int multiply(int a, int b)</div><div class="ttdef"><b>Definition</b> Ch04_Rec05_Reentrancy.c:22</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch04_Rec05_Reentrancy.c"><code>Ch04_Rec05_Reentrancy.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md69"></a>
Recipe: Proving Thread Safety</h2>
<p><b>Problem</b>: You need to create a trampoline in one thread and safely use it in another.</p>
<p><b>Solution</b>: <code>infix</code> trampoline handles (<code>infix_forward_t*</code> and <code>infix_reverse_t*</code>) are immutable after creation and are safe to share between threads. All error state is kept in thread-local storage, so calls from different threads will not interfere with each other.</p>
<div class="fragment"><div class="line"><span class="comment">// Main thread: Create the trampoline.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* trampoline = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;trampoline, <span class="stringliteral">&quot;(int, int)-&gt;int&quot;</span>, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="Ch04__Rec06__ThreadSafety_8c.html#a876d849a2f1867b8b2be9881f4a191d5">add</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Main thread: Prepare data for the worker thread, including the callable pointer.</span></div>
<div class="line"><a class="code hl_struct" href="structthread__data__t.html">thread_data_t</a> data = { <a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(trampoline), 0 };</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Main thread: Spawn a worker thread.</span></div>
<div class="line">pthread_t thread_id;</div>
<div class="line">pthread_create(&amp;thread_id, NULL, <a class="code hl_function" href="Ch04__Rec06__ThreadSafety_8c.html#aa3b119e6278d644b02d45b6bfdf1d3ac">worker_thread_func</a>, &amp;data);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Worker thread (`worker_thread_func`):</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="comment">//   data-&gt;cif(&amp;data-&gt;result, args); // &lt;-- FFI call happens here</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line">pthread_join(thread_id, NULL);</div>
<div class="ttc" id="aCh04__Rec06__ThreadSafety_8c_html_a876d849a2f1867b8b2be9881f4a191d5"><div class="ttname"><a href="Ch04__Rec06__ThreadSafety_8c.html#a876d849a2f1867b8b2be9881f4a191d5">add</a></div><div class="ttdeci">static int add(int a, int b)</div><div class="ttdef"><b>Definition</b> Ch04_Rec06_ThreadSafety.c:25</div></div>
<div class="ttc" id="aCh04__Rec06__ThreadSafety_8c_html_aa3b119e6278d644b02d45b6bfdf1d3ac"><div class="ttname"><a href="Ch04__Rec06__ThreadSafety_8c.html#aa3b119e6278d644b02d45b6bfdf1d3ac">worker_thread_func</a></div><div class="ttdeci">void * worker_thread_func(void *arg)</div><div class="ttdef"><b>Definition</b> Ch04_Rec06_ThreadSafety.c:37</div></div>
<div class="ttc" id="astructthread__data__t_html"><div class="ttname"><a href="structthread__data__t.html">thread_data_t</a></div><div class="ttdef"><b>Definition</b> Ch04_Rec06_ThreadSafety.c:28</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch04_Rec06_ThreadSafety.c"><code>Ch04_Rec06_ThreadSafety.c</code></a>. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md70"></a>
&lt;/blockquote&gt;</h1>
<h1><a class="anchor" id="autotoc_md71"></a>
Chapter 5: Interoperability with Other Languages</h1>
<h2><a class="anchor" id="autotoc_md72"></a>
The Universal Principle: The C ABI</h2>
<p><code>infix</code> can call any function that exposes a standard C ABI. Nearly every compiled language provides a mechanism to export a function using this standard (<code>extern "C"</code> in C++/Rust/Zig, <code>//export</code> in Go, <code>bind(C)</code> in Fortran).</p>
<h2><a class="anchor" id="autotoc_md73"></a>
Recipe: Interfacing with a C++ Class (Directly)</h2>
<p><b>Problem</b>: You need to call C++ class methods without writing a C wrapper.</p>
<p><b>Solution</b>: Find the compiler-mangled names for the constructor, destructor, and methods. Use <code>infix</code> to call them directly, manually passing the <code>this</code> pointer as the first argument to methods.</p>
<div class="fragment"><div class="line"><span class="comment">// Mangled names depend on the compiler. This example gets them from a helper.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* mangled_ctor = get_mangled_constructor();</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* mangled_getvalue = get_mangled_getvalue();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Constructor is: void MyClass(MyClass* this, int val);</span></div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t_ctor, <span class="stringliteral">&quot;(*void, int)-&gt;void&quot;</span>, p_ctor, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Method is: int getValue(const MyClass* this);</span></div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t_getval, <span class="stringliteral">&quot;(*void)-&gt;int&quot;</span>, p_getval, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// --- Simulate `MyClass* obj = new MyClass(100);` ---</span></div>
<div class="line"><span class="keywordtype">void</span>* obj = malloc(obj_size);</div>
<div class="line"><span class="keywordtype">int</span> initial_val = 100;</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t_ctor)(NULL, (<span class="keywordtype">void</span>*[]){ &amp;obj, &amp;initial_val });</div>
<div class="line"> </div>
<div class="line"><span class="comment">// --- Simulate `int result = obj-&gt;getValue();` ---</span></div>
<div class="line"><span class="keywordtype">int</span> result;</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t_getval)(&amp;result, (<span class="keywordtype">void</span>*[]){ &amp;obj });</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch05_Rec01_CppMangledNames.c"><code>Ch05_Rec01_CppMangledNames.c</code></a> and library source in <a href="/eg/cookbook/libs/MyClass.cpp"><code>libs/MyClass.cpp</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md74"></a>
Recipe: Interfacing with C++ Templates</h2>
<p><b>Problem</b>: How do you call a C++ function template from C?</p>
<p><b>Solution</b>: You can't call the template itself, but you can call a <em>specific instantiation</em> of it. The compiler generates a normal function for each concrete type used with the template, and this function has a predictable mangled name that you can look up and call.</p>
<div class="fragment"><div class="line"><span class="comment">// Mangled name for `Box&lt;double&gt;::get_value()` on GCC/Clang</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code hl_variable" href="Ch05__Rec02__CppTemplates_8c.html#a05148a0a76c836ea9975669e23d9b7c5">MANGLED_GET_DBL</a> = <span class="stringliteral">&quot;_ZNK3BoxIdE9get_valueEv&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In a real scenario, you would call the mangled constructor.</span></div>
<div class="line"><span class="comment">// For simplicity here, we manually create the object layout.</span></div>
<div class="line"><span class="keywordtype">double</span> val = 3.14;</div>
<div class="line"><span class="keywordtype">void</span>* my_box = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line">memcpy(my_box, &amp;val, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span>* p_get_value = <a class="code hl_function" href="group__exports__api.html#ga227480098fa596f3c372837461a6b805">infix_library_get_symbol</a>(lib, <a class="code hl_variable" href="Ch05__Rec02__CppTemplates_8c.html#a05148a0a76c836ea9975669e23d9b7c5">MANGLED_GET_DBL</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Signature: double get_value(const Box&lt;double&gt;* this)</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t_get = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t_get, <span class="stringliteral">&quot;(*void) -&gt; double&quot;</span>, p_get_value, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> result;</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t_get)(&amp;result, (<span class="keywordtype">void</span>*[]){ &amp;my_box });</div>
<div class="ttc" id="aCh05__Rec02__CppTemplates_8c_html_a05148a0a76c836ea9975669e23d9b7c5"><div class="ttname"><a href="Ch05__Rec02__CppTemplates_8c.html#a05148a0a76c836ea9975669e23d9b7c5">MANGLED_GET_DBL</a></div><div class="ttdeci">const char * MANGLED_GET_DBL</div><div class="ttdef"><b>Definition</b> Ch05_Rec02_CppTemplates.c:15</div></div>
<div class="ttc" id="agroup__exports__api_html_ga227480098fa596f3c372837461a6b805"><div class="ttname"><a href="group__exports__api.html#ga227480098fa596f3c372837461a6b805">infix_library_get_symbol</a></div><div class="ttdeci">c23_nodiscard void * infix_library_get_symbol(infix_library_t *, const char *)</div><div class="ttdoc">Retrieves the address of a symbol (function or variable) from a loaded library.</div><div class="ttdef"><b>Definition</b> loader.c:121</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch05_Rec02_CppTemplates.c"><code>Ch05_Rec02_CppTemplates.c</code></a> and library source in <a href="/eg/cookbook/libs/Box.cpp"><code>libs/Box.cpp</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md75"></a>
The Pattern for Other Compiled Languages</h2>
<p>The <code>extern "C"</code> pattern is universal. The C code to call any of the functions below would be identical: load the library, find the symbol, create a trampoline for <code>(int, int) -&gt; int</code>, and call it.</p>
<h3><a class="anchor" id="autotoc_md76"></a>
Rust</h3>
<p>To export a C-compatible function from Rust, use <code>#[no_mangle]</code> to prevent name mangling and <code>extern "C"</code> to specify the calling convention.</p>
<div class="fragment"><div class="line">// librust_math.rs</div>
<div class="line">#[no_mangle]</div>
<div class="line">pub extern &quot;C&quot; fn rust_add(a: i32, b: i32) -&gt; i32 {</div>
<div class="line">    a + b</div>
<div class="line">}</div>
</div><!-- fragment --><p><em>Compile with: <code>rustc --crate-type cdylib librust_math.rs</code></em></p>
<h3><a class="anchor" id="autotoc_md77"></a>
Zig</h3>
<p>Zig's <code>export</code> keyword makes a function available with the C ABI by default.</p>
<div class="fragment"><div class="line">// libzig_math.zig</div>
<div class="line">export fn zig_add(a: c_int, b: c_int) c_int {</div>
<div class="line">    return a + b;</div>
<div class="line">}</div>
</div><!-- fragment --><p><em>Compile with: <code>zig build-lib -dynamic libzig_math.zig</code></em></p>
<h3><a class="anchor" id="autotoc_md78"></a>
Go</h3>
<p>Go can export functions to C using a special <code>//export</code> comment directive.</p>
<div class="fragment"><div class="line">// libgo_math.go</div>
<div class="line">package main</div>
<div class="line">import &quot;C&quot;</div>
<div class="line"> </div>
<div class="line">//export go_add</div>
<div class="line">func go_add(a C.int, b C.int) C.int { return a + b }</div>
<div class="line">func main() {}</div>
</div><!-- fragment --><p><em>Compile with: <code>go build -buildmode=c-shared -o libgo_math.so libgo_math.go</code></em></p>
<h3><a class="anchor" id="autotoc_md79"></a>
Swift</h3>
<p>The <code>@_cdecl</code> attribute exposes a Swift function to C with a specified name.</p>
<div class="fragment"><div class="line">// libswift_math.swift</div>
<div class="line">@_cdecl(&quot;swift_add&quot;)</div>
<div class="line">public func swift_add(a: CInt, b: CInt) -&gt; CInt {</div>
<div class="line">    return a + b</div>
<div class="line">}</div>
</div><!-- fragment --><p><em>Compile with: <code>swiftc -emit-library libswift_math.swift -o libswift_math.so</code></em></p>
<h3><a class="anchor" id="autotoc_md80"></a>
Dlang</h3>
<p>The <code>extern(C)</code> attribute specifies the C calling convention for a D function.</p>
<div class="fragment"><div class="line"><span class="comment">// libd_math.d</span></div>
<div class="line"><span class="keyword">extern</span> (C) <span class="keywordtype">int</span> d_add(<span class="keywordtype">int</span> a, <span class="keywordtype">int</span> b) { <span class="keywordflow">return</span> a + b; }</div>
</div><!-- fragment --><p><em>Compile with: <code>dmd -shared -fPIC -of=libd_math.so libd_math.d</code></em></p>
<h3><a class="anchor" id="autotoc_md81"></a>
Fortran</h3>
<p>The <code>bind(C)</code> attribute from the <code>iso_c_binding</code> module provides C interoperability.</p>
<div class="fragment"><div class="line"><span class="comment">! libfortran_math.f90</span></div>
<div class="line"><span class="keyword">function </span>fortran_add(a, b) <span class="keyword">result</span>(c) bind(C, name=&#39;fortran_add&#39;)</div>
<div class="line">    <span class="keywordtype">use </span>iso_c_binding</div>
<div class="line">    <span class="keywordtype">integer(c_int)</span>, <span class="keywordtype">value</span> :: a, b</div>
<div class="line">    <span class="keywordtype">integer(c_int)</span> :: c</div>
<div class="line">    c = a + b</div>
<div class="line"><span class="keyword">end function </span>fortran_add</div>
</div><!-- fragment --><p><em>Compile with: <code>gfortran -shared -fPIC -o libfortran_math.so libfortran_math.f90</code></em></p>
<h3><a class="anchor" id="autotoc_md82"></a>
Assembly</h3>
<p>Pure machine code has no name mangling. You just need to follow the target ABI's calling convention.</p>
<div class="fragment"><div class="line">; libasm_math.asm (for System V x64 ABI)</div>
<div class="line">section .text</div>
<div class="line">global asm_add</div>
<div class="line">asm_add:</div>
<div class="line">    mov eax, edi ; Move first argument (RDI) into EAX</div>
<div class="line">    add eax, esi ; Add second argument (RSI) to EAX</div>
<div class="line">    ret          ; Return value is in EAX</div>
</div><!-- fragment --><p><em>Compile with: <code>nasm -f elf64 libasm_math.asm &amp;&amp; gcc -shared -o libasm_math.so libasm_math.o</code></em></p>
<h2><a class="anchor" id="autotoc_md83"></a>
Recipe: Handling Strings and Semantic Types (&lt;tt&gt;wchar_t&lt;/tt&gt;, etc.)</h2>
<p><b>Problem</b>: You are building a language binding and need to introspect a signature to marshal strings correctly. A signature like <code>*uint16</code> is structurally correct for a Windows <code>wchar_t*</code>, but how does your code know it's a null-terminated string and not just a pointer to an integer?</p>
<p><b>Solution</b>: Use the <code>infix</code> type registry to create <b>semantic aliases</b>. The signature string itself can then document the <em>intent</em> of the type, which your wrapper can use to trigger the correct string-handling logic. This pattern provides the missing link between C's structural type system and the semantic needs of a high-level language.</p>
<p>Let's model the Windows <code>MessageBoxW</code> function, which takes two UTF-16 strings.</p>
<h3><a class="anchor" id="autotoc_md84"></a>
Step 1: Define Semantic Aliases in a Registry</h3>
<div class="fragment"><div class="line"><a class="code hl_struct" href="structinfix__registry__t.html">infix_registry_t</a>* <a class="code hl_variable" href="008__registry__introspection_8c.html#aa7e646c2771eaee632371488e9b195fa">registry</a> = <a class="code hl_function" href="group__registry__api.html#gac808273483db7a9db2bc275c41b13296">infix_registry_create</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* string_types =</div>
<div class="line">    <span class="comment">// Structural aliases for Windows types</span></div>
<div class="line">    <span class="stringliteral">&quot;@HWND = *void;&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;@UINT = uint32;&quot;</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Semantic aliases that describe intent, not just structure.</span></div>
<div class="line">    <span class="stringliteral">&quot;@UTF16String = { data: *uint16 };&quot;</span> <span class="comment">// Represents wchar_t*</span></div>
<div class="line">    <span class="stringliteral">&quot;@UTF8String = { data: *char };&quot;</span>    <span class="comment">// Represents const char*</span></div>
<div class="line">;</div>
<div class="line"><a class="code hl_function" href="group__registry__api.html#ga4ece2363948c40fe528826bf65dac280">infix_register_types</a>(<a class="code hl_variable" href="008__registry__introspection_8c.html#aa7e646c2771eaee632371488e9b195fa">registry</a>, string_types);</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;<b>Note:</b> We define <code>UTF16String</code> as <code>{*uint16}</code> instead of a direct alias <code>*uint16</code>. This is a crucial technique. By wrapping the pointer in a struct, the name <code>@UTF16String</code> refers to the struct itself, making it inspectable. </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md85"></a>
Step 2: Use the Aliases in Your Signature</h3>
<div class="fragment"><div class="line"><span class="comment">// Signature for: int MessageBoxW(HWND hwnd, LPCWSTR lpText, LPCWSTR lpCaption, UINT uType);</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;(@HWND, @UTF16String, @UTF16String, @UINT) -&gt; int&quot;</span>;</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md86"></a>
Step 3: Introspect with Semantic Awareness</h3>
<div class="fragment"><div class="line"><span class="comment">// 1. Parse the function signature to get its components.</span></div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#gabc24d2667f9cac5f45bd9a71efe66cf7">infix_signature_parse</a>(signature, &amp;<a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a>, &amp;ret, &amp;<a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>, &amp;num_args, &amp;num_fixed, <a class="code hl_variable" href="008__registry__introspection_8c.html#aa7e646c2771eaee632371488e9b195fa">registry</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Introspect the type of an argument.</span></div>
<div class="line"><span class="keyword">const</span> <a class="code hl_struct" href="structinfix__type__t.html">infix_type</a>* arg_type = <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[1].type; <span class="comment">// Second argument</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. After resolution, `@UTF16String` is a STRUCT. Check its preserved name.</span></div>
<div class="line"><span class="keywordflow">if</span> (arg_type-&gt;<a class="code hl_variable" href="group__high__level__api.html#ga95e67389ced0dfc9e4d9a6e076d4c645">category</a> == <a class="code hl_enumvalue" href="group__type__system.html#gga909e562b00e504aeceac698bd272f0caaf06a8a8b819b166236fabab3bf2bdcd4">INFIX_TYPE_STRUCT</a> &amp;&amp; arg_type-&gt;<a class="code hl_variable" href="group__high__level__api.html#ga06717387732a6557d456a760bb3150cc">meta</a>.<a class="code hl_variable" href="group__high__level__api.html#ga9d7572a9e837b5a8cb21010a91983abb">aggregate_info</a>.<a class="code hl_variable" href="group__high__level__api.html#ga736c003e9eef685d02153e46a46ad461">name</a>) {</div>
<div class="line">    <span class="keywordflow">if</span> (strcmp(arg_type-&gt;<a class="code hl_variable" href="group__high__level__api.html#ga06717387732a6557d456a760bb3150cc">meta</a>.<a class="code hl_variable" href="group__high__level__api.html#ga9d7572a9e837b5a8cb21010a91983abb">aggregate_info</a>.<a class="code hl_variable" href="group__high__level__api.html#ga736c003e9eef685d02153e46a46ad461">name</a>, <span class="stringliteral">&quot;UTF16String&quot;</span>) == 0) {</div>
<div class="line">        <span class="comment">// This is our cue! Marshal the user&#39;s string as UTF-16.</span></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="a005__layouts_8c_html_afb7c3f5e091eb15b03c0a427c1a3ad1e"><div class="ttname"><a href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a></div><div class="ttdeci">infix_arena_t * arena</div><div class="ttdef"><b>Definition</b> 005_layouts.c:68</div></div>
<div class="ttc" id="agroup__high__level__api_html_ga06717387732a6557d456a760bb3150cc"><div class="ttname"><a href="group__high__level__api.html#ga06717387732a6557d456a760bb3150cc">infix_type_t::meta</a></div><div class="ttdeci">union infix_type_t::@0 meta</div><div class="ttdoc">A union containing metadata specific to the type's category.</div></div>
<div class="ttc" id="agroup__high__level__api_html_ga736c003e9eef685d02153e46a46ad461"><div class="ttname"><a href="group__high__level__api.html#ga736c003e9eef685d02153e46a46ad461">infix_type_t::name</a></div><div class="ttdeci">const char * name</div><div class="ttdef"><b>Definition</b> infix.h:229</div></div>
<div class="ttc" id="agroup__high__level__api_html_ga95e67389ced0dfc9e4d9a6e076d4c645"><div class="ttname"><a href="group__high__level__api.html#ga95e67389ced0dfc9e4d9a6e076d4c645">infix_type_t::category</a></div><div class="ttdeci">infix_type_category category</div><div class="ttdef"><b>Definition</b> infix.h:212</div></div>
<div class="ttc" id="agroup__high__level__api_html_ga9d7572a9e837b5a8cb21010a91983abb"><div class="ttname"><a href="group__high__level__api.html#ga9d7572a9e837b5a8cb21010a91983abb">infix_type_t::aggregate_info</a></div><div class="ttdeci">struct infix_type_t::@0::@2 aggregate_info</div><div class="ttdoc">Metadata for INFIX_TYPE_STRUCT and INFIX_TYPE_UNION.</div></div>
<div class="ttc" id="agroup__high__level__api_html_gabc24d2667f9cac5f45bd9a71efe66cf7"><div class="ttname"><a href="group__high__level__api.html#gabc24d2667f9cac5f45bd9a71efe66cf7">infix_signature_parse</a></div><div class="ttdeci">c23_nodiscard infix_status infix_signature_parse(const char *, infix_arena_t **, infix_type **, infix_function_argument **, size_t *, size_t *, infix_registry_t *)</div><div class="ttdoc">Parses a full function signature string into its constituent parts.</div><div class="ttdef"><b>Definition</b> signature.c:1091</div></div>
<div class="ttc" id="agroup__type__system_html_gga909e562b00e504aeceac698bd272f0caaf06a8a8b819b166236fabab3bf2bdcd4"><div class="ttname"><a href="group__type__system.html#gga909e562b00e504aeceac698bd272f0caaf06a8a8b819b166236fabab3bf2bdcd4">INFIX_TYPE_STRUCT</a></div><div class="ttdeci">@ INFIX_TYPE_STRUCT</div><div class="ttdef"><b>Definition</b> infix.h:165</div></div>
<div class="ttc" id="astructinfix__type__t_html"><div class="ttname"><a href="structinfix__type__t.html">infix_type_t</a></div><div class="ttdoc">A semi-opaque structure that describes a C type.</div><div class="ttdef"><b>Definition</b> infix.h:211</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch05_Rec03_SemanticStrings.c"><code>Ch05_Rec03_SemanticStrings.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md87"></a>
Recipe: Calling C++ Virtual Functions (V-Table Emulation)</h2>
<p><b>Problem</b>: You have a pointer to a C++ polymorphic base class object (e.g., <code>Shape*</code>) and you need to call a <code>virtual</code> function on it from C, achieving true dynamic dispatch.</p>
<p><b>Solution</b>: Emulate what the C++ compiler does: manually read the object's v-table pointer (<code>vptr</code>), find the function pointer at the correct index within the v-table, and use <code>infix</code> to call it.</p>
<div class="fragment"><div class="line"><span class="comment">// 1. Create a C++ object via a factory function.</span></div>
<div class="line"><span class="keywordtype">void</span>* rect_obj = create_rectangle(10.0, 5.0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Manually read the v-table pointer from the object&#39;s memory.</span></div>
<div class="line"><span class="keywordtype">void</span>** vptr = (<span class="keywordtype">void</span>**)rect_obj;</div>
<div class="line"><span class="keywordtype">void</span>** vtable = *vptr;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Read function pointers from their known indices in the v-table.</span></div>
<div class="line"><span class="keywordtype">void</span>* area_fn_ptr = vtable[0]; <span class="comment">// double area() const -&gt; index 0</span></div>
<div class="line"><span class="keywordtype">void</span>* name_fn_ptr = vtable[1]; <span class="comment">// const char* name() const -&gt; index 1</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 4. Create trampolines for the discovered function pointers.</span></div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t_area, <span class="stringliteral">&quot;(*void)-&gt;double&quot;</span>, area_fn_ptr, NULL);</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t_name, <span class="stringliteral">&quot;(*void)-&gt;*char&quot;</span>, name_fn_ptr, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 5. Call the virtual functions, passing the object as the `this` pointer.</span></div>
<div class="line"><span class="keywordtype">double</span> rect_area;</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t_area)(&amp;rect_area, (<span class="keywordtype">void</span>*[]){ &amp;rect_obj });</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch05_Rec04_CppVirtualFunctions.c"><code>Ch05_Rec04_CppVirtualFunctions.c</code></a> and library source in <a href="/eg/cookbook/libs/shapes.cpp"><code>libs/shapes.cpp</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md88"></a>
Recipe: Bridging C++ Callbacks (&lt;tt&gt;std::function&lt;/tt&gt;) and Lambdas</h2>
<p><b>Problem</b>: You need to call a C++ method that accepts a callback (e.g., <code>std::function&lt;void(int)&gt;</code>), and provide a stateful handler from your C application.</p>
<p><b>Solution</b>: This is a powerful, two-way FFI interaction. You will create an <code>infix</code> closure to represent your C-side state, and then call a mangled C++ method to register that closure's components (its C function pointer and its state pointer) with the C++ object.</p>
<div class="fragment"><div class="line"><span class="comment">// 1. Create the C-side state and the infix closure.</span></div>
<div class="line">C_AppState app_state = {0};</div>
<div class="line"><a class="code hl_struct" href="structinfix__reverse__t.html">infix_reverse_t</a>* closure = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga6d1281b61d196d1d06153aa1265fb971">infix_reverse_create_closure</a>(&amp;closure, <span class="stringliteral">&quot;(int, *void)-&gt;void&quot;</span>, my_closure_handler, &amp;app_state, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Create an instance of the C++ EventManager object.</span></div>
<div class="line"><span class="keywordtype">void</span>* manager_obj = malloc(get_size());</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t_ctor, <span class="stringliteral">&quot;(*void)-&gt;void&quot;</span>, p_ctor, NULL);</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t_ctor)(NULL, &amp;manager_obj);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Call the C++ `set_handler` method to register our closure&#39;s components.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* sig = <span class="stringliteral">&quot;(*void, *((int, *void)-&gt;void), *void)-&gt;void&quot;</span>;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t_set_handler, sig, p_set_handler, NULL);</div>
<div class="line"><span class="keywordtype">void</span>* closure_c_func = <a class="code hl_function" href="group__introspection__api.html#ga3b75e8481ac13d11faa15046fc4adb66">infix_reverse_get_code</a>(closure);</div>
<div class="line"><span class="keywordtype">void</span>* closure_user_data = <a class="code hl_function" href="group__introspection__api.html#gab41c717a6e4e4198c62284e526e5d9b3">infix_reverse_get_user_data</a>(closure);</div>
<div class="line"><span class="keywordtype">void</span>* set_handler_args[] = { &amp;manager_obj, &amp;closure_c_func, &amp;closure_user_data };</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t_set_handler)(NULL, set_handler_args);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 4. Call the C++ `trigger` method to make it invoke our C callback.</span></div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t_trigger, <span class="stringliteral">&quot;(*void, int)-&gt;void&quot;</span>, p_trigger, NULL);</div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch05_Rec05_CppCallbacks.cpp"><code>Ch05_Rec05_CppCallbacks.cpp</code></a> and library source in <a href="/eg/cookbook/libs/EventManager.cpp"><code>libs/EventManager.cpp</code></a>. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md89"></a>
Chapter 6: Dynamic Libraries &amp; System Calls</h1>
<h2><a class="anchor" id="autotoc_md90"></a>
Recipe: Calling Native System Libraries without Linking</h2>
<p><b>Problem</b>: You need to call a function from a system library (e.g., <code>user32.dll</code>) without linking against its import library at compile time.</p>
<p><b>Solution</b>: Use <code>infix</code>'s cross-platform library loading API to get a handle to the library and the function pointer, then create a trampoline.</p>
<div class="fragment"><div class="line"><span class="comment">// 1. Open the system library by name.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__library__t.html">infix_library_t</a>* user32 = <a class="code hl_function" href="group__exports__api.html#gabfd1bb148a39b758e57e772c09b9ea84">infix_library_open</a>(<span class="stringliteral">&quot;user32.dll&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Look up the address of the `MessageBoxA` function.</span></div>
<div class="line"><span class="keywordtype">void</span>* pMessageBoxA = <a class="code hl_function" href="group__exports__api.html#ga227480098fa596f3c372837461a6b805">infix_library_get_symbol</a>(user32, <span class="stringliteral">&quot;MessageBoxA&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Define the signature and create the trampoline.</span></div>
<div class="line"><span class="comment">//    int MessageBoxA(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType);</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* sig = <span class="stringliteral">&quot;(*void, *char, *char, uint32) -&gt; int&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, sig, pMessageBoxA, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 4. Prepare arguments and call the function.</span></div>
<div class="line"><span class="keywordtype">void</span>* hwnd = NULL;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* text = <span class="stringliteral">&quot;Hello from a dynamically loaded function!&quot;</span>;</div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keywordtype">int</span> result;</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="ttc" id="agroup__exports__api_html_gabfd1bb148a39b758e57e772c09b9ea84"><div class="ttname"><a href="group__exports__api.html#gabfd1bb148a39b758e57e772c09b9ea84">infix_library_open</a></div><div class="ttdeci">c23_nodiscard infix_library_t * infix_library_open(const char *)</div><div class="ttdoc">Opens a dynamic library and returns a handle to it.</div><div class="ttdef"><b>Definition</b> loader.c:50</div></div>
<div class="ttc" id="astructinfix__library__t_html"><div class="ttname"><a href="structinfix__library__t.html">infix_library_t</a></div><div class="ttdoc">Internal definition of a dynamic library handle.</div><div class="ttdef"><b>Definition</b> infix_internals.h:213</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch06_Rec01_SystemLibraries.c"><code>Ch06_Rec01_SystemLibraries.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md91"></a>
Recipe: Reading and Writing Global Variables</h2>
<p><b>Problem</b>: You need to access a global variable exported from a shared library, not just a function.</p>
<p><b>Solution</b>: Use <code><a class="el" href="group__exports__api.html#gaec836cea65f5c0ff31780b26f5315796" title="Reads the value of a global variable from a library into a buffer.">infix_read_global()</a></code> and <code><a class="el" href="group__exports__api.html#ga02212862110c752548fbdc0b3ba65bec" title="Writes data from a buffer into a global variable in a library.">infix_write_global()</a></code>. The powerful signature language is used to describe the variable's type, ensuring <code>infix</code> reads or writes the correct number of bytes.</p>
<h3><a class="anchor" id="autotoc_md92"></a>
Example 1: Simple Integer Variable</h3>
<div class="fragment"><div class="line"><a class="code hl_struct" href="structinfix__library__t.html">infix_library_t</a>* lib = <a class="code hl_function" href="group__exports__api.html#gabfd1bb148a39b758e57e772c09b9ea84">infix_library_open</a>(<span class="stringliteral">&quot;./libglobals.so&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> counter_val = 0;</div>
<div class="line"><span class="comment">// 1. Read the initial value. The signature is simply the type of the variable.</span></div>
<div class="line"><a class="code hl_function" href="group__exports__api.html#gaec836cea65f5c0ff31780b26f5315796">infix_read_global</a>(lib, <span class="stringliteral">&quot;global_counter&quot;</span>, <span class="stringliteral">&quot;int&quot;</span>, &amp;counter_val, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Write a new value to the global variable.</span></div>
<div class="line"><span class="keywordtype">int</span> new_val = 100;</div>
<div class="line"><a class="code hl_function" href="group__exports__api.html#ga02212862110c752548fbdc0b3ba65bec">infix_write_global</a>(lib, <span class="stringliteral">&quot;global_counter&quot;</span>, <span class="stringliteral">&quot;int&quot;</span>, &amp;new_val, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Read it back to confirm.</span></div>
<div class="line"><a class="code hl_function" href="group__exports__api.html#gaec836cea65f5c0ff31780b26f5315796">infix_read_global</a>(lib, <span class="stringliteral">&quot;global_counter&quot;</span>, <span class="stringliteral">&quot;int&quot;</span>, &amp;counter_val, NULL);</div>
<div class="ttc" id="agroup__exports__api_html_ga02212862110c752548fbdc0b3ba65bec"><div class="ttname"><a href="group__exports__api.html#ga02212862110c752548fbdc0b3ba65bec">infix_write_global</a></div><div class="ttdeci">c23_nodiscard infix_status infix_write_global(infix_library_t *, const char *, const char *, void *, infix_registry_t *)</div><div class="ttdoc">Writes data from a buffer into a global variable in a library.</div><div class="ttdef"><b>Definition</b> loader.c:196</div></div>
<div class="ttc" id="agroup__exports__api_html_gaec836cea65f5c0ff31780b26f5315796"><div class="ttname"><a href="group__exports__api.html#gaec836cea65f5c0ff31780b26f5315796">infix_read_global</a></div><div class="ttdeci">c23_nodiscard infix_status infix_read_global(infix_library_t *, const char *, const char *, void *, infix_registry_t *)</div><div class="ttdoc">Reads the value of a global variable from a library into a buffer.</div><div class="ttdef"><b>Definition</b> loader.c:149</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md93"></a>
Example 2: Aggregate (Struct) Variable</h3>
<div class="fragment"><div class="line"><a class="code hl_struct" href="structinfix__registry__t.html">infix_registry_t</a>* reg = <a class="code hl_function" href="group__registry__api.html#gac808273483db7a9db2bc275c41b13296">infix_registry_create</a>();</div>
<div class="line"><a class="code hl_function" href="group__registry__api.html#ga4ece2363948c40fe528826bf65dac280">infix_register_types</a>(reg, <span class="stringliteral">&quot;@Config = {*char, int};&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structConfig.html">Config</a> local_config;</div>
<div class="line"><span class="comment">// 1. Read the global struct into our local variable.</span></div>
<div class="line"><a class="code hl_function" href="group__exports__api.html#gaec836cea65f5c0ff31780b26f5315796">infix_read_global</a>(lib, <span class="stringliteral">&quot;g_config&quot;</span>, <span class="stringliteral">&quot;@Config&quot;</span>, &amp;local_config, reg);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Modify and write the struct back to the library.</span></div>
<div class="line"><a class="code hl_struct" href="structConfig.html">Config</a> new_config = { <span class="stringliteral">&quot;updated&quot;</span>, 2 };</div>
<div class="line"><a class="code hl_function" href="group__exports__api.html#ga02212862110c752548fbdc0b3ba65bec">infix_write_global</a>(lib, <span class="stringliteral">&quot;g_config&quot;</span>, <span class="stringliteral">&quot;@Config&quot;</span>, &amp;new_config, reg);</div>
<div class="ttc" id="astructConfig_html"><div class="ttname"><a href="structConfig.html">Config</a></div><div class="ttdef"><b>Definition</b> Ch06_Rec02_GlobalVariables.c:15</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch06_Rec02_GlobalVariables.c"><code>Ch06_Rec02_GlobalVariables.c</code></a> and library source in <a href="/eg/cookbook/libs/libglobals.c"><code>libs/libglobals.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md94"></a>
Recipe: Handling Library Dependencies</h2>
<p><b>Problem:</b> You want to load a library (<code>libA</code>) that itself depends on another shared library (<code>libB</code>).</p>
<p><b>Solution:</b> You don't have to do anything special. On all modern operating systems, the dynamic linker will automatically find, load, and link <code>libB</code> when you load <code>libA</code>.</p>
<div class="fragment"><div class="line"><span class="comment">// We only need to open libA. The OS will handle loading libB.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__library__t.html">infix_library_t</a>* lib = <a class="code hl_function" href="group__exports__api.html#gabfd1bb148a39b758e57e772c09b9ea84">infix_library_open</a>(<span class="stringliteral">&quot;./libA.so&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span>* p_entry = <a class="code hl_function" href="group__exports__api.html#ga227480098fa596f3c372837461a6b805">infix_library_get_symbol</a>(lib, <span class="stringliteral">&quot;entry_point_a&quot;</span>);</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, <span class="stringliteral">&quot;()-&gt;int&quot;</span>, p_entry, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> result;</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;result, NULL);</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch06_Rec03_LibraryDependencies.c"><code>Ch06_Rec03_LibraryDependencies.c</code></a> and library sources in <a href="/eg/cookbook/libs/libA.c"><code>libs/libA.c</code></a> and <a href="/eg/cookbook/libs/libB.c"><code>libs/libB.c</code></a>. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md95"></a>
&lt;/blockquote&gt;</h1>
<h1><a class="anchor" id="autotoc_md96"></a>
Chapter 7: Introspection for Data Marshalling</h1>
<h2><a class="anchor" id="autotoc_md97"></a>
Recipe: Dynamic Struct Marshalling with the Signature Parser</h2>
<p><b>Problem</b>: You have data from a dynamic source (like a script) and need to pack it into a C <code>struct</code> layout at runtime.</p>
<p><b>Solution</b>: Use <code>infix_type_from_signature</code> to parse a signature into a detailed <code>infix_type</code> graph. This graph contains all the <code>size</code>, <code>alignment</code>, and member <code>offset</code> information needed to correctly write data into a C-compatible memory buffer.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="Ch07__Rec01__DynamicMarshalling_8c.html#a7ecb6d61c8031fc708ebf1f8d16d4582">marshal_ordered_data</a>(<span class="keywordtype">void</span>* dest, <span class="keyword">const</span> <span class="keywordtype">char</span>* sig, <span class="keywordtype">void</span>** src) {</div>
<div class="line">    <span class="comment">// 1. Parse the signature to get the struct&#39;s layout information.</span></div>
<div class="line">    <a class="code hl_struct" href="structinfix__type__t.html">infix_type</a>* type = NULL;</div>
<div class="line">    <a class="code hl_struct" href="structinfix__arena__t.html">infix_arena_t</a>* <a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a> = NULL;</div>
<div class="line">    <a class="code hl_function" href="group__high__level__api.html#ga3632147d55b80e520987d37722ddcf61">infix_type_from_signature</a>(&amp;type, &amp;<a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a>, sig, NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. Iterate through the struct&#39;s members.</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; <a class="code hl_function" href="group__type__system.html#ga678390feeed80a43111725c4e73c0dda">infix_type_get_member_count</a>(type); ++i) {</div>
<div class="line">        <span class="keyword">const</span> <a class="code hl_struct" href="structinfix__struct__member__t.html">infix_struct_member</a>* member = <a class="code hl_function" href="group__type__system.html#gafc256d548bfd78ff90ee38a1cc0ae8b9">infix_type_get_member</a>(type, i);</div>
<div class="line">        <span class="comment">// 3. Use the offset and size to copy data into the correct location.</span></div>
<div class="line">        memcpy((<span class="keywordtype">char</span>*)dest + member-&gt;<a class="code hl_variable" href="group__high__level__api.html#gabc9fb3780626694111f4c8c74700a9b9">offset</a>, src[i], <a class="code hl_function" href="group__type__system.html#ga0e49d4bdbfe42b661bf7bcb597793e9a">infix_type_get_size</a>(member-&gt;<a class="code hl_variable" href="group__high__level__api.html#gaa89e6621da98f5115dcc807599c4ac77">type</a>));</div>
<div class="line">    }</div>
<div class="line">    <a class="code hl_function" href="group__memory__management.html#ga50b7219c58789fc03898690254f0280e">infix_arena_destroy</a>(<a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a>);</div>
<div class="line">}</div>
<div class="ttc" id="aCh07__Rec01__DynamicMarshalling_8c_html_a7ecb6d61c8031fc708ebf1f8d16d4582"><div class="ttname"><a href="Ch07__Rec01__DynamicMarshalling_8c.html#a7ecb6d61c8031fc708ebf1f8d16d4582">marshal_ordered_data</a></div><div class="ttdeci">static void marshal_ordered_data(void *dest, const char *sig, void **src)</div><div class="ttdoc">A generic marshalling function that packs data into a struct.</div><div class="ttdef"><b>Definition</b> Ch07_Rec01_DynamicMarshalling.c:33</div></div>
<div class="ttc" id="agroup__high__level__api_html_ga3632147d55b80e520987d37722ddcf61"><div class="ttname"><a href="group__high__level__api.html#ga3632147d55b80e520987d37722ddcf61">infix_type_from_signature</a></div><div class="ttdeci">c23_nodiscard infix_status infix_type_from_signature(infix_type **, infix_arena_t **, const char *, infix_registry_t *)</div><div class="ttdoc">Parses a signature string representing a single data type.</div><div class="ttdef"><b>Definition</b> signature.c:1026</div></div>
<div class="ttc" id="agroup__high__level__api_html_gaa89e6621da98f5115dcc807599c4ac77"><div class="ttname"><a href="group__high__level__api.html#gaa89e6621da98f5115dcc807599c4ac77">infix_struct_member_t::type</a></div><div class="ttdeci">infix_type * type</div><div class="ttdef"><b>Definition</b> infix.h:278</div></div>
<div class="ttc" id="agroup__high__level__api_html_gabc9fb3780626694111f4c8c74700a9b9"><div class="ttname"><a href="group__high__level__api.html#gabc9fb3780626694111f4c8c74700a9b9">infix_struct_member_t::offset</a></div><div class="ttdeci">size_t offset</div><div class="ttdef"><b>Definition</b> infix.h:279</div></div>
<div class="ttc" id="agroup__memory__management_html_ga50b7219c58789fc03898690254f0280e"><div class="ttname"><a href="group__memory__management.html#ga50b7219c58789fc03898690254f0280e">infix_arena_destroy</a></div><div class="ttdeci">void infix_arena_destroy(infix_arena_t *)</div><div class="ttdoc">Destroys an arena and frees all memory allocated from it.</div><div class="ttdef"><b>Definition</b> arena.c:88</div></div>
<div class="ttc" id="agroup__type__system_html_ga0e49d4bdbfe42b661bf7bcb597793e9a"><div class="ttname"><a href="group__type__system.html#ga0e49d4bdbfe42b661bf7bcb597793e9a">infix_type_get_size</a></div><div class="ttdeci">c23_nodiscard size_t infix_type_get_size(const infix_type *)</div><div class="ttdoc">Gets the size of a type in bytes.</div><div class="ttdef"><b>Definition</b> types.c:1082</div></div>
<div class="ttc" id="agroup__type__system_html_ga678390feeed80a43111725c4e73c0dda"><div class="ttname"><a href="group__type__system.html#ga678390feeed80a43111725c4e73c0dda">infix_type_get_member_count</a></div><div class="ttdeci">c23_nodiscard size_t infix_type_get_member_count(const infix_type *)</div><div class="ttdoc">Gets the number of members in a struct or union type.</div><div class="ttdef"><b>Definition</b> types.c:1097</div></div>
<div class="ttc" id="agroup__type__system_html_gafc256d548bfd78ff90ee38a1cc0ae8b9"><div class="ttname"><a href="group__type__system.html#gafc256d548bfd78ff90ee38a1cc0ae8b9">infix_type_get_member</a></div><div class="ttdeci">c23_nodiscard const infix_struct_member * infix_type_get_member(const infix_type *, size_t)</div><div class="ttdoc">Gets a specific member from a struct or union type.</div><div class="ttdef"><b>Definition</b> types.c:1109</div></div>
<div class="ttc" id="astructinfix__arena__t_html"><div class="ttname"><a href="structinfix__arena__t.html">infix_arena_t</a></div><div class="ttdoc">Internal definition of a memory arena.</div><div class="ttdef"><b>Definition</b> infix_internals.h:144</div></div>
<div class="ttc" id="astructinfix__struct__member__t_html"><div class="ttname"><a href="structinfix__struct__member__t.html">infix_struct_member_t</a></div><div class="ttdoc">Describes a single member of a C struct or union.</div><div class="ttdef"><b>Definition</b> infix.h:276</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch07_Rec01_DynamicMarshalling.c"><code>Ch07_Rec01_DynamicMarshalling.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md98"></a>
Recipe: Building a Signature String at Runtime</h2>
<p><b>Problem</b>: The structure of the data you need to work with isn't known until runtime (e.g., it's defined in a configuration file or a user script).</p>
<p><b>Solution</b>: Since <code>infix</code> signatures are just strings, you can build them dynamically using <code>snprintf</code>. You can then parse this dynamic signature to get layout information, which is perfect for data marshalling or dynamic RPC systems.</p>
<div class="fragment"><div class="line"><span class="comment">// Imagine this data comes from a config file</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* user_defined_fields[] = { <span class="stringliteral">&quot;int&quot;</span>, <span class="stringliteral">&quot;int&quot;</span>, <span class="stringliteral">&quot;double&quot;</span> };</div>
<div class="line"><span class="keywordtype">int</span> num_fields = 3;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">char</span> signature_buffer[256] = <span class="stringliteral">&quot;{&quot;</span>;</div>
<div class="line"><span class="comment">// 1. Build the signature string dynamically.</span></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_fields; ++i) {</div>
<div class="line">    strcat(signature_buffer, user_defined_fields[i]);</div>
<div class="line">    <span class="keywordflow">if</span> (i &lt; num_fields - 1) strcat(signature_buffer, <span class="stringliteral">&quot;,&quot;</span>);</div>
<div class="line">}</div>
<div class="line">strcat(signature_buffer, <span class="stringliteral">&quot;}&quot;</span>); <span class="comment">// Final string is &quot;{int,int,double}&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Use the dynamic signature to get layout information.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__type__t.html">infix_type</a>* dynamic_type = NULL;</div>
<div class="line"><a class="code hl_struct" href="structinfix__arena__t.html">infix_arena_t</a>* <a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a> = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga3632147d55b80e520987d37722ddcf61">infix_type_from_signature</a>(&amp;dynamic_type, &amp;<a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a>, signature_buffer, NULL);</div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch07_Rec02_DynamicSignatures.c"><code>Ch07_Rec02_DynamicSignatures.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md99"></a>
Recipe: Introspecting a Trampoline for a Wrapper</h2>
<p><b>Problem</b>: You are building a language binding and need to validate the number and types of arguments provided by the user before making an FFI call.</p>
<p><b>Solution</b>: Use the trampoline introspection API to query the signature information stored in the handle.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="Ch07__Rec03__IntrospectWrapper_8c.html#a05da45c28528a878b819bc1aeb67d460">dynamic_wrapper</a>(<a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* trampoline, <span class="keywordtype">void</span>* target_func, <span class="keywordtype">void</span>** <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>, <span class="keywordtype">size_t</span> num_provided_args) {</div>
<div class="line">    <span class="comment">// 1. Introspect the trampoline to get expected argument count.</span></div>
<div class="line">    <span class="keywordtype">size_t</span> num_expected_args = <a class="code hl_function" href="group__introspection__api.html#ga7b7e73aa032acb4185433f40720ec126">infix_forward_get_num_args</a>(trampoline);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (num_provided_args != num_expected_args) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error: Incorrect number of arguments...\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// A real binding would also check the types using infix_forward_get_arg_type().</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. Make the call.</span></div>
<div class="line">    <a class="code hl_typedef" href="group__high__level__api.html#ga48f7ee868576f525269902fc953887bd">infix_unbound_cif_func</a> cif = <a class="code hl_function" href="group__introspection__api.html#ga5f3559908e6a7bcc72103c52937d67ad">infix_forward_get_unbound_code</a>(trampoline);</div>
<div class="line">    cif(target_func, NULL, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="line">}</div>
<div class="ttc" id="aCh07__Rec03__IntrospectWrapper_8c_html_a05da45c28528a878b819bc1aeb67d460"><div class="ttname"><a href="Ch07__Rec03__IntrospectWrapper_8c.html#a05da45c28528a878b819bc1aeb67d460">dynamic_wrapper</a></div><div class="ttdeci">static bool dynamic_wrapper(infix_forward_t *trampoline, void *target_func, void **args, size_t num_provided_args, void *ret_buffer)</div><div class="ttdoc">A conceptual generic &quot;wrapper&quot; function for an unbound trampoline.</div><div class="ttdef"><b>Definition</b> Ch07_Rec03_IntrospectWrapper.c:29</div></div>
<div class="ttc" id="agroup__high__level__api_html_ga48f7ee868576f525269902fc953887bd"><div class="ttname"><a href="group__high__level__api.html#ga48f7ee868576f525269902fc953887bd">infix_unbound_cif_func</a></div><div class="ttdeci">void(* infix_unbound_cif_func)(void *, void *, void **)</div><div class="ttdoc">A function pointer type for an unbound forward trampoline.</div><div class="ttdef"><b>Definition</b> infix.h:360</div></div>
<div class="ttc" id="agroup__introspection__api_html_ga7b7e73aa032acb4185433f40720ec126"><div class="ttname"><a href="group__introspection__api.html#ga7b7e73aa032acb4185433f40720ec126">infix_forward_get_num_args</a></div><div class="ttdeci">c23_nodiscard size_t infix_forward_get_num_args(const infix_forward_t *)</div><div class="ttdoc">Gets the total number of arguments for a forward trampoline.</div><div class="ttdef"><b>Definition</b> types.c:1148</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch07_Rec03_IntrospectWrapper.c"><code>Ch07_Rec03_IntrospectWrapper.c</code></a>. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md100"></a>
&lt;/blockquote&gt;</h1>
<h1><a class="anchor" id="autotoc_md101"></a>
Chapter 8: Performance &amp; Memory Management</h1>
<h2><a class="anchor" id="autotoc_md102"></a>
Best Practice: Caching Trampolines</h2>
<p><b>Rule</b>: <b>NEVER</b> generate a new trampoline for the same function signature inside a hot loop. The performance of <code>infix</code> comes from amortizing the one-time generation cost over many fast calls.</p>
<div class="fragment"><div class="line"><span class="comment">// FAST: Create once, call many times</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, <span class="stringliteral">&quot;(int, int) -&gt; int&quot;</span>, my_func, NULL);</div>
<div class="line"><a class="code hl_typedef" href="group__high__level__api.html#ga3042690c20cccd4137f134154bd62e1a">infix_cif_func</a> cif = <a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t);</div>
<div class="line"><span class="keywordtype">int</span> result;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { <span class="comment">/* ... */</span> };</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 1000000; ++i) {</div>
<div class="line">    cif(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>); <span class="comment">// VERY FAST</span></div>
<div class="line">}</div>
<div class="line"><a class="code hl_function" href="group__manual__api.html#gad87a8882dec00b89a4bc5c87db2fc032">infix_forward_destroy</a>(t);</div>
<div class="ttc" id="agroup__high__level__api_html_ga3042690c20cccd4137f134154bd62e1a"><div class="ttname"><a href="group__high__level__api.html#ga3042690c20cccd4137f134154bd62e1a">infix_cif_func</a></div><div class="ttdeci">void(* infix_cif_func)(void *, void **)</div><div class="ttdoc">A function pointer type for a bound forward trampoline.</div><div class="ttdef"><b>Definition</b> infix.h:370</div></div>
<div class="ttc" id="agroup__manual__api_html_gad87a8882dec00b89a4bc5c87db2fc032"><div class="ttname"><a href="group__manual__api.html#gad87a8882dec00b89a4bc5c87db2fc032">infix_forward_destroy</a></div><div class="ttdeci">void infix_forward_destroy(infix_forward_t *)</div><div class="ttdoc">Destroys a forward trampoline and frees all associated memory.</div><div class="ttdef"><b>Definition</b> trampoline.c:515</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md103"></a>
Recipe: Using a Custom Arena for a Group of Types</h2>
<p><b>Goal:</b> Create a set of related <code>infix_type</code> objects for the Manual API and free them all at once.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> recipe_custom_arena() {</div>
<div class="line">    <a class="code hl_struct" href="structinfix__arena__t.html">infix_arena_t</a>* <a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a> = <a class="code hl_function" href="group__memory__management.html#gae39ca61ea3637aee7e87c1b41188c733">infix_arena_create</a>(8192);</div>
<div class="line">    <a class="code hl_struct" href="structinfix__type__t.html">infix_type</a>* int_type = <a class="code hl_function" href="group__type__system.html#gae323d599fbc081976a99a1e3b726a0b8">infix_type_create_primitive</a>(<a class="code hl_enumvalue" href="group__type__system.html#gga2cd7b00c1f2606249654a8e8b7cbc044a449724cf88949d38538312535be9ce6f">INFIX_PRIMITIVE_SINT32</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_struct" href="structinfix__type__t.html">infix_type</a>* int_array_type = NULL;</div>
<div class="line">    <a class="code hl_function" href="group__type__system.html#ga9f0d8a41015262d2dcffc97cf5f87772">infix_type_create_array</a>(<a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a>, &amp;int_array_type, int_type, 100);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ... use these types with `infix_forward_create_manual` ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// A single call to destroy the arena cleans up everything allocated from it.</span></div>
<div class="line">    <a class="code hl_function" href="group__memory__management.html#ga50b7219c58789fc03898690254f0280e">infix_arena_destroy</a>(<a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a>);</div>
<div class="line">}</div>
<div class="ttc" id="agroup__memory__management_html_gae39ca61ea3637aee7e87c1b41188c733"><div class="ttname"><a href="group__memory__management.html#gae39ca61ea3637aee7e87c1b41188c733">infix_arena_create</a></div><div class="ttdeci">c23_nodiscard infix_arena_t * infix_arena_create(size_t)</div><div class="ttdoc">Creates a new memory arena.</div><div class="ttdef"><b>Definition</b> arena.c:55</div></div>
<div class="ttc" id="agroup__type__system_html_ga9f0d8a41015262d2dcffc97cf5f87772"><div class="ttname"><a href="group__type__system.html#ga9f0d8a41015262d2dcffc97cf5f87772">infix_type_create_array</a></div><div class="ttdeci">c23_nodiscard infix_status infix_type_create_array(infix_arena_t *, infix_type **, infix_type *, size_t)</div><div class="ttdoc">Creates a new fixed-size array type.</div><div class="ttdef"><b>Definition</b> types.c:291</div></div>
<div class="ttc" id="agroup__type__system_html_gae323d599fbc081976a99a1e3b726a0b8"><div class="ttname"><a href="group__type__system.html#gae323d599fbc081976a99a1e3b726a0b8">infix_type_create_primitive</a></div><div class="ttdeci">c23_nodiscard infix_type * infix_type_create_primitive(infix_primitive_type_id)</div><div class="ttdoc">Creates a static descriptor for a primitive C type.</div><div class="ttdef"><b>Definition</b> types.c:130</div></div>
<div class="ttc" id="agroup__type__system_html_gga2cd7b00c1f2606249654a8e8b7cbc044a449724cf88949d38538312535be9ce6f"><div class="ttname"><a href="group__type__system.html#gga2cd7b00c1f2606249654a8e8b7cbc044a449724cf88949d38538312535be9ce6f">INFIX_PRIMITIVE_SINT32</a></div><div class="ttdeci">@ INFIX_PRIMITIVE_SINT32</div><div class="ttdef"><b>Definition</b> infix.h:186</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md104"></a>
Recipe: The Full Manual API Lifecycle (Types to Trampoline)</h2>
<p><b>Problem</b>: You want to create a trampoline without using the signature parser, for maximum performance or because your type information is already structured in C.</p>
<p><b>Solution</b>: Use an arena to build your <code>infix_type</code> objects and then pass them directly to the <code>_manual</code> variant of the creation functions.</p>
<div class="fragment"><div class="line"><span class="comment">// 1. Create an arena to hold all our type definitions.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__arena__t.html">infix_arena_t</a>* <a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a> = <a class="code hl_function" href="group__memory__management.html#gae39ca61ea3637aee7e87c1b41188c733">infix_arena_create</a>(4096);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Manually define the &#39;Point&#39; struct type.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__struct__member__t.html">infix_struct_member</a> point_members[] = {</div>
<div class="line">    <a class="code hl_function" href="group__type__system.html#gaed99b57de2c839a66eb54c9e82d703d9">infix_type_create_member</a>(<span class="stringliteral">&quot;x&quot;</span>, <a class="code hl_function" href="group__type__system.html#gae323d599fbc081976a99a1e3b726a0b8">infix_type_create_primitive</a>(<a class="code hl_enumvalue" href="group__type__system.html#gga2cd7b00c1f2606249654a8e8b7cbc044a164ca591153f83361c4ea8dd2a5c57f3">INFIX_PRIMITIVE_DOUBLE</a>), offsetof(<a class="code hl_struct" href="structPoint.html">Point</a>, x)),</div>
<div class="line">    <a class="code hl_function" href="group__type__system.html#gaed99b57de2c839a66eb54c9e82d703d9">infix_type_create_member</a>(<span class="stringliteral">&quot;y&quot;</span>, <a class="code hl_function" href="group__type__system.html#gae323d599fbc081976a99a1e3b726a0b8">infix_type_create_primitive</a>(<a class="code hl_enumvalue" href="group__type__system.html#gga2cd7b00c1f2606249654a8e8b7cbc044a164ca591153f83361c4ea8dd2a5c57f3">INFIX_PRIMITIVE_DOUBLE</a>), offsetof(<a class="code hl_struct" href="structPoint.html">Point</a>, y))</div>
<div class="line">};</div>
<div class="line"><a class="code hl_struct" href="structinfix__type__t.html">infix_type</a>* point_type = NULL;</div>
<div class="line"><a class="code hl_function" href="group__type__system.html#gac80d3ec096ade5b991048b61fecfe7b2">infix_type_create_struct</a>(<a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a>, &amp;point_type, point_members, 2);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Define the argument types for the function.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__type__t.html">infix_type</a>* <a class="code hl_variable" href="901__call__overhead_8c.html#a5ee7905532888ac403e1bf46e306b3ce">arg_types</a>[] = { point_type, <a class="code hl_function" href="group__type__system.html#gae323d599fbc081976a99a1e3b726a0b8">infix_type_create_primitive</a>(<a class="code hl_enumvalue" href="group__type__system.html#gga2cd7b00c1f2606249654a8e8b7cbc044a164ca591153f83361c4ea8dd2a5c57f3">INFIX_PRIMITIVE_DOUBLE</a>) };</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 4. Create the trampoline using the manually created types.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* trampoline = NULL;</div>
<div class="line"><a class="code hl_function" href="group__manual__api.html#ga017f14762b217bc6d0101e994481bfd0">infix_forward_create_manual</a>(&amp;trampoline, point_type, <a class="code hl_variable" href="901__call__overhead_8c.html#a5ee7905532888ac403e1bf46e306b3ce">arg_types</a>, 2, 2, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="006__end__to__end__calls_8c.html#aea24499a6ed5a50c5a6e5634bf9e449a">move_point</a>);</div>
<div class="ttc" id="a901__call__overhead_8c_html_a5ee7905532888ac403e1bf46e306b3ce"><div class="ttname"><a href="901__call__overhead_8c.html#a5ee7905532888ac403e1bf46e306b3ce">arg_types</a></div><div class="ttdeci">infix_type * arg_types[]</div><div class="ttdef"><b>Definition</b> 901_call_overhead.c:67</div></div>
<div class="ttc" id="agroup__manual__api_html_ga017f14762b217bc6d0101e994481bfd0"><div class="ttname"><a href="group__manual__api.html#ga017f14762b217bc6d0101e994481bfd0">infix_forward_create_manual</a></div><div class="ttdeci">c23_nodiscard infix_status infix_forward_create_manual(infix_forward_t **, infix_type *, infix_type **, size_t, size_t, void *)</div><div class="ttdoc">Creates a bound forward trampoline from infix_type objects.</div><div class="ttdef"><b>Definition</b> trampoline.c:472</div></div>
<div class="ttc" id="agroup__type__system_html_gac80d3ec096ade5b991048b61fecfe7b2"><div class="ttname"><a href="group__type__system.html#gac80d3ec096ade5b991048b61fecfe7b2">infix_type_create_struct</a></div><div class="ttdeci">c23_nodiscard infix_status infix_type_create_struct(infix_arena_t *, infix_type **, infix_struct_member *, size_t)</div><div class="ttdoc">Creates a new struct type from an array of members, calculating layout automatically.</div><div class="ttdef"><b>Definition</b> types.c:482</div></div>
<div class="ttc" id="agroup__type__system_html_gaed99b57de2c839a66eb54c9e82d703d9"><div class="ttname"><a href="group__type__system.html#gaed99b57de2c839a66eb54c9e82d703d9">infix_type_create_member</a></div><div class="ttdeci">infix_struct_member infix_type_create_member(const char *, infix_type *, size_t)</div><div class="ttdoc">A factory function to create an infix_struct_member.</div><div class="ttdef"><b>Definition</b> types.c:194</div></div>
<div class="ttc" id="agroup__type__system_html_gga2cd7b00c1f2606249654a8e8b7cbc044a164ca591153f83361c4ea8dd2a5c57f3"><div class="ttname"><a href="group__type__system.html#gga2cd7b00c1f2606249654a8e8b7cbc044a164ca591153f83361c4ea8dd2a5c57f3">INFIX_PRIMITIVE_DOUBLE</a></div><div class="ttdeci">@ INFIX_PRIMITIVE_DOUBLE</div><div class="ttdef"><b>Definition</b> infix.h:192</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch08_Rec02_ManualAPI.c"><code>Ch08_Rec02_ManualAPI.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md105"></a>
Recipe: Using Custom Memory Allocators</h2>
<p><b>Problem</b>: Your application uses a custom memory manager for tracking, pooling, or integration with a garbage collector. You need <code>infix</code> to use your allocators instead of the standard <code>malloc</code>, <code>calloc</code>, etc.</p>
<p><b>Solution</b>: <code>infix</code> provides override macros (<code>infix_malloc</code>, <code>infix_free</code>, etc.). Define these macros <em>before</em> you include <code><a class="el" href="infix_8h.html" title="The public interface for the infix FFI library.">infix.h</a></code> to redirect all of its internal memory operations.</p>
<div class="fragment"><div class="line"><span class="comment">// 1. Define your custom memory management functions.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>* <a class="code hl_function" href="Ch08__Rec01__CustomAllocators_8c.html#a7f9778663fceaf2806c58dd775a7e5d4">tracking_malloc</a>(<span class="keywordtype">size_t</span> size) { <span class="comment">/* ... */</span> }</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="Ch08__Rec01__CustomAllocators_8c.html#a18190c05a9c59a758302be7ad6791e14">tracking_free</a>(<span class="keywordtype">void</span>* ptr) { <span class="comment">/* ... */</span> }</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Define the infix override macros BEFORE including infix.h</span></div>
<div class="line"><span class="preprocessor">#define infix_malloc(size) tracking_malloc(size)</span></div>
<div class="line"><span class="preprocessor">#define infix_free(ptr)    tracking_free(ptr)</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="infix_8h.html">infix/infix.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Now, all calls like infix_forward_create will use your allocators.</span></div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;trampoline, <span class="stringliteral">&quot;()-&gt;void&quot;</span>, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="851__lifecycle__regression_8c.html#a7cd80dbbd87c6584bcacc80fb5b2084a">dummy_func</a>, NULL);</div>
<div class="ttc" id="a851__lifecycle__regression_8c_html_a7cd80dbbd87c6584bcacc80fb5b2084a"><div class="ttname"><a href="851__lifecycle__regression_8c.html#a7cd80dbbd87c6584bcacc80fb5b2084a">dummy_func</a></div><div class="ttdeci">void dummy_func()</div><div class="ttdef"><b>Definition</b> 851_lifecycle_regression.c:33</div></div>
<div class="ttc" id="aCh08__Rec01__CustomAllocators_8c_html_a18190c05a9c59a758302be7ad6791e14"><div class="ttname"><a href="Ch08__Rec01__CustomAllocators_8c.html#a18190c05a9c59a758302be7ad6791e14">tracking_free</a></div><div class="ttdeci">static void tracking_free(void *ptr)</div><div class="ttdef"><b>Definition</b> Ch08_Rec01_CustomAllocators.c:26</div></div>
<div class="ttc" id="aCh08__Rec01__CustomAllocators_8c_html_a7f9778663fceaf2806c58dd775a7e5d4"><div class="ttname"><a href="Ch08__Rec01__CustomAllocators_8c.html#a7f9778663fceaf2806c58dd775a7e5d4">tracking_malloc</a></div><div class="ttdeci">static void * tracking_malloc(size_t size)</div><div class="ttdef"><b>Definition</b> Ch08_Rec01_CustomAllocators.c:20</div></div>
<div class="ttc" id="ainfix_8h_html"><div class="ttname"><a href="infix_8h.html">infix.h</a></div><div class="ttdoc">The public interface for the infix FFI library.</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch08_Rec01_CustomAllocators.c"><code>Ch08_Rec01_CustomAllocators.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md106"></a>
Recipe: Building a Dynamic Call Frame with an Arena</h2>
<p><b>Problem</b>: You are writing a language binding (e.g., for Python, Perl, Lua) and need to build the <code>void* args[]</code> array at runtime. The arguments are coming from the host language, so you need to unbox them into temporary C values, create an array of pointers to these temporary values, and then clean everything up after the call. Doing this with <code>malloc</code> for every call in a tight loop is inefficient.</p>
<p><b>Solution</b>: Use an <code>infix</code> arena to allocate memory for both the unboxed C values <em>and</em> the <code>void**</code> array that points to them. This makes the entire call frame a single, contiguous block of memory that can be allocated and freed with extreme efficiency.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="Ch08__Rec03__ArenaCallFrame_8c.html#a73494424b20107b9d3b6bc4fa3cedb0c">dynamic_ffi_call</a>(<a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* trampoline, ...) {</div>
<div class="line">    <span class="comment">// 1. Create a temporary arena for this call&#39;s entire data frame.</span></div>
<div class="line">    <a class="code hl_struct" href="structinfix__arena__t.html">infix_arena_t</a>* call_arena = <a class="code hl_function" href="group__memory__management.html#gae39ca61ea3637aee7e87c1b41188c733">infix_arena_create</a>(4096);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. Allocate the void** array itself from the arena.</span></div>
<div class="line">    <span class="keywordtype">void</span>** <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a> = <a class="code hl_function" href="group__memory__management.html#gabb32fed25010a3111812c8dfacd4cf40">infix_arena_alloc</a>(call_arena, <span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*) * arg_count, _Alignof(<span class="keywordtype">void</span>*));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 3. For each argument, allocate space for its C value in the arena and set the pointer.</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; arg_count; ++i) {</div>
<div class="line">        <span class="keywordtype">int</span>* val_ptr = <a class="code hl_function" href="group__memory__management.html#gabb32fed25010a3111812c8dfacd4cf40">infix_arena_alloc</a>(call_arena, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), _Alignof(<span class="keywordtype">int</span>));</div>
<div class="line">        *val_ptr = va_arg(va, <span class="keywordtype">int</span>); <span class="comment">// Get value from dynamic source</span></div>
<div class="line">        <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[i] = val_ptr;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 4. Make the FFI call.</span></div>
<div class="line">    <a class="code hl_function" href="group__introspection__api.html#ga5f3559908e6a7bcc72103c52937d67ad">infix_forward_get_unbound_code</a>(trampoline)(target_func, NULL, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 5. A single free cleans up the void** array AND all the argument values.</span></div>
<div class="line">    <a class="code hl_function" href="group__memory__management.html#ga50b7219c58789fc03898690254f0280e">infix_arena_destroy</a>(call_arena);</div>
<div class="line">}</div>
<div class="ttc" id="aCh08__Rec03__ArenaCallFrame_8c_html_a73494424b20107b9d3b6bc4fa3cedb0c"><div class="ttname"><a href="Ch08__Rec03__ArenaCallFrame_8c.html#a73494424b20107b9d3b6bc4fa3cedb0c">dynamic_ffi_call</a></div><div class="ttdeci">static void dynamic_ffi_call(infix_forward_t *trampoline, void *target_func, int arg_count,...)</div><div class="ttdef"><b>Definition</b> Ch08_Rec03_ArenaCallFrame.c:31</div></div>
<div class="ttc" id="agroup__memory__management_html_gabb32fed25010a3111812c8dfacd4cf40"><div class="ttname"><a href="group__memory__management.html#gabb32fed25010a3111812c8dfacd4cf40">infix_arena_alloc</a></div><div class="ttdeci">c23_nodiscard void * infix_arena_alloc(infix_arena_t *, size_t, size_t)</div><div class="ttdoc">Allocates a block of memory from an arena.</div><div class="ttdef"><b>Definition</b> arena.c:119</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch08_Rec03_ArenaCallFrame.c"><code>Ch08_Rec03_ArenaCallFrame.c</code></a>. </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md107"></a>
How It Works &amp; Why It's Better</h3>
<ol type="1">
<li><b>Unified Allocation</b>: Instead of multiple calls to <code>malloc</code> (one for the <code>args</code> array, one for the <code>int</code>, one for the <code>double</code>, etc.), all memory is sourced from a single arena.</li>
<li><b>Performance</b>: The allocations within the arena are extremely fast "bump" allocations, which is significantly cheaper than heap allocation, especially for many small objects.</li>
<li><b>Simplified Cleanup</b>: All temporary data for the call—the <code>void**</code> array and the unboxed C values—lives in the arena. A single call to <code>infix_arena_destroy</code> cleans everything up instantly, eliminating the risk of memory leaks from forgetting to <code>free</code> one of the many small allocations.</li>
</ol>
<h3><a class="anchor" id="autotoc_md108"></a>
Advanced Optimization: Arena Resetting for Hot Loops</h3>
<p>For a binding that needs to make many FFI calls in a tight loop, you can achieve even higher performance by creating the arena <em>once</em> outside the loop and "resetting" it on each iteration. Since <code><a class="el" href="structinfix__arena__t.html" title="Internal definition of a memory arena.">infix_arena_t</a></code> is not an opaque type, you can do this manually:</p>
<div class="fragment"><div class="line"><span class="comment">// Inside a hypothetical binding&#39;s loop...</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__arena__t.html">infix_arena_t</a>* loop_arena = <a class="code hl_function" href="group__memory__management.html#gae39ca61ea3637aee7e87c1b41188c733">infix_arena_create</a>(65536);</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 1000; ++i) {</div>
<div class="line">    <span class="comment">// Before building the args, save the current allocation point.</span></div>
<div class="line">    <span class="keywordtype">size_t</span> arena_state = loop_arena-&gt;<a class="code hl_variable" href="structinfix__arena__t.html#ac06321238d0579d5b548c58a68eaf036">current_offset</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ... build the void** args and argument values from the arena ...</span></div>
<div class="line">    <span class="comment">// ... make the FFI call ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Instead of destroying the arena, just reset the offset.</span></div>
<div class="line">    <span class="comment">// This is virtually free and avoids all allocation/deallocation overhead inside the loop.</span></div>
<div class="line">    loop_arena-&gt;<a class="code hl_variable" href="structinfix__arena__t.html#ac06321238d0579d5b548c58a68eaf036">current_offset</a> = arena_state;</div>
<div class="line">}</div>
<div class="line"><a class="code hl_function" href="group__memory__management.html#ga50b7219c58789fc03898690254f0280e">infix_arena_destroy</a>(loop_arena);</div>
<div class="ttc" id="astructinfix__arena__t_html_ac06321238d0579d5b548c58a68eaf036"><div class="ttname"><a href="structinfix__arena__t.html#ac06321238d0579d5b548c58a68eaf036">infix_arena_t::current_offset</a></div><div class="ttdeci">size_t current_offset</div><div class="ttdef"><b>Definition</b> infix_internals.h:147</div></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md110"></a>
Chapter 9: Common Pitfalls &amp; Troubleshooting</h1>
<h2><a class="anchor" id="autotoc_md111"></a>
Recipe: Advanced Error Reporting for the Parser</h2>
<p><b>Problem</b>: A user provides an invalid signature string, and you want to give them a helpful error message indicating exactly where the syntax error occurred.</p>
<p><b>Solution</b>: After a parsing function fails, call <code><a class="el" href="group__error__api.html#gaeee66e7ba26a8f8dea16d441200d147b" title="Retrieves detailed information about the last error that occurred on the current thread.">infix_get_last_error()</a></code> and use the <code>position</code>, <code>code</code>, and <code>message</code> fields to generate a detailed diagnostic.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="Ch09__Rec01__ErrorReporting_8c.html#a1c2de9e778ecea9c22ab04e96f53df3d">report_parse_error</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* signature) {</div>
<div class="line">    <a class="code hl_struct" href="structinfix__type__t.html">infix_type</a>* type = NULL;</div>
<div class="line">    <a class="code hl_struct" href="structinfix__arena__t.html">infix_arena_t</a>* <a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a> = NULL;</div>
<div class="line">    <a class="code hl_enumeration" href="group__high__level__api.html#ga8643667be6ea1ef9269c2e46d8f11ff7">infix_status</a> <a class="code hl_variable" href="103__unions_8c.html#a433468dce2d10c4f34424732ef15ebdd">status</a> = <a class="code hl_function" href="group__high__level__api.html#ga3632147d55b80e520987d37722ddcf61">infix_type_from_signature</a>(&amp;type, &amp;<a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a>, signature, NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_variable" href="103__unions_8c.html#a433468dce2d10c4f34424732ef15ebdd">status</a> != <a class="code hl_enumvalue" href="group__high__level__api.html#gga8643667be6ea1ef9269c2e46d8f11ff7ae50c34a24362f9364b4b20ef29d259da">INFIX_SUCCESS</a>) {</div>
<div class="line">        <a class="code hl_struct" href="structinfix__error__details__t.html">infix_error_details_t</a> err = <a class="code hl_function" href="group__error__api.html#gaeee66e7ba26a8f8dea16d441200d147b">infix_get_last_error</a>();</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Failed to parse signature:\n&quot;</span>);</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;  %s\n&quot;</span>, signature);</div>
<div class="line">        <span class="comment">// Print a caret &#39;^&#39; pointing to the error location.</span></div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;  %*s^\n&quot;</span>, (<span class="keywordtype">int</span>)err.<a class="code hl_variable" href="group__high__level__api.html#ga0530e44f33e347bfcfe3b663d76ba5b7">position</a>, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error: %s (code: %d, position: %zu)\n&quot;</span>,</div>
<div class="line">                err.<a class="code hl_variable" href="group__high__level__api.html#ga37930d8440e1f4ae46571bdce41aff5d">message</a>, err.<a class="code hl_variable" href="group__high__level__api.html#gad9076024a7bb288a2a65f2fb8644c938">code</a>, err.<a class="code hl_variable" href="group__high__level__api.html#ga0530e44f33e347bfcfe3b663d76ba5b7">position</a>);</div>
<div class="line">    }</div>
<div class="line">    <a class="code hl_function" href="group__memory__management.html#ga50b7219c58789fc03898690254f0280e">infix_arena_destroy</a>(<a class="code hl_variable" href="005__layouts_8c.html#afb7c3f5e091eb15b03c0a427c1a3ad1e">arena</a>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// This signature has an invalid character &#39;^&#39; instead of a comma.</span></div>
<div class="line"><a class="code hl_function" href="Ch09__Rec01__ErrorReporting_8c.html#a1c2de9e778ecea9c22ab04e96f53df3d">report_parse_error</a>(<span class="stringliteral">&quot;{int, double, ^*char}&quot;</span>);</div>
<div class="ttc" id="a103__unions_8c_html_a433468dce2d10c4f34424732ef15ebdd"><div class="ttname"><a href="103__unions_8c.html#a433468dce2d10c4f34424732ef15ebdd">status</a></div><div class="ttdeci">infix_status status</div><div class="ttdef"><b>Definition</b> 103_unions.c:66</div></div>
<div class="ttc" id="aCh09__Rec01__ErrorReporting_8c_html_a1c2de9e778ecea9c22ab04e96f53df3d"><div class="ttname"><a href="Ch09__Rec01__ErrorReporting_8c.html#a1c2de9e778ecea9c22ab04e96f53df3d">report_parse_error</a></div><div class="ttdeci">static void report_parse_error(const char *signature)</div><div class="ttdoc">A helper function that attempts to parse a signature and reports detailed error information on failur...</div><div class="ttdef"><b>Definition</b> Ch09_Rec01_ErrorReporting.c:21</div></div>
<div class="ttc" id="agroup__error__api_html_gaeee66e7ba26a8f8dea16d441200d147b"><div class="ttname"><a href="group__error__api.html#gaeee66e7ba26a8f8dea16d441200d147b">infix_get_last_error</a></div><div class="ttdeci">infix_error_details_t infix_get_last_error(void)</div><div class="ttdoc">Retrieves detailed information about the last error that occurred on the current thread.</div><div class="ttdef"><b>Definition</b> error.c:270</div></div>
<div class="ttc" id="agroup__high__level__api_html_ga0530e44f33e347bfcfe3b663d76ba5b7"><div class="ttname"><a href="group__high__level__api.html#ga0530e44f33e347bfcfe3b663d76ba5b7">infix_error_details_t::position</a></div><div class="ttdeci">size_t position</div><div class="ttdef"><b>Definition</b> infix.h:1324</div></div>
<div class="ttc" id="agroup__high__level__api_html_ga37930d8440e1f4ae46571bdce41aff5d"><div class="ttname"><a href="group__high__level__api.html#ga37930d8440e1f4ae46571bdce41aff5d">infix_error_details_t::message</a></div><div class="ttdeci">char message[256]</div><div class="ttdef"><b>Definition</b> infix.h:1326</div></div>
<div class="ttc" id="agroup__high__level__api_html_ga8643667be6ea1ef9269c2e46d8f11ff7"><div class="ttname"><a href="group__high__level__api.html#ga8643667be6ea1ef9269c2e46d8f11ff7">infix_status</a></div><div class="ttdeci">infix_status</div><div class="ttdoc">Enumerates the possible status codes returned by infix API functions.</div><div class="ttdef"><b>Definition</b> infix.h:388</div></div>
<div class="ttc" id="agroup__high__level__api_html_gad9076024a7bb288a2a65f2fb8644c938"><div class="ttname"><a href="group__high__level__api.html#gad9076024a7bb288a2a65f2fb8644c938">infix_error_details_t::code</a></div><div class="ttdeci">infix_error_code_t code</div><div class="ttdef"><b>Definition</b> infix.h:1323</div></div>
<div class="ttc" id="agroup__high__level__api_html_gga8643667be6ea1ef9269c2e46d8f11ff7ae50c34a24362f9364b4b20ef29d259da"><div class="ttname"><a href="group__high__level__api.html#gga8643667be6ea1ef9269c2e46d8f11ff7ae50c34a24362f9364b4b20ef29d259da">INFIX_SUCCESS</a></div><div class="ttdeci">@ INFIX_SUCCESS</div><div class="ttdef"><b>Definition</b> infix.h:389</div></div>
<div class="ttc" id="astructinfix__error__details__t_html"><div class="ttname"><a href="structinfix__error__details__t.html">infix_error_details_t</a></div><div class="ttdoc">Provides detailed, thread-local information about the last error that occurred.</div><div class="ttdef"><b>Definition</b> infix.h:1321</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Full example available in <a href="/eg/cookbook/Ch09_Rec01_ErrorReporting.c"><code>Ch09_Rec01_ErrorReporting.c</code></a>. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md112"></a>
Mistake: Passing a Value Instead of a Pointer in &lt;tt&gt;args[]&lt;/tt&gt;</h2>
<ul>
<li><b>Symptom</b>: Crash or garbage data.</li>
<li><b>Explanation</b>: The <code>args</code> array for a forward call must be an array of <b>pointers to</b> your argument values, not the values themselves.</li>
</ul>
<h2><a class="anchor" id="autotoc_md113"></a>
Mistake: &lt;tt&gt;infix&lt;/tt&gt; Signature Mismatch</h2>
<ul>
<li><b>Symptom</b>: Silent data corruption, garbage values, or a crash.</li>
<li><b>Explanation</b>: The signature string must <em>exactly</em> match the C type's size and alignment. A <code>long</code> is 32 bits on 64-bit Windows but 64 bits on 64-bit Linux.</li>
<li><b>Solution</b>: Use fixed-width types (<code>int32</code>, <code>uint64</code>) whenever possible.</li>
</ul>
<h2><a class="anchor" id="autotoc_md114"></a>
Pitfall: Function Pointer Syntax</h2>
<ul>
<li><b>Symptom</b>: Parser error.</li>
<li><b>Explanation</b>: A function type is <code>(...) -&gt; ...</code>, and a pointer is <code>*...</code>. Therefore, a pointer to a function type is <code>*((...) -&gt; ...)</code>.</li>
<li><b>Solution</b>: <code>int (*callback)(void)</code> becomes <code>*(() -&gt; int)</code>.</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md116"></a>
Chapter 10: A Comparative Look: &lt;tt&gt;infix&lt;/tt&gt; vs. &lt;tt&gt;libffi&lt;/tt&gt; and &lt;tt&gt;dyncall&lt;/tt&gt;</h1>
<p>This chapter provides a practical, code-level comparison of <code>infix</code> with two other popular FFI libraries: <code>libffi</code> (the industry standard) and <code>dyncall</code>. All three are powerful tools, but they are built with different philosophies and trade-offs. We will compare them across three common FFI tasks.</p>
<h2><a class="anchor" id="autotoc_md117"></a>
Scenario 1: Calling a Simple Function</h2>
<p><b>Goal</b>: Call a simple function <code>double add_doubles(double a, double b);</code>. This demonstrates the core calling mechanism and API ergonomics.</p>
<h3><a class="anchor" id="autotoc_md118"></a>
The &lt;tt&gt;dyncall&lt;/tt&gt; Approach</h3>
<p><code>dyncall</code> uses a "call virtual machine" (VM) where arguments are pushed one-by-one. The setup cost is incurred on <b>every call</b>, making it very flexible but less performant for repeated calls to the same function.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;dyncall.h&gt;</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line">DCCallVM* vm = dcNewCallVM(4096);</div>
<div class="line"><span class="keywordtype">double</span> result;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Per-call setup and execution</span></div>
<div class="line">dcReset(vm);</div>
<div class="line">dcArgDouble(vm, 1.5);</div>
<div class="line">dcArgDouble(vm, 2.5);</div>
<div class="line">result = dcCallDouble(vm, (DCpointer)&amp;add_doubles); <span class="comment">// result is 4.0</span></div>
<div class="line"> </div>
<div class="line">dcFree(vm);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md119"></a>
The &lt;tt&gt;libffi&lt;/tt&gt; Approach</h3>
<p><code>libffi</code> requires a one-time "Call Interface" (<code>ffi_cif</code>) preparation. Subsequent calls are fast, but the initial type definition is manual and programmatic.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ffi.h&gt;</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line">ffi_cif cif;</div>
<div class="line">ffi_type* args_types[] = { &amp;ffi_type_double, &amp;ffi_type_double };</div>
<div class="line">ffi_type* <a class="code hl_variable" href="901__call__overhead_8c.html#a5f79aa6bd01b66791b7e5ee78dea11aa">ret_type</a> = &amp;ffi_type_double;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// One-time setup</span></div>
<div class="line">ffi_prep_cif(&amp;cif, FFI_DEFAULT_ABI, 2, <a class="code hl_variable" href="901__call__overhead_8c.html#a5f79aa6bd01b66791b7e5ee78dea11aa">ret_type</a>, args_types);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> a = 1.5, b = 2.5;</div>
<div class="line"><span class="keywordtype">void</span>* args_values[] = { &amp;a, &amp;b };</div>
<div class="line"><span class="keywordtype">double</span> result;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Subsequent calls are fast</span></div>
<div class="line">ffi_call(&amp;cif, FFI_FN(add_doubles), &amp;result, args_values);</div>
<div class="ttc" id="a901__call__overhead_8c_html_a5f79aa6bd01b66791b7e5ee78dea11aa"><div class="ttname"><a href="901__call__overhead_8c.html#a5f79aa6bd01b66791b7e5ee78dea11aa">ret_type</a></div><div class="ttdeci">infix_type * ret_type</div><div class="ttdef"><b>Definition</b> 901_call_overhead.c:66</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md120"></a>
The &lt;tt&gt;infix&lt;/tt&gt; Approach</h3>
<p><code>infix</code> combines the performance model of <code>libffi</code> (one-time setup) with a much higher-level, human-readable API. The key difference is the use of a simple signature string.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="infix_8h.html">infix/infix.h</a>&gt;</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><span class="comment">// One-time setup from a simple string</span></div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, <span class="stringliteral">&quot;(double, double) -&gt; double&quot;</span>, (<span class="keywordtype">void</span>*)add_doubles, NULL);</div>
<div class="line"><a class="code hl_typedef" href="group__high__level__api.html#ga3042690c20cccd4137f134154bd62e1a">infix_cif_func</a> cif = <a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> a = 1.5, b = 2.5;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;a, &amp;b };</div>
<div class="line"><span class="keywordtype">double</span> result;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Subsequent calls are very fast</span></div>
<div class="line">cif(&amp;result, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md121"></a>
Scenario 2: Calling a Function with a Struct</h2>
<p><b>Goal</b>: Call <code><a class="el" href="structPoint.html" title="A simple struct with two doubles, often used to test pass-by-value on registers.">Point</a> move_point(Point p);</code> where <code><a class="el" href="structPoint.html" title="A simple struct with two doubles, often used to test pass-by-value on registers.">Point</a></code> is <code>{double, double}</code>. This highlights the critical differences in type systems.</p>
<h3><a class="anchor" id="autotoc_md122"></a>
The &lt;tt&gt;dyncall&lt;/tt&gt; Approach</h3>
<p><code>dyncall</code> requires manual construction of an aggregate object (<code>DCaggr</code>) to describe the struct layout. This must be done at runtime before the call.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;dyncall.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;dyncall_aggregate.h&gt;</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{ <span class="keywordtype">double</span> x, y; } <a class="code hl_struct" href="structPoint.html">Point</a>;</div>
<div class="line">DCCallVM* vm = dcNewCallVM(4096);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 1. Manually describe the struct layout for dyncall</span></div>
<div class="line">DCaggr* ag = dcNewAggr(2); <span class="comment">// 2 members</span></div>
<div class="line">dcAggrField(ag, DC_TYPE_DOUBLE, DC_ALIGNMENT_DOUBLE, 1); <span class="comment">// member x</span></div>
<div class="line">dcAggrField(ag, DC_TYPE_DOUBLE, DC_ALIGNMENT_DOUBLE, 1); <span class="comment">// member y</span></div>
<div class="line">dcCloseAggr(ag);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Prepare the struct data and call</span></div>
<div class="line"><a class="code hl_struct" href="structPoint.html">Point</a> p_in = {10.0, 20.0};</div>
<div class="line"><a class="code hl_struct" href="structPoint.html">Point</a> p_out;</div>
<div class="line">dcReset(vm);</div>
<div class="line">dcArgAggr(vm, ag, &amp;p_in);</div>
<div class="line">dcCallAggr(vm, (DCpointer)&amp;<a class="code hl_function" href="006__end__to__end__calls_8c.html#aea24499a6ed5a50c5a6e5634bf9e449a">move_point</a>, ag, &amp;p_out);</div>
<div class="line"> </div>
<div class="line">dcFreeAggr(ag);</div>
<div class="line">dcFree(vm);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md123"></a>
The &lt;tt&gt;libffi&lt;/tt&gt; Approach</h3>
<p><code>libffi</code> also requires programmatic struct definition, which is done by creating an <code>ffi_type</code> struct and an array for its elements.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ffi.h&gt;</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{ <span class="keywordtype">double</span> x, y; } <a class="code hl_struct" href="structPoint.html">Point</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 1. Manually define the struct layout for libffi</span></div>
<div class="line">ffi_type point_elements[] = { &amp;ffi_type_double, &amp;ffi_type_double, NULL };</div>
<div class="line">ffi_type point_type;</div>
<div class="line">point_type.<a class="code hl_variable" href="group__high__level__api.html#ga48077b88e083d5e6fdad889427efaca7">size</a> = 0; point_type.alignment = 0;</div>
<div class="line">point_type.type = FFI_TYPE_STRUCT;</div>
<div class="line">point_type.elements = point_elements;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Prepare the CIF using the new struct type</span></div>
<div class="line">ffi_cif cif;</div>
<div class="line">ffi_type* args_types[] = { &amp;point_type };</div>
<div class="line">ffi_prep_cif(&amp;cif, FFI_DEFAULT_ABI, 1, &amp;point_type, args_types);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Prepare args and call</span></div>
<div class="line"><a class="code hl_struct" href="structPoint.html">Point</a> p_in = {10.0, 20.0};</div>
<div class="line"><a class="code hl_struct" href="structPoint.html">Point</a> p_out;</div>
<div class="line"><span class="keywordtype">void</span>* args_values[] = { &amp;p_in };</div>
<div class="line">ffi_call(&amp;cif, FFI_FN(<a class="code hl_function" href="006__end__to__end__calls_8c.html#aea24499a6ed5a50c5a6e5634bf9e449a">move_point</a>), &amp;p_out, args_values);</div>
<div class="ttc" id="agroup__high__level__api_html_ga48077b88e083d5e6fdad889427efaca7"><div class="ttname"><a href="group__high__level__api.html#ga48077b88e083d5e6fdad889427efaca7">infix_type_t::size</a></div><div class="ttdeci">size_t size</div><div class="ttdef"><b>Definition</b> infix.h:213</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md124"></a>
The &lt;tt&gt;infix&lt;/tt&gt; Approach</h3>
<p><code>infix</code> handles the entire struct definition within the signature string, making the C code for the FFI call trivial and declarative.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="infix_8h.html">infix/infix.h</a>&gt;</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{ <span class="keywordtype">double</span> x, y; } <a class="code hl_struct" href="structPoint.html">Point</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 1. Describe the struct and function in one line.</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* signature = <span class="stringliteral">&quot;({double, double}) -&gt; {double, double}&quot;</span>;</div>
<div class="line"><a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* t = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga5362b6f6976298aebefdb2a487e72e36">infix_forward_create</a>(&amp;t, signature, (<span class="keywordtype">void</span>*)<a class="code hl_function" href="006__end__to__end__calls_8c.html#aea24499a6ed5a50c5a6e5634bf9e449a">move_point</a>, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Prepare args and call.</span></div>
<div class="line"><a class="code hl_struct" href="structPoint.html">Point</a> p_in = {10.0, 20.0};</div>
<div class="line"><a class="code hl_struct" href="structPoint.html">Point</a> p_out;</div>
<div class="line"><span class="keywordtype">void</span>* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>[] = { &amp;p_in };</div>
<div class="line"><a class="code hl_function" href="group__introspection__api.html#ga32fc7e60dd474cebc4ac082e49ac9ea8">infix_forward_get_code</a>(t)(&amp;p_out, <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__manual__api.html#gad87a8882dec00b89a4bc5c87db2fc032">infix_forward_destroy</a>(t);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md125"></a>
Scenario 3: Creating a Callback</h2>
<p><b>Goal</b>: Create a native C function pointer from a custom handler to be used by <code>qsort</code>.</p>
<h3><a class="anchor" id="autotoc_md126"></a>
The &lt;tt&gt;dyncall&lt;/tt&gt; Approach</h3>
<p><code>dyncallback</code> requires creating a <code>DCCallback</code> object and initializing it with a C function that uses a special <code>dcbArg*</code> API to retrieve arguments one by one.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;dyncall_callback.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 1. The handler uses the dyncallback API to get arguments.</span></div>
<div class="line"><span class="keywordtype">void</span> qsort_handler_dc(DCCallback* cb, DCArgs* <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>, DCValue* result, <span class="keywordtype">void</span>* userdata) {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span>* a = (<span class="keyword">const</span> <span class="keywordtype">int</span>*)dcbArgPointer(<a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span>* b = (<span class="keyword">const</span> <span class="keywordtype">int</span>*)dcbArgPointer(<a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>);</div>
<div class="line">    result-&gt;i = (*a - *b);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Create the callback object.</span></div>
<div class="line">DCCallback* cb = dcbNewCallback(<span class="stringliteral">&quot;pp)i&quot;</span>, &amp;qsort_handler_dc, NULL);</div>
<div class="line">qsort(numbers, 5, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), (<span class="keywordtype">void</span>*)cb);</div>
<div class="line">dcbFree(cb);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md127"></a>
The &lt;tt&gt;libffi&lt;/tt&gt; Approach</h3>
<p><code>libffi</code> can create a "closure" which is a block of executable memory that acts as the C function pointer. The handler receives arguments via <code>ffi_call</code>-style arrays.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ffi.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 1. The handler receives arguments in libffi&#39;s generic format.</span></div>
<div class="line"><span class="keywordtype">void</span> qsort_handler_ffi(ffi_cif* cif, <span class="keywordtype">void</span>* ret, <span class="keywordtype">void</span>** <a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>, <span class="keywordtype">void</span>* userdata) {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span>* a = *(<span class="keyword">const</span> <span class="keywordtype">int</span>**)<a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span>* b = *(<span class="keyword">const</span> <span class="keywordtype">int</span>**)<a class="code hl_variable" href="202__in__structs_8c.html#a0ad795b9f107bb50006cfa54f5671f2e">args</a>;</div>
<div class="line">    *(ffi_sarg*)ret = (*a - *b);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Prepare the CIF for the callback&#39;s signature.</span></div>
<div class="line">ffi_cif cif;</div>
<div class="line">ffi_type* args_types[] = { &amp;ffi_type_pointer, &amp;ffi_type_pointer };</div>
<div class="line">ffi_prep_cif(&amp;cif, FFI_DEFAULT_ABI, 2, &amp;ffi_type_sint, args_types);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Allocate and create the closure.</span></div>
<div class="line"><span class="keywordtype">void</span>* func_ptr = NULL;</div>
<div class="line">ffi_closure* closure = ffi_closure_alloc(<span class="keyword">sizeof</span>(ffi_closure), &amp;func_ptr);</div>
<div class="line">ffi_prep_closure_loc(closure, &amp;cif, qsort_handler_ffi, NULL, func_ptr);</div>
<div class="line">qsort(numbers, 5, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), (<span class="keywordtype">void</span>*)func_ptr);</div>
<div class="line">ffi_closure_free(closure);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md128"></a>
The &lt;tt&gt;infix&lt;/tt&gt; Approach</h3>
<p><code>infix</code> generates a reverse trampoline. The handler is a normal C function that receives its arguments directly, prefixed by the <code>infix_context_t*</code>.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="infix_8h.html">infix/infix.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 1. The handler is a standard C function with the context as the first argument.</span></div>
<div class="line"><span class="keywordtype">int</span> qsort_handler_infix(<span class="keyword">const</span> <span class="keywordtype">void</span>* a, <span class="keyword">const</span> <span class="keywordtype">void</span>* b) {</div>
<div class="line">    <span class="keywordflow">return</span> (*(<span class="keyword">const</span> <span class="keywordtype">int</span>*)a - *(<span class="keyword">const</span> <span class="keywordtype">int</span>*)b);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Create the reverse trampoline from a signature.</span></div>
<div class="line"><a class="code hl_struct" href="structinfix__reverse__t.html">infix_reverse_t</a>* context = NULL;</div>
<div class="line"><a class="code hl_function" href="group__high__level__api.html#ga010d41376c47f1100903d427776033ab">infix_reverse_create_callback</a>(&amp;context, <span class="stringliteral">&quot;(*void, *void)-&gt;int&quot;</span>, (<span class="keywordtype">void</span>*)qsort_handler_infix, NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Get the native function pointer and use it.</span></div>
<div class="line"><span class="keyword">typedef</span> int (*compare_func_t)(<span class="keyword">const</span> <span class="keywordtype">void</span>*, <span class="keyword">const</span> <span class="keywordtype">void</span>*);</div>
<div class="line">compare_func_t my_comparator = (compare_func_t)<a class="code hl_function" href="group__introspection__api.html#ga3b75e8481ac13d11faa15046fc4adb66">infix_reverse_get_code</a>(context);</div>
<div class="line">qsort(numbers, 5, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), my_comparator);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__manual__api.html#ga00b101025663c423a28433e139be5d4e">infix_reverse_destroy</a>(context);</div>
<div class="ttc" id="agroup__manual__api_html_ga00b101025663c423a28433e139be5d4e"><div class="ttname"><a href="group__manual__api.html#ga00b101025663c423a28433e139be5d4e">infix_reverse_destroy</a></div><div class="ttdeci">void infix_reverse_destroy(infix_reverse_t *)</div><div class="ttdoc">Destroys a reverse trampoline and frees all associated memory.</div><div class="ttdef"><b>Definition</b> trampoline.c:786</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md129"></a>
Analysis and Takeaways</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Aspect   </th><th class="markdownTableHeadLeft"><code>dyncall</code>   </th><th class="markdownTableHeadLeft"><code>libffi</code>   </th><th class="markdownTableHeadLeft"><code>infix</code>    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>Readability</b>   </td><td class="markdownTableBodyLeft">Low (single-character signatures)   </td><td class="markdownTableBodyLeft">Medium (C code is clear, but type setup is verbose)   </td><td class="markdownTableBodyLeft"><b>High</b> (Human-readable, self-contained signature strings)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>Performance Model</b>   </td><td class="markdownTableBodyLeft">Setup cost on <b>every call</b>   </td><td class="markdownTableBodyLeft"><b>One-time setup</b> (<code>ffi_prep_cif</code>)   </td><td class="markdownTableBodyLeft"><b>One-time setup</b> (JIT compilation)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>Type System</b>   </td><td class="markdownTableBodyLeft">Programmatic, with struct support   </td><td class="markdownTableBodyLeft">Manual, programmatic <code>ffi_type</code> creation   </td><td class="markdownTableBodyLeft"><b>Integrated</b>. Types are part of the signature string, with registry support.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><b>Ease of Use</b>   </td><td class="markdownTableBodyLeft">Simple for primitives, complex for structs   </td><td class="markdownTableBodyLeft">Complex, powerful, requires deep knowledge of the API   </td><td class="markdownTableBodyLeft"><b>Simple and Declarative</b>, designed for a high-level experience.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><b>Callback Handler</b>   </td><td class="markdownTableBodyLeft">Special API (<code>dcbArg*</code>)   </td><td class="markdownTableBodyLeft">Generic <code>void**</code> arguments   </td><td class="markdownTableBodyLeft"><b>Native C arguments</b> (callback) or **Generic <code>void**</code> (closure).   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md131"></a>
Chapter 11: Building Language Bindings</h1>
<h2><a class="anchor" id="autotoc_md132"></a>
The Four Pillars of a Language Binding</h2>
<p>A robust language binding built on <code>infix</code> must solve four main challenges:</p>
<ol type="1">
<li><b>Type Mapping &amp; Signature Generation:</b> The binding's primary job is to translate the host language's type representation (e.g., Python's <code>ctypes.c_int</code>) into an <code>infix</code> signature string.</li>
<li><b>Trampoline Caching:</b> The binding <b>must</b> implement a global, persistent cache for trampolines, using the signature string as the key, to amortize the one-time JIT compilation cost.</li>
<li><b>Memory &amp; Lifetime Management:</b> The binding must act as a bridge between the host language's Garbage Collector (GC) and C's manual memory management, holding references to objects to prevent premature collection.</li>
<li><b>The Callback Bridge:</b> A C handler must be implemented to transfer control from a native C call back into the host language's runtime, handling argument unmarshalling and potential GIL (Global Interpreter Lock) acquisition. This should use the <code>infix_reverse_create_closure</code> API.</li>
</ol>
<h2><a class="anchor" id="autotoc_md133"></a>
Recipe: Porting a Python Binding from &lt;tt&gt;dyncall&lt;/tt&gt; to &lt;tt&gt;infix&lt;/tt&gt;</h2>
<p>This recipe demonstrates how one might port a Python binding from a library like <code>dyncall</code> to <code>infix</code>.</p>
<p><b>The <code>dyncall</code> approach</b> involves a "call virtual machine" (<code>DCCallVM*</code>) that arguments are pushed to one-by-one at call time. This is flexible but incurs overhead on every call.</p>
<p><b>The <code>infix</code> approach</b> shifts the expensive work (parsing and code generation) to a one-time setup phase, making subsequent calls much faster. The core logic of the binding becomes centered around a trampoline cache.</p>
<div class="fragment"><div class="line"><span class="comment">// Conceptual port to infix for a Python module</span></div>
<div class="line"><span class="preprocessor">#include &lt;Python.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="infix_8h.html">infix/infix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;alloca.h&gt;</span> <span class="comment">// For alloca</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// A global Python dictionary to cache trampolines: { signature_str: PyCapsule(trampoline) }</span></div>
<div class="line"><span class="keyword">static</span> PyObject* g_trampoline_cache = NULL;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> PyObject* infix_python_call(PyObject* self, PyObject* py_args) {</div>
<div class="line">    PyObject* target_func_capsule = NULL;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* signature = NULL;</div>
<div class="line">    PyObject* py_func_args = NULL;</div>
<div class="line">    <span class="keywordflow">if</span> (!PyArg_ParseTuple(py_args, <span class="stringliteral">&quot;OsO!&quot;</span>, &amp;target_func_capsule, &amp;signature, &amp;PyTuple_Type, &amp;py_func_args)) <span class="keywordflow">return</span> NULL;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span>* target_func = PyCapsule_GetPointer(target_func_capsule, NULL);</div>
<div class="line">    <span class="keywordflow">if</span>(!target_func) <span class="keywordflow">return</span> NULL;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (g_trampoline_cache == NULL) g_trampoline_cache = PyDict_New();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 1. Trampoline Caching</span></div>
<div class="line">    PyObject* signature_py = PyUnicode_FromString(signature);</div>
<div class="line">    PyObject* capsule = PyDict_GetItem(g_trampoline_cache, signature_py);</div>
<div class="line">    <a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>* trampoline = NULL;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (capsule)</div>
<div class="line">        trampoline = (<a class="code hl_struct" href="structinfix__forward__t.html">infix_forward_t</a>*)PyCapsule_GetPointer(capsule, <span class="stringliteral">&quot;infix_trampoline&quot;</span>);</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// Not in cache: create, then store in cache via a PyCapsule.</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code hl_function" href="group__high__level__api.html#ga524a8ccebd24c9232d30cb2f79aee5a5">infix_forward_create_unbound</a>(&amp;trampoline, signature, NULL) != <a class="code hl_enumvalue" href="group__high__level__api.html#gga8643667be6ea1ef9269c2e46d8f11ff7ae50c34a24362f9364b4b20ef29d259da">INFIX_SUCCESS</a>) {</div>
<div class="line">            PyErr_SetString(PyExc_RuntimeError, <span class="stringliteral">&quot;Failed to create infix trampoline.&quot;</span>);</div>
<div class="line">            Py_DECREF(signature_py);</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line">        capsule = PyCapsule_New(trampoline, <span class="stringliteral">&quot;infix_trampoline&quot;</span>, (PyCapsule_Destructor)<a class="code hl_function" href="group__manual__api.html#gad87a8882dec00b89a4bc5c87db2fc032">infix_forward_destroy</a>);</div>
<div class="line">        PyDict_SetItem(g_trampoline_cache, signature_py, capsule);</div>
<div class="line">        Py_DECREF(capsule);</div>
<div class="line">    }</div>
<div class="line">    Py_DECREF(signature_py);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. Argument Marshalling (simplified)</span></div>
<div class="line">    <span class="keywordtype">size_t</span> num_args = PyTuple_GET_SIZE(py_func_args);</div>
<div class="line">    <span class="keywordtype">void</span>** c_args = (<span class="keywordtype">void</span>**)alloca(<span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*) * num_args);</div>
<div class="line">    <span class="comment">// In a real binding, this storage would need to be managed more robustly.</span></div>
<div class="line">    <span class="comment">// Using an infix_arena_t here is the recommended production approach.</span></div>
<div class="line">    <span class="keywordtype">void</span>* storage = alloca(1024);</div>
<div class="line">    <span class="keywordtype">char</span>* storage_ptr = (<span class="keywordtype">char</span>*)storage;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; num_args; ++i) {</div>
<div class="line">        PyObject* py_arg = PyTuple_GET_ITEM(py_func_args, i);</div>
<div class="line">        <span class="keywordflow">if</span> (PyLong_Check(py_arg)) {</div>
<div class="line">            <span class="keywordtype">long</span>* val = (<span class="keywordtype">long</span>*)storage_ptr; *val = PyLong_AsLong(py_arg);</div>
<div class="line">            c_args[i] = val; storage_ptr += <span class="keyword">sizeof</span>(long);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PyFloat_Check(py_arg)) {</div>
<div class="line">            <span class="keywordtype">double</span>* val = (<span class="keywordtype">double</span>*)storage_ptr; *val = PyFloat_AsDouble(py_arg);</div>
<div class="line">            c_args[i] = val; storage_ptr += <span class="keyword">sizeof</span>(double);</div>
<div class="line">        } <span class="comment">// ... etc.</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 3. The FFI Call</span></div>
<div class="line">    <a class="code hl_typedef" href="group__high__level__api.html#ga48f7ee868576f525269902fc953887bd">infix_unbound_cif_func</a> cif = <a class="code hl_function" href="group__introspection__api.html#ga5f3559908e6a7bcc72103c52937d67ad">infix_forward_get_unbound_code</a>(trampoline);</div>
<div class="line">    <span class="comment">// A real binding would inspect the signature to handle the return value.</span></div>
<div class="line">    cif(target_func, NULL, c_args);</div>
<div class="line"> </div>
<div class="line">    Py_RETURN_NONE;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
